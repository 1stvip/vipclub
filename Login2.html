<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="images//videoslogo/vip.png">
    <title>Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</title>
    <!-- Ø¥Ø¶Ø§ÙØ© Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root { --primary: #6366f1; --secondary: #a855f7; --bg: #f8fafc; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 100%); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
        }
        .card { 
            background: white; 
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
            width: 100%; 
            max-width: 400px; 
        }
        h2 { text-align: center; color: var(--primary); margin-bottom: 20px; }
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85em; }
        input, select { 
            width: 100%; 
            padding: 10px; 
            border: 2px solid #e2e8f0; 
            border-radius: 8px; 
            box-sizing: border-box; 
            transition: 0.3s; 
        }
        input:focus { border-color: var(--primary); outline: none; }
        button { 
            width: 100%; 
            padding: 12px; 
            background: linear-gradient(to right, var(--primary), var(--secondary)); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 15px; 
        }
        .switch-btn { text-align: center; margin-top: 15px; font-size: 0.9em; color: #64748b; }
        .switch-link { color: var(--primary); cursor: pointer; text-decoration: underline; font-weight: bold; }
        .hidden { display: none; }
        .message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
        }
        .success { background: #d1fae5; color: #065f46; }
        .error { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

<div class="card" id="formCard">
    <div id="registerSection">
        <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
        <div id="messageDiv"></div>
        <form id="regForm">
            <div class="form-group"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input type="text" id="regUser" required></div>
            <div class="form-group"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" id="regPass" required></div>
            <div class="form-group"><label>Ø§Ù„Ø¨Ø±ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input type="email" id="regEmail"></div>
            <div class="form-group"><label>Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input type="tel" id="regPhone"></div>
            <div class="form-group">
                <label>Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ</label>
                <select id="regQuestion">
                    <option value="ØµØ¯ÙŠÙ‚ Ø§Ù„Ø·ÙÙˆÙ„Ø©">Ø§Ø³Ù… ØµØ¯ÙŠÙ‚ Ø§Ù„Ø·ÙÙˆÙ„Ø©</option>
                    <option value="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±">Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±</option>
                    <option value="Ø§Ù„Ù…Ø¯Ø±Ø³Ø©">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</option>
                </select>
                <input type="text" id="regAnswer" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©" required style="margin-top:8px;">
            </div>
            <button type="submit">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
        </form>
        <div class="switch-btn">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <span class="switch-link" onclick="toggleForm()">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù‡Ù†Ø§</span></div>
    </div>

    <div id="loginSection" class="hidden">
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <div id="loginMessage"></div>
        <form id="loginForm">
            <div class="form-group"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input type="text" id="loginUser" required></div>
            <div class="form-group"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" id="loginPass" required></div>
            <button type="submit" style="background: #10b981;">Ø¯Ø®ÙˆÙ„</button>
        </form>
        <div class="switch-btn">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <span class="switch-link" onclick="toggleForm()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</span></div>
    </div>
</div>

<script>
// ğŸ”¥ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase - Ù†ÙØ³ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
const firebaseConfig = {
    apiKey: "AIzaSyAVSzkDLqi1G-hpfEPqvBMmuyYRfEuaTKk",
    authDomain: "vipclub-1d04a.firebaseapp.com",
    databaseURL: "https://vipclub-1d04a-default-rtdb.firebaseio.com",
    projectId: "vipclub-1d04a",
    storageBucket: "vipclub-1d04a.firebasestorage.app",
    messagingSenderId: "120667552740",
    appId: "1:120667552740:web:02085765fd43eb0080e5f1"
};

// ØªÙ‡ÙŠØ¦Ø© Firebase
let database;
try {
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    database = firebase.database();
    console.log('âœ… Firebase Ù…ØªØµÙ„ Ø¨Ù†Ø¬Ø§Ø­');
} catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:', error);
    showMessage('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
}

function toggleForm() {
    document.getElementById('registerSection').classList.toggle('hidden');
    document.getElementById('loginSection').classList.toggle('hidden');
    clearMessages();
}

function showMessage(text, type, elementId = 'messageDiv') {
    const div = document.getElementById(elementId);
    div.innerHTML = `<div class="message ${type}">${text}</div>`;
    setTimeout(() => div.innerHTML = '', 5000);
}

function clearMessages() {
    document.getElementById('messageDiv').innerHTML = '';
    document.getElementById('loginMessage').innerHTML = '';
}

// ===== Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ ID Ø±Ù‚Ù…ÙŠ (Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø©) =====
function generateNumericId() {
    // Ø¥Ù†Ø´Ø§Ø¡ ID Ù…ÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù…
    return Math.floor(100000 + Math.random() * 900000);
}

// ===== Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø°ÙˆÙ =====
async function checkDeletedUser(username, numericId = null) {
    if (!database) return false;
    
    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø°ÙˆÙÙŠÙ†
        const snapshot = await database.ref('deleted_users').orderByChild('username').equalTo(username).once('value');
        
        if (snapshot.exists()) {
            // Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø°ÙˆÙ Ù…Ù† Ù‚Ø¨Ù„
            return true;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… numericId Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        if (numericId) {
            const idSnapshot = await database.ref('deleted_users').orderByChild('numericId').equalTo(numericId).once('value');
            if (idSnapshot.exists()) {
                return true;
            }
        }
        
        return false;
    } catch (error) {
        console.error('Error checking deleted user:', error);
        return false;
    }
}

// 1. Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Firebase (Ù…Ø­Ø³Ù‘Ù† ÙˆÙ…ØªÙˆØ§ÙÙ‚)
document.getElementById('regForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!database) {
        showMessage('âŒ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØµÙ„Ø©', 'error');
        return;
    }
    
    const username = document.getElementById('regUser').value.trim();
    const password = document.getElementById('regPass').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const phone = document.getElementById('regPhone').value.trim();
    const question = document.getElementById('regQuestion').value;
    const answer = document.getElementById('regAnswer').value.trim();
    
    if (!username || !password) {
        showMessage('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'error');
        return;
    }
    
    try {
        // ===== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø°ÙˆÙ =====
        const isDeleted = await checkDeletedUser(username);
        if (isDeleted) {
            showMessage('âŒ ØªÙ… Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø­Ø¸Ø±Ù‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹ âŒ', 'error');
            return;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†
        const snapshot = await database.ref('users').orderByChild('username').equalTo(username).once('value');
        
        if (snapshot.exists()) {
            showMessage('âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„', 'error');
            return;
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù Ø±Ù‚Ù…ÙŠ ÙØ±ÙŠØ¯
        let numericId;
        let isUnique = false;
        let attempts = 0;
        
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù€ ID ÙØ±ÙŠØ¯
        while (!isUnique && attempts < 10) {
            numericId = generateNumericId();
            const idCheck = await database.ref('users').orderByChild('numericId').equalTo(numericId).once('value');
            const deletedCheck = await database.ref('deleted_users').orderByChild('numericId').equalTo(numericId).once('value');
            
            if (!idCheck.exists() && !deletedCheck.exists()) {
                isUnique = true;
            }
            attempts++;
        }
        
        if (!isUnique) {
            showMessage('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
            return;
        }
        
        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ - Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        const newUser = {
            numericId: numericId,
            username: username,
            password: password,
            nickname: username,
            email: email || '',
            email2: '',
            phone: phone || '',
            phone2: '',
            gender: '',
            age: '',
            country: '',
            bio: '',
            question: question,
            answer: answer,
            balanceEGP: 0.00,
            balanceUSD: 0.00,
            isBanned: false,
            banReason: "",
            banExpiry: "",
            notifications: [],
            lastNicknameChange: 0,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        // Ø­ÙØ¸ ÙÙŠ Firebase
        const newUserRef = database.ref('users').push();
        await newUserRef.set(newUser);
        
        const userId = newUserRef.key;
        
        showMessage(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!<br>Ù…Ø¹Ø±ÙÙƒ: <b>${numericId}</b>`, 'success');
        
        // ===== Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ localStorage Ø¨Ø´ÙƒÙ„ Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª =====
        localStorage.setItem('currentUser', JSON.stringify({
            id: numericId, // ğŸ”´ Ù…Ù‡Ù…: Ù†Ø³ØªØ®Ø¯Ù… numericId Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† userId
            numericId: numericId,
            username: username,
            nickname: username,
            email: email || '',
            phone: phone || '',
            firebaseKey: userId,
            balanceEGP: 0.00,
            balanceUSD: 0.00,
            isBanned: false,
            createdAt: new Date().toISOString()
        }));
        
        // ===== Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø°ÙˆÙÙŠÙ† Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ =====
        const deletedSnapshot = await database.ref('deleted_users').orderByChild('username').equalTo(username).once('value');
        if (deletedSnapshot.exists()) {
            deletedSnapshot.forEach(async (childSnapshot) => {
                await database.ref('deleted_users/' + childSnapshot.key).remove();
            });
        }
        
        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ø¹Ø¯ 2 Ø«Ø§Ù†ÙŠØ©
        setTimeout(() => {
            window.location.href = 'MarketPlace.html';
        }, 2000);
        
    } catch (error) {
        showMessage('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ' + error.message, 'error');
        console.error('Registration error:', error);
    }
});

// 2. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Firebase (Ù…Ø­Ø³Ù‘Ù† ÙˆÙ…ØªÙˆØ§ÙÙ‚)
document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!database) {
        showMessage('âŒ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØµÙ„Ø©', 'error', 'loginMessage');
        return;
    }
    
    const username = document.getElementById('loginUser').value.trim();
    const password = document.getElementById('loginPass').value.trim();
    
    if (!username || !password) {
        showMessage('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„', 'error', 'loginMessage');
        return;
    }
    
    try {
        // ===== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ Ù…Ø­Ø°ÙˆÙØ§Ù‹ =====
        const isDeleted = await checkDeletedUser(username);
        if (isDeleted) {
            showMessage('âŒ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ ØªÙ… Ø­Ø°ÙÙ‡ Ø£Ùˆ Ø­Ø¸Ø±Ù‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ âŒ', 'error', 'loginMessage');
            return;
        }
        
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase
        const snapshot = await database.ref('users').orderByChild('username').equalTo(username).once('value');
        
        if (!snapshot.exists()) {
            showMessage('âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ØµØ­ÙŠØ­', 'error', 'loginMessage');
            return;
        }
        
        let foundUser = null;
        let userId = null;
        
        snapshot.forEach((childSnapshot) => {
            const user = childSnapshot.val();
            if (user.password === password) {
                foundUser = user;
                userId = childSnapshot.key;
            }
        });
        
        if (!foundUser) {
            showMessage('âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error', 'loginMessage');
            return;
        }
        
        // ÙØ­Øµ Ø§Ù„Ø­Ø¸Ø±
        if (foundUser.isBanned) {
            let message = `ğŸš« Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø­Ø¸ÙˆØ±!\nØ§Ù„Ø³Ø¨Ø¨: ${foundUser.banReason || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
            
            if (foundUser.banExpiry && foundUser.banExpiry !== "permanent") {
                const expiry = new Date(foundUser.banExpiry);
                const now = new Date();
                
                if (expiry > now) {
                    const diff = expiry - now;
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    message += `\nÙŠÙ†ØªÙ‡ÙŠ Ø¨Ø¹Ø¯: ${days} ÙŠÙˆÙ… Ùˆ ${hours} Ø³Ø§Ø¹Ø©`;
                    
                    alert(message);
                    return;
                } else {
                    // ÙÙƒ Ø§Ù„Ø­Ø¸Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø£Ù† Ø§Ù„Ù…Ø¯Ø© Ø§Ù†ØªÙ‡Øª
                    await database.ref('users/' + userId).update({
                        isBanned: false,
                        banExpiry: "",
                        banReason: "",
                        updatedAt: new Date().toISOString()
                    });
                    foundUser.isBanned = false;
                }
            } else if (foundUser.banExpiry === "permanent") {
                message += "\nØ§Ù„Ø­Ø¸Ø± Ø¯Ø§Ø¦Ù…!";
                alert(message);
                return;
            }
        }
        
        // ===== Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ localStorage Ø¨Ø´ÙƒÙ„ Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª =====
        localStorage.setItem('currentUser', JSON.stringify({
            id: foundUser.numericId, // ğŸ”´ Ù…Ù‡Ù…: Ù†Ø³ØªØ®Ø¯Ù… numericId Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† userId
            numericId: foundUser.numericId,
            username: foundUser.username,
            nickname: foundUser.nickname || foundUser.username,
            email: foundUser.email || '',
            phone: foundUser.phone || '',
            firebaseKey: userId,
            balanceEGP: foundUser.balanceEGP || 0.00,
            balanceUSD: foundUser.balanceUSD || 0.00,
            isBanned: foundUser.isBanned || false,
            createdAt: foundUser.createdAt || new Date().toISOString()
        }));
        
        showMessage('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success', 'loginMessage');
        
        // ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        setTimeout(() => {
            window.location.href = 'MarketPlace.html';
        }, 1500);
        
    } catch (error) {
        showMessage('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + error.message, 'error', 'loginMessage');
        console.error('Login error:', error);
    }
});

// ===== Ø¯Ø§Ù„Ø© Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…Ø­Ø³Ù†Ø© Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±) =====
async function syncWithLocalStorage() {
    try {
        if (!database) return;
        
        const localUsers = JSON.parse(localStorage.getItem('app_users')) || [];
        
        if (localUsers.length === 0) return;
        
        console.log(`ğŸ“¦ Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© ${localUsers.length} Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† localStorage`);
        
        let syncedCount = 0;
        let skippedCount = 0;
        
        for (const user of localUsers) {
            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø°ÙˆÙØ§Ù‹
                if (await checkDeletedUser(user.username, user.numericId)) {
                    console.log(`â­ï¸ ØªØ®Ø·ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø°ÙˆÙ: ${user.username}`);
                    skippedCount++;
                    continue;
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Firebase
                const snapshot = await database.ref('users').orderByChild('username').equalTo(user.username).once('value');
                
                if (snapshot.exists()) {
                    console.log(`âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„: ${user.username}`);
                    skippedCount++;
                    continue;
                }
                
                // Ø¥Ù†Ø´Ø§Ø¡ ID Ø±Ù‚Ù…ÙŠ Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                let numericId = user.numericId;
                if (!numericId || numericId.toString().length < 6) {
                    numericId = generateNumericId();
                }
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù€ ID ÙØ±ÙŠØ¯
                const idCheck = await database.ref('users').orderByChild('numericId').equalTo(numericId).once('value');
                if (idCheck.exists()) {
                    numericId = generateNumericId(); // Ø¥Ù†Ø´Ø§Ø¡ ID Ø¬Ø¯ÙŠØ¯
                }
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Firebase
                const newUserRef = database.ref('users').push();
                await newUserRef.set({
                    numericId: numericId,
                    username: user.username || `user_${Date.now()}`,
                    password: user.password || '123456',
                    nickname: user.nickname || user.username,
                    email: user.email || '',
                    email2: '',
                    phone: user.phone || '',
                    phone2: '',
                    gender: '',
                    age: '',
                    country: '',
                    bio: '',
                    question: user.question || 'Ø§Ù„Ù…Ø¯Ø±Ø³Ø©',
                    answer: user.answer || '',
                    balanceEGP: parseFloat(user.balanceEGP) || 0.00,
                    balanceUSD: parseFloat(user.balanceUSD) || 0.00,
                    isBanned: user.isBanned === true,
                    banReason: user.banReason || '',
                    banExpiry: user.banExpiry || '',
                    notifications: user.notifications || [],
                    lastNicknameChange: user.lastNicknameChange || 0,
                    createdAt: user.createdAt || new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
                
                console.log(`âœ… ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø©: ${user.username} (ID: ${numericId})`);
                syncedCount++;
                
                // Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† localStorage Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù†Ø§Ø¬Ø­Ø©
                localUsers.splice(localUsers.indexOf(user), 1);
                
            } catch (error) {
                console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© ${user.username}:`, error);
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« localStorage Ø¨Ø¯ÙˆÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†ØªÙ‡Ù…
        localStorage.setItem('app_users', JSON.stringify(localUsers));
        
        if (syncedCount > 0) {
            console.log(`ğŸ‰ ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© ${syncedCount} Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­ (ØªÙ… ØªØ®Ø·ÙŠ ${skippedCount})`);
        }
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
    }
}

// ===== Ø¯Ø§Ù„Ø© ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ÙƒØ±Ø±ÙŠÙ† Ù…Ù† Firebase =====
async function cleanDuplicateUsers() {
    if (!database) return;
    
    try {
        const snapshot = await database.ref('users').once('value');
        
        if (!snapshot.exists()) return;
        
        const users = snapshot.val();
        const usernames = new Set();
        const duplicates = [];
        
        // Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ÙƒØ±Ø±ÙŠÙ†
        for (const userId in users) {
            const user = users[userId];
            const username = user.username;
            
            if (usernames.has(username)) {
                duplicates.push({ userId, username });
            } else {
                usernames.add(username);
            }
        }
        
        // Ø­Ø°Ù Ø§Ù„Ù…ÙƒØ±Ø±Ø§Øª (Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø£ÙˆÙ„ Ø¸Ù‡ÙˆØ±)
        for (const dup of duplicates) {
            console.log(`ğŸ—‘ï¸ Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙƒØ±Ø±: ${dup.username} (${dup.userId})`);
            await database.ref('users/' + dup.userId).remove();
        }
        
        if (duplicates.length > 0) {
            console.log(`âœ… ØªÙ… Ø­Ø°Ù ${duplicates.length} Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙƒØ±Ø±`);
        }
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ÙƒØ±Ø±ÙŠÙ†:', error);
    }
}

// ===== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© =====
window.onload = async function() {
    try {
        if (database) {
            console.log('ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©...');
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ÙƒØ±Ø±ÙŠÙ† (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
            await cleanDuplicateUsers();
            
            // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage
            await syncWithLocalStorage();
            
            // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
            loadSyncStats();
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©:', error);
    }
};

// ===== ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© =====
function loadSyncStats() {
    try {
        const syncStats = JSON.parse(localStorage.getItem('sync_stats')) || { lastSync: null, syncedCount: 0 };
        
        if (syncStats.lastSync) {
            const lastSyncDate = new Date(syncStats.lastSync);
            const now = new Date();
            const diffHours = Math.floor((now - lastSyncDate) / (1000 * 60 * 60));
            
            if (diffHours > 24) {
                console.log('ğŸ”„ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© (Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø© Ù‚Ø¨Ù„ Ø£ÙƒØ«Ø± Ù…Ù† 24 Ø³Ø§Ø¹Ø©)');
            }
        }
    } catch (error) {
        console.error('Error loading sync stats:', error);
    }
}

// ===== Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ =====
document.addEventListener('keydown', function(e) {
    // Ctrl+Shift+L Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³Ø¤ÙˆÙ„ (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±)
    if (e.ctrlKey && e.shiftKey && e.key === 'L') {
        e.preventDefault();
        document.getElementById('loginUser').value = 'admin';
        document.getElementById('loginPass').value = 'admin123';
        document.getElementById('loginForm').dispatchEvent(new Event('submit'));
    }
    
    // Ctrl+Shift+R Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØªØ³Ø¬ÙŠÙ„
    if (e.ctrlKey && e.shiftKey && e.key === 'R') {
        e.preventDefault();
        if (document.getElementById('registerSection').classList.contains('hidden')) {
            toggleForm();
        }
    }
});

// ===== Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ =====
setInterval(() => {
    if (!database) {
        console.warn('âš ï¸ ÙÙ‚Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        showMessage('âš ï¸ ÙÙ‚Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©', 'error');
    }
}, 30000);
</script>
</body>
</html>