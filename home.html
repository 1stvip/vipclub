<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="images//videoslogo/vip.png">
    <title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - VipClub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root { 
            --primary: #6366f1; 
            --success: #10b981;
            --danger: #ef4444; 
            --dark: #1e293b; 
            --bg: #f1f5f9; 
            --footer-bg: #ffffff;
        }
        
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; min-height: 100vh; }
        .main-content { flex: 1; padding-bottom: 50px; }

        .navbar { background: #fff; height: 65px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 9999; }
        .logo-profile-section { display: flex; align-items: center; gap: 15px; }
        .logo { font-weight: bold; font-size: 1.2rem; color: var(--dark); margin-left: 5px; }

        .icon-btn { font-size: 1.5rem; color: var(--dark); cursor: pointer; position: relative; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: 0.2s; text-decoration: none; }
        .icon-btn:hover { background: #f0f0f0; }
        .badge { position: absolute; top: 2px; right: 2px; background: var(--danger); color: white; font-size: 0.65rem; padding: 2px 5px; border-radius: 50%; }

        .cards-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .product-card { background: white; border-radius: 20px; padding: 25px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.05); transition: 0.3s; border: 1px solid #eee; }
        .product-card:hover { transform: translateY(-10px); }
        .product-card i { font-size: 3rem; color: #f3ba2f; margin-bottom: 15px; }
        .product-card h3 { margin: 10px 0; color: var(--dark); }
        .price-tag { font-size: 1.2rem; font-weight: bold; color: var(--primary); margin: 10px 0; }

        .dropdown-overlay { position: fixed; top: 70px; width: 320px; max-width: 90%; background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); display: none; flex-direction: column; z-index: 10000; border: 1px solid #ddd; overflow: hidden; }
        #profileDropdown { right: 20px; left: auto; padding: 20px; text-align: center; }
        #notifDropdown { left: 20px; right: auto; background: #1a1a1a; color: white; border: 1px solid #333; }

        .dropdown-overlay.active { display: flex !important; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        #purchaseModal, #topUpModal, #currencyModal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 380px; max-width: 90%; z-index: 10001; padding: 25px; display: none; flex-direction: column; background: white; border-radius: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }

        .modal-active { display: flex !important; animation: popIn 0.2s ease-out; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9) translate(-50%, -50%); } to { opacity: 1; transform: scale(1) translate(-50%, -50%); } }

        .notif-header { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .refresh-btn { cursor: pointer; font-size: 1rem; color: #aaa; transition: 0.3s; margin-right: auto; margin-left: 10px; padding: 5px; }
        .refresh-btn:hover { color: var(--primary); transform: rotate(180deg); }
        .refreshing { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #notifList { max-height: 350px; overflow-y: auto; }
        .notif-item { padding: 12px 15px; border-bottom: 1px solid #2a2a2a; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; gap: 10px; position: relative; text-align: right; }
        .notif-item.unread { background: #252525; border-right: 4px solid var(--primary); }
        .delete-single-notif { color: #666; cursor: pointer; transition: 0.2s; padding: 5px; }
        .delete-single-notif:hover { color: var(--danger); }

        .balance-card { background: #f8fafc; padding: 12px; border-radius: 10px; margin: 15px 0; border: 1px solid #e2e8f0; }
        .balance-row { display: flex; justify-content: space-between; font-weight: bold; margin: 5px 0; font-size: 0.9rem; color: var(--dark); }
        .action-btn { width: 100%; padding: 12px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-logout { background: #fee2e2; color: var(--danger); }
        
        .copy-box { background: #f1f5f9; padding: 10px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; margin: 10px 0; border: 1px dashed var(--primary); }
        .copy-btn { background: var(--primary); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; }
        
        .modern-footer { background: var(--footer-bg); padding: 30px 20px; text-align: center; border-top: 1px solid #e2e8f0; margin-top: 40px; }
        .footer-socials { display: flex; justify-content: center; gap: 15px; margin-top: 15px; }
        .social-link { text-decoration: none; font-size: 1.3rem; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 12px; }
        .youtube { color: #ff0000; background: #ffebeb; }
        .facebook { color: #1877f2; background: #e7f3ff; }
        .whatsapp { color: #25d366; background: #e8faef; }
        .discord  { color: #5865f2 !important; background: #eeefff !important; }
        
        #screenOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9998; display: none; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); }
        
        select, input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-top: 5px; box-sizing: border-box; font-family: inherit; }
        .payment-info-box { background: #fffbeb; border: 1px solid #fef3c7; padding: 10px; border-radius: 10px; margin: 10px 0; display: none; }
        .calculation-box { background: #e0e7ff; padding: 10px; border-radius: 8px; margin-top: 10px; border: 1px solid #c7d2fe; display: none; }

        /* Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¹Ø±Ø¶ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© */
        #selectedPaymentInfo { background: #e0f2fe; padding: 12px; border-radius: 10px; margin-bottom: 15px; display: none; text-align: center; border: 1px solid #bae6fd; }
        #selectedPaymentInfo strong { color: var(--primary); }

        .floating-support {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.4);
            cursor: pointer;
            z-index: 999;
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-decoration: none;
        }
        .floating-support:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.6);
            color: #fff;
        }
        .support-tooltip {
            position: absolute;
            right: 75px;
            background: var(--dark);
            color: white;
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 0.85rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
            transform: translateX(10px);
        }
        .floating-support:hover .support-tooltip {
            opacity: 1;
            transform: translateX(0);
        }
        .pulse-dot {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            background: #ff4757;
            border: 2px solid white;
            border-radius: 50%;
            animation: pulse-ring 2s infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }

        .hidden-guest { display: none !important; }
        
        /* Ø±Ø³Ø§Ø¦Ù„ Firebase */
        .firebase-alert {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 8px;
            z-index: 10002;
            animation: slideInRight 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 400px;
        }
        
        .firebase-success {
            background: #10b981;
            color: white;
            border-left: 4px solid #059669;
        }
        
        .firebase-error {
            background: #ef4444;
            color: white;
            border-left: 4px solid #dc2626;
        }
        
        .firebase-warning {
            background: #f59e0b;
            color: white;
            border-left: 4px solid #d97706;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù€ ID Ø§Ù„Ø±Ù‚Ù…ÙŠ */
        .user-id-numeric {
            background: linear-gradient(90deg, #4f46e5, #8b5cf6);
            color: white;
            padding: 8px 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            font-weight: bold;
            letter-spacing: 2px;
            text-align: center;
            margin: 10px auto;
            display: inline-block;
            min-width: 120px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 2px solid white;
        }
        
        .id-label {
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 5px;
            display: block;
        }
        
        /* Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ */
        .desktop-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 15px;
            z-index: 10003;
            display: none;
            max-width: 350px;
            border-left: 5px solid var(--primary);
            animation: slideInRight 0.3s ease;
        }
        
        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            flex-shrink: 0;
        }
        
        .notification-success .notification-icon {
            background: #d1fae5;
            color: #059669;
        }
        
        .notification-error .notification-icon {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .notification-warning .notification-icon {
            background: #fef3c7;
            color: #d97706;
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯ Ù„Ù„ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        .code-in-notification {
            background: linear-gradient(45deg, #4f46e5, #8b5cf6);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 0.9rem;
            letter-spacing: 1px;
            margin: 5px 0;
            display: inline-block;
            direction: ltr;
            text-align: center;
            word-break: break-all;
            border: 2px solid #c7d2fe;
        }
    </style>
</head>
<body>

<div id="screenOverlay" onclick="closeAll()"></div>

<!-- Ø¥Ø´Ø¹Ø§Ø± Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ -->
<div id="desktopNotification" class="desktop-notification" style="display: none;">
    <div style="display: flex; align-items: center;">
        <div class="notification-icon">
            <i class="fas fa-bell"></i>
        </div>
        <div style="flex: 1;">
            <div style="font-weight: bold; margin-bottom: 5px;" id="notificationTitle">Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯</div>
            <div style="font-size: 0.9rem;" id="notificationMessage"></div>
        </div>
        <button onclick="closeDesktopNotification()" style="background: none; border: none; color: #999; cursor: pointer; font-size: 1.2rem;">Ã—</button>
    </div>
</div>

<div onclick="handleSupportClick()" class="floating-support" title="Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ">
    <i class="fas fa-headset"></i>
    <span class="pulse-dot"></span>
    <div class="support-tooltip">ØªØ­Ø¯Ø« Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</div>
</div>

<!-- Ø±Ø³Ø§Ø¦Ù„ Firebase -->
<div id="firebaseAlert" class="firebase-alert" style="display: none;"></div>

<div class="main-content">
    <nav class="navbar">
        <div class="logo-profile-section">
            <div class="logo">ğŸ‘‘ VipClub ğŸ‘‘</div>
            <div class="icon-btn" onclick="handleProfileClick()" title="Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ">
                <i class="fas fa-user-circle"></i>
            </div>
            <a href="Wallet.html" class="icon-btn auth-only hidden-guest" title="Ø§Ù„Ù…Ø­ÙØ¸Ø©" onclick="prepareForWallet()">
                <i class="fas fa-wallet"></i>
            </a>
            <a href="settings.html" class="icon-btn auth-only hidden-guest" title="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">
                <i class="fas fa-cog"></i>
            </a>
        </div>
        <div class="nav-icons">
            <div class="icon-btn auth-only hidden-guest" onclick="openMenu('notifDropdown')" title="Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª">
                <i class="fas fa-bell"></i>
                <span class="badge" id="notifBadge">0</span>
            </div>
        </div>
    </nav>

    <div style="padding: 30px; text-align: center;">
        <h2>Ù…Ù†ØµØ© Ù†Ø§Ø¯ÙŠ ÙƒØ¨Ø§Ø± Ø§Ù„Ø´Ø®ØµÙŠØ§Øª</h2>
        <p style="color: #64748b;">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ùƒ ÙˆÙ‚Ù… Ø¨Ø§Ù„Ø´Ø±Ø§Ø¡ ÙÙˆØ±Ø§Ù‹</p>
    </div>

    <div class="cards-container">
        <!-- Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ -->
        <div class="product-card">
            <i class="fab fa-bitcoin"></i>
            <h3>Red Packet 1$</h3>
            <div class="price-tag">50 Ø¬Ù†ÙŠÙ‡</div>
            <button class="action-btn btn-primary" onclick="openPurchase('Binance Red Packet 1$', 50)">Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†</button>
        </div>
        <div class="product-card">
            <i class="fab fa-bitcoin"></i>
            <h3>Red Packet 5$</h3>
            <div class="price-tag">250 Ø¬Ù†ÙŠÙ‡</div>
            <button class="action-btn btn-primary" onclick="openPurchase('Binance Red Packet 5$', 250)">Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†</button>
        </div>
        <div class="product-card">
            <i class="fab fa-bitcoin"></i>
            <h3>Red Packet 10$</h3>
            <div class="price-tag">500 Ø¬Ù†ÙŠÙ‡</div>
            <button class="action-btn btn-primary" onclick="openPurchase('Binance Red Packet 10$', 500)">Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†</button>
        </div>
        <div class="product-card">
            <i class="fab fa-bitcoin"></i>
            <h3>Red Packet 20$</h3>
            <div class="price-tag">1000 Ø¬Ù†ÙŠÙ‡</div>
            <button class="action-btn btn-primary" onclick="openPurchase('Binance Red Packet 20$', 1000)">Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†</button>
        </div>

        <div class="product-card">
            <i class="fab fa-bitcoin"></i>
            <h3>Red Packet 35$</h3>
            <div class="price-tag">1750 Ø¬Ù†ÙŠÙ‡</div>
            <button class="action-btn btn-primary" onclick="openPurchase('Binance Red Packet 35$', 1750)">Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†</button>
        </div>
        <div class="product-card">
            <i class="fab fa-bitcoin"></i>
            <h3>Red Packet 50$</h3>
            <div class="price-tag">2500 Ø¬Ù†ÙŠÙ‡</div>
            <button class="action-btn btn-primary" onclick="openPurchase('Binance Red Packet 50$', 2500)">Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†</button>
        </div>
        <div class="product-card">
            <i class="fab fa-bitcoin"></i>
            <h3>Red Packet 70$</h3>
            <div class="price-tag">3500 Ø¬Ù†ÙŠÙ‡</div>
            <button class="action-btn btn-primary" onclick="openPurchase('Binance Red Packet 70$', 3500)">Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†</button>
        </div>
        <div class="product-card">
            <i class="fab fa-bitcoin"></i>
            <h3>Red Packet 150$</h3>
            <div class="price-tag">7500 Ø¬Ù†ÙŠÙ‡</div>
            <button class="action-btn btn-primary" onclick="openPurchase('Binance Red Packet 150$', 7500)">Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†</button>
        </div>
    </div>
</div>

<!-- Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ù€ ID -->
<div id="profileDropdown" class="dropdown-overlay">
    <i class="fas fa-user-circle" style="font-size: 3rem; color: var(--primary); margin: 15px auto 5px auto;"></i>
    <h4 id="p_nickname" style="margin: 5px 0;">ØªØ­Ù…ÙŠÙ„...</h4>
    <span class="id-label">Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</span>
    <div class="user-id-numeric" id="p_id">000000</div>
    <small>
        <i class="fas fa-copy" onclick="copyText('p_id')" style="cursor:pointer; color:var(--primary);" title="Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù"></i>
        Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù
    </small>
    <div class="balance-card">
        <div class="balance-row"><span>Ø±ØµÙŠØ¯ Ø¬.Ù…: [EGP]</span> <span id="p_egp" style="color:green;">0</span></div>
        <div class="balance-row"><span>Ø±ØµÙŠØ¯ Ø¯ÙˆÙ„Ø§Ø±: [USD]</span> <span id="p_usd" style="color:blue;">0</span></div>
    </div>
    <div style="padding: 0 10px 15px 10px;">
        <button class="action-btn btn-success" onclick="openCurrencySelection()">Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯ (Ø¥ÙŠØ¯Ø§Ø¹)</button>
        <button class="action-btn btn-logout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<div id="currencyModal">
    <h3 style="margin-top:0; text-align: center;">Ø¥ÙŠØ¯Ø§Ø¹ Ø±ØµÙŠØ¯</h3>
    <p style="text-align: center; color: #64748b;">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„ØªÙŠ ØªÙˆØ¯ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø¨Ù‡Ø§:</p>
    <button class="action-btn btn-primary" onclick="handleCurrencyChoice('EGP')">Ø¥ÙŠØ¯Ø§Ø¹ Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡ Ø§Ù„Ù…ØµØ±ÙŠ (EGP)</button>
    <button class="action-btn btn-success" onclick="handleCurrencyChoice('USD')">Ø¥ÙŠØ¯Ø§Ø¹ Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± (USD)</button>
    <button class="action-btn" style="background:#f1f5f9;" onclick="closeAll()">Ø¥Ù„ØºØ§Ø¡</button>
</div>

<div id="topUpModal">
    <h3 id="topUpTitle" style="margin-top:0;">Ø´Ø­Ù† Ø±ØµÙŠØ¯</h3>
    
    <div id="selectedPaymentInfo">
        <strong>ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©: <span id="paymentMethodName">---</span></strong>
    </div>
    
    <div style="text-align: right; margin-bottom: 15px;">
        <label style="font-weight: bold; font-size: 0.85rem;">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</label>
        <select id="paymentMethod" onchange="updatePaymentDetails(); updatePaymentMethodDisplay()"></select>
    </div>
    <div style="text-align: right; margin-bottom: 15px;">
        <label id="amountLabel" style="font-weight: bold; font-size: 0.85rem;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥ÙŠØ¯Ø§Ø¹Ù‡:</label>
        <input type="number" id="topUpAmount" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ù‡Ù†Ø§" oninput="calculateRequiredAmount()">
    </div>
    <div id="calculationDisplay" class="calculation-box">
        <span style="font-size: 0.85rem; font-weight: bold;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ­ÙˆÙŠÙ„Ù‡: </span>
        <b id="finalRequiredAmount">0</b>
    </div>
    <div id="paymentDetails" class="payment-info-box" style="display: block;">
        <p id="methodHint" style="font-size: 0.8rem; margin-bottom: 5px; color: #92400e;"></p>
        <div class="copy-box" id="walletBox">
            <b id="walletNumber">01022797043</b>
            <button class="copy-btn" onclick="copyText('walletNumber')">Ù†Ø³Ø®</button>
        </div>
        <div id="binanceDetails" style="display:none; font-size: 0.85rem; line-height: 1.6;">
            <div>Ø§Ù„Ù…Ø¹Ø±Ù: <b id="binanceID">803045359</b> <button class="copy-btn" style="padding: 2px 5px;" onclick="copyText('binanceID')">Ù†Ø³Ø®</button></div>
            <div>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±: <b id="binanceName">iMrJoe</b></div>
        </div>
    </div>
    <div style="text-align: right; margin-bottom: 15px;">
        <label style="font-weight: bold; font-size: 0.85rem;">Ø§Ø±ÙØ¹ Ø¥ÙŠØµØ§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„:</label>
        <input type="file" id="topUpReceipt" accept="image/*">
    </div>
    <button class="action-btn btn-primary" onclick="submitTopUp()">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠØµØ§Ù„</button>
    <button class="action-btn" style="background:#f1f5f9;" onclick="closeAll()">Ø¥Ù„ØºØ§Ø¡</button>
</div>

<div id="purchaseModal">
    <h3 id="m_title" style="margin-top:0;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡</h3>
    <div id="m_info" style="font-size: 0.9rem; margin-bottom: 15px; color: #475569;"></div>
    <p id="purchaseWarning" style="font-size: 0.85rem; color: #475569; background: #fff7ed; padding: 10px; border-radius: 10px; border: 1px solid #ffedd5;">
        Ø³ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.
    </p>
    <button id="confirmPurchaseBtn" class="action-btn btn-primary">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø®ØµÙ… ÙˆØ§Ù„Ø´Ø±Ø§Ø¡</button>
    <button class="action-btn" style="background:#f1f5f9;" onclick="closeAll()">Ø¥Ù„ØºØ§Ø¡</button>
</div>

<div id="notifDropdown" class="dropdown-overlay">
    <div class="notif-header">
        <span>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span>
        <i class="fas fa-sync-alt refresh-btn" id="refreshIcon" onclick="refreshData()"></i>
        <span id="unreadCount" style="background:var(--danger); font-size:0.7rem; padding:2px 7px; border-radius:10px;">0</span>
    </div>
    <div id="notifList"></div>
    <div style="padding: 10px; display: flex; gap: 5px; background: #111;">
        <button onclick="markAllRead()" style="flex:1; font-size:0.7rem; padding:8px; background:#333; color:white; border:none; border-radius:5px;">Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒÙ„</button>
        <button onclick="deleteAllNotifs()" style="flex:1; font-size:0.7rem; padding:8px; background:#444; color:white; border:none; border-radius:5px;">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
    </div>
</div>

<footer class="modern-footer">
    <div>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; <span id="currentYear"></span> - <b> VipClub </b></div>
    <div class="footer-socials">
        <a href="https://www.youtube.com/@VipCIub" class="social-link youtube" title="ÙŠÙˆØªÙŠÙˆØ¨"><i class="fab fa-youtube"></i></a>
        <a href="https://www.facebook.com/groups/1123845664925685/?ref=share&mibextid=NSMWBT" class="social-link facebook" title="ÙÙŠØ³Ø¨ÙˆÙƒ"><i class="fab fa-facebook-f"></i></a>
        <a href="https://wa.me/+201022797043" class="social-link whatsapp" title="ÙˆØ§ØªØ³Ø§Ø¨"><i class="fab fa-whatsapp"></i></a>
        <a href="https://discord.gg/mqzeqsYzcR" class="social-link discord" title="Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯"><i class="fab fa-discord"></i></a>
    </div>
</footer>

<script>
    // ğŸ”¥ ØªÙƒÙˆÙŠÙ† Firebase (Ù†ÙØ³ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©)
    const firebaseConfig = {
        apiKey: "AIzaSyAVSzkDLqi1G-hpfEPqvBMmuyYRfEuaTKk",
        authDomain: "vipclub-1d04a.firebaseapp.com",
        databaseURL: "https://vipclub-1d04a-default-rtdb.firebaseio.com",
        projectId: "vipclub-1d04a",
        storageBucket: "vipclub-1d04a.firebasestorage.app",
        messagingSenderId: "120667552740",
        appId: "1:120667552740:web:02085765fd43eb0080e5f1"
    };

    // ØªÙ‡ÙŠØ¦Ø© Firebase
    let firebaseApp, database, auth;
    
    // ===== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª =====
    let lastNotificationId = localStorage.getItem('lastNotificationId') || null;
    let notificationCooldown = false;
    let notificationTimers = {};
    let desktopNotificationShown = false;
    
    // ===== Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ ID Ø±Ù‚Ù…ÙŠ =====
    function generateNumericId() {
        // Ø¥Ù†Ø´Ø§Ø¡ ID Ù…ÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù…
        return Math.floor(100000 + Math.random() * 900000);
    }
    
    // ===== Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ID Ø±Ù‚Ù…ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… =====
    function getOrCreateNumericId() {
        let currentUser = getCurrentUserFromStorage();
        
        if (!currentUser) {
            return generateNumericId();
        }
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ID Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡
        if (currentUser.numericId) {
            return currentUser.numericId;
        }
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¯ÙŠÙ‡ ID Ù…Ù† FirebaseØŒ Ø­ÙˆÙ„Ù‡ Ø¥Ù„Ù‰ Ø±Ù‚Ù…
        if (currentUser.id && !isNaN(currentUser.id)) {
            return parseInt(currentUser.id);
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ ID Ø¬Ø¯ÙŠØ¯
        const newNumericId = generateNumericId();
        currentUser.numericId = newNumericId;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        
        return newNumericId;
    }
    
    // ===== Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ù‚Ù…ÙŠ Ù„Ù„Ø¹Ø±Ø¶ =====
    function formatNumericId(id) {
        if (!id) return "000000";
        
        // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø±Ù‚Ù…
        const numId = parseInt(id);
        if (isNaN(numId)) return "000000";
        
        // ØªÙ†Ø³ÙŠÙ‚ Ø¨Ù€ 6 Ø£Ø±Ù‚Ø§Ù… Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø£ØµÙØ§Ø± Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
        return numId.toString().padStart(6, '0');
    }
    
    // ===== Ø¯Ø§Ù„Ø© Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± =====
    function hideCodeInNotification(text) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Øµ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒÙˆØ¯ØŒ Ù†Ø®ÙÙŠÙ‡
        const codeMatch = text.match(/Ø§Ù„ÙƒÙˆØ¯:\s*([A-Z0-9\-]+)/i);
        if (codeMatch && codeMatch[1]) {
            const code = codeMatch[1];
            // Ù†Ø³ØªØ¨Ø¯Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Øµ "Ø§Ù„ÙƒÙˆØ¯: ***" Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ù„Ù„ÙƒØ´Ù Ø¹Ù†Ù‡
            return text.replace(/Ø§Ù„ÙƒÙˆØ¯:\s*[A-Z0-9\-]+/i, `Ø§Ù„ÙƒÙˆØ¯: <span class="code-in-notification" onclick="showCodeInNotification(this, '${code}')">Ø§Ø¶ØºØ· Ù„Ù„ÙƒØ´Ù</span>`);
        }
        return text;
    }
    
    // ===== Ø¯Ø§Ù„Ø© Ù„Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± =====
    function showCodeInNotification(element, code) {
        // ØªØºÙŠÙŠØ± Ø§Ù„Ù†Øµ Ù„Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
        element.innerHTML = code;
        element.style.background = 'linear-gradient(45deg, #10b981, #059669)';
        element.style.cursor = 'default';
        
        // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ù†Ø³Ø® Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„ÙƒÙˆØ¯
        const copyBtn = document.createElement('button');
        copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
        copyBtn.style.background = 'white';
        copyBtn.style.color = '#059669';
        copyBtn.style.border = 'none';
        copyBtn.style.borderRadius = '5px';
        copyBtn.style.padding = '3px 6px';
        copyBtn.style.marginRight = '5px';
        copyBtn.style.cursor = 'pointer';
        copyBtn.style.fontSize = '0.8rem';
        copyBtn.title = 'Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯';
        copyBtn.onclick = function(e) {
            e.stopPropagation();
            navigator.clipboard.writeText(code).then(() => {
                showFirebaseAlert('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯', 'success');
            });
        };
        
        element.insertBefore(copyBtn, element.firstChild);
        
        // Ù…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ù‚Ø±
        element.onclick = null;
    }

    function initializeFirebase() {
        try {
            if (!firebase.apps.length) {
                firebaseApp = firebase.initializeApp(firebaseConfig);
            } else {
                firebaseApp = firebase.app();
            }
            
            database = firebase.database();
            auth = firebase.auth();
            
            console.log('âœ… Firebase initialized successfully');
            showFirebaseAlert('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
            
            auth.onAuthStateChanged((user) => {
                if (user) {
                    console.log('ğŸ‘¤ User logged in:', user.uid);
                    updateUI();
                    // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                    requestNotificationPermission();
                } else {
                    console.log('ğŸ‘¤ No user logged in');
                    updateUI();
                }
            });
            
        } catch (error) {
            console.error('âŒ Firebase initialization error:', error);
            showFirebaseAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase', 'error');
        }
    }

    // ===== Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ =====
    function requestNotificationPermission() {
        if ("Notification" in window && Notification.permission === "default") {
            Notification.requestPermission().then(permission => {
                console.log('Notification permission:', permission);
            });
        }
    }

    // ===== Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Firebase =====
    function showFirebaseAlert(message, type) {
        const alertDiv = document.getElementById('firebaseAlert');
        alertDiv.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${message}</span>
        `;
        alertDiv.className = `firebase-alert firebase-${type}`;
        alertDiv.style.display = 'flex';
        
        setTimeout(() => {
            alertDiv.style.display = 'none';
        }, 4000);
    }

    // ===== Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· =====
    function showDesktopNotification(title, message, type = 'info') {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¥Ø´Ø¹Ø§Ø± Ù†Ø´Ø·
        if (desktopNotificationShown) return;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        if (message.includes('Ø§Ù„ÙƒÙˆØ¯:')) {
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø¥Ø´Ø¹Ø§Ø± Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨
            message = message.replace(/Ø§Ù„ÙƒÙˆØ¯:\s*[A-Z0-9\-]+/i, 'Ø§Ù„ÙƒÙˆØ¯: ***');
        }
        
        const notification = document.getElementById('desktopNotification');
        const titleEl = document.getElementById('notificationTitle');
        const messageEl = document.getElementById('notificationMessage');
        
        titleEl.textContent = title;
        messageEl.textContent = message;
        
        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†ÙˆØ¹
        notification.className = `desktop-notification notification-${type}`;
        
        // ØªØºÙŠÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
        const icon = notification.querySelector('.notification-icon i');
        icon.className = type === 'success' ? 'fas fa-check-circle' : 
                        type === 'error' ? 'fas fa-exclamation-circle' : 
                        type === 'warning' ? 'fas fa-exclamation-triangle' : 'fas fa-bell';
        
        notification.style.display = 'block';
        desktopNotificationShown = true;
        
        // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        playNotificationSound();
        
        // Ø¥ØºÙ„Ø§Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
        setTimeout(() => {
            closeDesktopNotification();
        }, 5000);
    }

    // ===== Ø¥ØºÙ„Ø§Ù‚ Ø¥Ø´Ø¹Ø§Ø± Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ =====
    function closeDesktopNotification() {
        document.getElementById('desktopNotification').style.display = 'none';
        desktopNotificationShown = false;
    }

    // ===== ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± =====
    function playNotificationSound() {
        try {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Audio API Ù„Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØª Ø¨Ø³ÙŠØ·
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
            
            // Ù‡Ø²Ø© Ø®ÙÙŠÙØ© Ù„Ù„ØµÙØ­Ø©
            if ('vibrate' in navigator) {
                navigator.vibrate([100, 50, 100]);
            }
            
        } catch (error) {
            console.log('Sound not available:', error);
        }
    }

    // ===== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¸Ø± =====
    async function checkBanStatus() {
        const currentUser = getCurrentUserFromStorage();
        if (!currentUser) return;
        
        try {
            if (!database) {
                console.log('Database not initialized');
                return;
            }
            
            const userRef = database.ref('users').orderByChild('numericId').equalTo(currentUser.numericId);
            const snapshot = await userRef.once('value');
            
            if (snapshot.exists()) {
                const users = snapshot.val();
                const userId = Object.keys(users)[0];
                const userData = users[userId];
                
                if (userData.isBanned) {
                    if(window.isBanAlerting) return;
                    window.isBanAlerting = true;
                    
                    let banDuration = "Ø¯Ø§Ø¦Ù…";
                    if (userData.banExpiry && userData.banExpiry !== 'permanent') {
                        const expiryDate = new Date(userData.banExpiry);
                        const now = new Date();
                        if (expiryDate > now) {
                            const diffMs = expiryDate - now;
                            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                            const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                            banDuration = `${diffDays} ÙŠÙˆÙ… Ùˆ ${diffHours} Ø³Ø§Ø¹Ø©`;
                        } else {
                            banDuration = "Ù…Ù†ØªÙ‡ÙŠ";
                        }
                    }
                    
                    alert(`ğŸš« ØªÙ… Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©!\n\nØ§Ù„Ø³Ø¨Ø¨: ${userData.banReason || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}\nØ§Ù„Ù…Ø¯Ø©: ${banDuration}\n\nÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ.`);
                    
                    await logout();
                }
            }
        } catch (error) {
            console.error('Error checking ban status:', error);
        }
    }

    // ===== Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firebase =====
    async function getCurrentUserFullData() {
        try {
            const currentUser = getCurrentUserFromStorage();
            if (!currentUser) return null;
            
            if (!database) {
                console.log('Database not initialized');
                return currentUser;
            }
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ID Ø§Ù„Ø±Ù‚Ù…ÙŠ
            const numericId = getOrCreateNumericId();
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… numericId
            const userRef = database.ref('users').orderByChild('numericId').equalTo(numericId);
            const snapshot = await userRef.once('value');
            
            if (snapshot.exists()) {
                const users = snapshot.val();
                const userId = Object.keys(users)[0];
                const userData = users[userId];
                
                // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const mergedUser = {
                    ...currentUser,
                    ...userData,
                    numericId: numericId,
                    firebaseKey: userId,
                    id: userId // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ID Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ù† Firebase
                };
                
                // ØªØ£ÙƒÙŠØ¯ ÙˆØ¬ÙˆØ¯ numericId
                if (!mergedUser.numericId) {
                    mergedUser.numericId = numericId;
                }
                
                // ØªØ­Ø¯ÙŠØ« LocalStorage
                localStorage.setItem('currentUser', JSON.stringify(mergedUser));
                
                return mergedUser;
            }
            
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ FirebaseØŒ Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¦Ù‡
            const newUser = await createUserInFirebase(currentUser, numericId);
            return newUser;
            
        } catch (error) {
            console.error('Error fetching user from Firebase:', error);
            return getCurrentUserFromStorage();
        }
    }

    // ===== Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase =====
    async function createUserInFirebase(localUser, numericId) {
        try {
            if (!database) return localUser;
            
            const newUserRef = database.ref('users').push();
            const firebaseKey = newUserRef.key;
            
            const userData = {
                numericId: numericId,
                username: localUser.username || `user_${numericId}`,
                nickname: localUser.nickname || localUser.username || `user_${numericId}`,
                password: localUser.password || '123456',
                email: localUser.email || '',
                phone: localUser.phone || '',
                isBanned: false,
                banReason: '',
                banExpiry: '',
                balanceEGP: localUser.balanceEGP || '0.00',
                balanceUSD: localUser.balanceUSD || '0.00',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            await newUserRef.set(userData);
            
            const mergedUser = {
                ...localUser,
                ...userData,
                firebaseKey: firebaseKey,
                id: firebaseKey
            };
            
            localStorage.setItem('currentUser', JSON.stringify(mergedUser));
            
            return mergedUser;
            
        } catch (error) {
            console.error('Error creating user in Firebase:', error);
            return localUser;
        }
    }

    // ===== Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† LocalStorage =====
    function getCurrentUserFromStorage() {
        try {
            return JSON.parse(localStorage.getItem('currentUser'));
        } catch (error) {
            return null;
        }
    }

    // ===== Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ =====
    function isLoggedIn() {
        const user = getCurrentUserFromStorage();
        return user !== null;
    }

    // ===== Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© =====
    async function updateUI() {
        await checkBanStatus();
        
        const logged = isLoggedIn();
        document.querySelectorAll('.auth-only').forEach(el => {
            if (logged) el.classList.remove('hidden-guest');
            else el.classList.add('hidden-guest');
        });

        if (!logged) {
            document.getElementById('p_nickname').innerText = "Ø²Ø§Ø¦Ø±";
            document.getElementById('p_id').innerText = "000000";
            document.getElementById('p_egp').innerText = "0";
            document.getElementById('p_usd').innerText = "0";
            document.getElementById('notifBadge').innerText = "0";
            return;
        }

        try {
            const user = await getCurrentUserFullData();
            if (!user) return;

            // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
            document.getElementById('p_nickname').innerText = user.nickname || user.username;
            
            // Ø¹Ø±Ø¶ ID Ø±Ù‚Ù…ÙŠ Ù…Ù†Ø³Ù‚
            const numericId = user.numericId || getOrCreateNumericId();
            document.getElementById('p_id').innerText = formatNumericId(numericId);
            
            document.getElementById('p_egp').innerText = user.balanceEGP || "0";
            document.getElementById('p_usd').innerText = user.balanceUSD || "0";
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Firebase - Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©
            if (database && user.firebaseKey) {
                const notifRef = database.ref('users/' + user.firebaseKey + '/notifications');
                
                // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
                notifRef.on('value', (snapshot) => {
                    let notifications = [];
                    let unreadCount = 0;
                    
                    if (snapshot.exists()) {
                        const notifData = snapshot.val();
                        for (const key in notifData) {
                            const notif = notifData[key];
                            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
                            const safeText = hideCodeInNotification(notif.text || '');
                            
                            notifications.push({
                                id: notif.id || key,
                                text: safeText,
                                read: notif.read || false,
                                date: notif.date || new Date().toLocaleString('ar-EG'),
                                type: notif.type || 'general',
                                originalText: notif.text || ''
                            });
                            if (!notif.read) unreadCount++;
                        }
                        
                        // ØªØ±ØªÙŠØ¨ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…
                        notifications.sort((a, b) => {
                            const idA = parseInt(a.id) || 0;
                            const idB = parseInt(b.id) || 0;
                            return idB - idA;
                        });
                    }
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ (Ø¨Ø¯ÙˆÙ† ØªØ°Ø¨Ø°Ø¨)
                    const badge = document.getElementById('notifBadge');
                    const unreadEl = document.getElementById('unreadCount');
                    
                    // Ø§Ø³ØªØ®Ø¯Ù… debounce Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø±ÙŠØ¹
                    if (notificationTimers.badgeUpdate) {
                        clearTimeout(notificationTimers.badgeUpdate);
                    }
                    
                    notificationTimers.badgeUpdate = setTimeout(() => {
                        badge.innerText = unreadCount;
                        unreadEl.innerText = unreadCount;
                    }, 100);
                    
                    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                    const list = document.getElementById('notifList');
                    if (notifications.length === 0) {
                        list.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div>';
                    } else {
                        list.innerHTML = '';
                        notifications.forEach(n => {
                            const div = document.createElement('div');
                            div.className = `notif-item ${!n.read ? 'unread' : ''}`;
                            div.innerHTML = `
                                <div style="flex:1;">
                                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                                        <i class="fas fa-${n.type === 'purchase_approved' ? 'check-circle' : n.type === 'purchase_rejected' ? 'times-circle' : n.type === 'deposit' ? 'money-bill-wave' : 'info-circle'}" 
                                           style="color: ${n.type === 'purchase_approved' ? '#10b981' : n.type === 'purchase_rejected' ? '#ef4444' : n.type === 'deposit' ? '#6366f1' : '#94a3b8'}; margin-top: 2px;"></i>
                                        <div style="flex: 1;">
                                            ${n.text}<br>
                                            <small style="opacity:0.6;">${n.date}</small>
                                        </div>
                                    </div>
                                </div>
                                <i class="fas fa-trash-alt delete-single-notif" onclick="deleteSingleNotif('${user.firebaseKey}', '${n.id}')" title="Ø­Ø°Ù"></i>
                            `;
                            list.appendChild(div);
                        });
                    }
                }, (error) => {
                    console.error('Notifications error:', error);
                });
            }
            
        } catch (error) {
            console.error('UI update error:', error);
        }
    }

    // ===== Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ© - Ù…Ø¹Ø¯Ù„ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± =====
    async function listenForRealTimeNotifications() {
        const user = await getCurrentUserFullData();
        if (!user || !database || !user.firebaseKey) return;
        
        const notifRef = database.ref('users/' + user.firebaseKey + '/notifications');
        let lastProcessedId = localStorage.getItem('lastProcessedNotificationId') || null;
        
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø·
        notifRef.orderByChild('createdAt').limitToLast(1).on('child_added', (snapshot) => {
            const newNotif = snapshot.val();
            const notifId = snapshot.key;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù…Ø³Ø¨Ù‚Ø§Ù‹
            if (lastProcessedId === notifId) return;
            
            if (newNotif && !newNotif.read) {
                // Ø­ÙØ¸ ID Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø®ÙŠØ±
                localStorage.setItem('lastProcessedNotificationId', notifId);
                lastProcessedId = notifId;
                
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
                let safeMessage = newNotif.text;
                if (safeMessage.includes('Ø§Ù„ÙƒÙˆØ¯:')) {
                    safeMessage = safeMessage.replace(/Ø§Ù„ÙƒÙˆØ¯:\s*[A-Z0-9\-]+/i, 'Ø§Ù„ÙƒÙˆØ¯: *** (Ù…ØªØ§Ø­ ÙÙŠ Ø§Ù„Ù…Ø­ÙØ¸Ø©)');
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† cooldown
                if (notificationCooldown) return;
                
                notificationCooldown = true;
                
                // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
                if (newNotif.type === 'purchase_approved') {
                    showDesktopNotification('âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨Ùƒ', safeMessage, 'success');
                    showFirebaseAlert('ğŸ‰ ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨Ùƒ! Ø§Ù„ÙƒÙˆØ¯ Ù…ØªØ§Ø­ ÙÙŠ Ø§Ù„Ù…Ø­ÙØ¸Ø©', 'success');
                } else if (newNotif.type === 'purchase_rejected') {
                    showDesktopNotification('âŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨Ùƒ', safeMessage, 'error');
                    showFirebaseAlert('âš ï¸ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨Ùƒ. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„ØªÙØ§ØµÙŠÙ„', 'warning');
                } else if (newNotif.type === 'deposit') {
                    showDesktopNotification('ğŸ’° ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹', safeMessage, 'success');
                }
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† cooldown Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
                setTimeout(() => {
                    notificationCooldown = false;
                }, 2000);
            }
        });
    }

    // ===== Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª =====
    async function deleteSingleNotif(userKey, notifId) {
        try {
            if (!database) return;
            
            const notifRef = database.ref('users/' + userKey + '/notifications');
            const snapshot = await notifRef.once('value');
            
            if (snapshot.exists()) {
                const notifData = snapshot.val();
                for (const key in notifData) {
                    const notif = notifData[key];
                    // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ID Ø£Ùˆ Ø¨Ø§Ù„Ù…ÙØªØ§Ø­
                    if ((notif.id && notif.id.toString() === notifId.toString()) || key === notifId) {
                        await database.ref('users/' + userKey + '/notifications/' + key).remove();
                        showFirebaseAlert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±", 'success');
                        break;
                    }
                }
            }
            
        } catch (error) {
            console.error('Delete notification error:', error);
            showFirebaseAlert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±", 'error');
        }
    }

    async function markAllRead() {
        try {
            const user = await getCurrentUserFullData();
            if (!user || !database || !user.firebaseKey) return;
            
            const notifRef = database.ref('users/' + user.firebaseKey + '/notifications');
            const snapshot = await notifRef.once('value');
            
            if (snapshot.exists()) {
                const updates = {};
                const notifData = snapshot.val();
                for (const key in notifData) {
                    updates[key + '/read'] = true;
                }
                await notifRef.update(updates);
                showFirebaseAlert("ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©", 'success');
            }
            
        } catch (error) {
            console.error('Mark all read error:', error);
        }
    }

    async function deleteAllNotifs() {
        if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§ØªØŸ")) return;
        
        try {
            const user = await getCurrentUserFullData();
            if (!user || !database || !user.firebaseKey) return;
            
            await database.ref('users/' + user.firebaseKey + '/notifications').remove();
            showFirebaseAlert("ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª", 'success');
            
        } catch (error) {
            console.error('Delete all notifications error:', error);
        }
    }

    // ===== Ø¯Ø§Ù„Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ù„Ù„Ø¹Ù…Ù„ Ù…Ø¹ Firebase =====
    async function confirmDirectPurchase() {
        try {
            const user = await getCurrentUserFullData();
            if (!user) {
                alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
                window.location.href = 'Login.html';
                return;
            }
            
            if ((user.balanceEGP || 0) < activeProduct.price) {
                alert(`Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ. ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ${activeProduct.price} Ø¬.Ù…`);
                openCurrencySelection();
                return;
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙÙŠ Firebase
            await database.ref('users/' + user.firebaseKey).update({
                balanceEGP: (parseFloat(user.balanceEGP) || 0) - activeProduct.price,
                updatedAt: new Date().toISOString()
            });
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Firebase
            const transactionId = "TRX-" + Math.floor(Math.random() * 1000000);
            const orderData = {
                orderId: transactionId,
                userId: user.numericId,
                username: user.username,
                nickname: user.nickname || user.username,
                product: activeProduct.name,
                price: activeProduct.price + " Ø¬.Ù…",
                status: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
                type: 'purchase',
                createdAt: new Date().toISOString(),
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            // Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Firebase
            await database.ref('orders').push(orderData);
            
            // Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase (Ø¨Ø¯ÙˆÙ† ÙƒÙˆØ¯)
            const notification = {
                id: Date.now(),
                text: `âœ… ØªÙ… Ø·Ù„Ø¨ ${activeProduct.name}. ØªÙ… Ø®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯. Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${transactionId}`,
                read: false,
                date: new Date().toLocaleString('ar-EG'),
                type: 'purchase',
                createdAt: new Date().toISOString()
            };
            
            await database.ref('users/' + user.firebaseKey + '/notifications').push(notification);
            
            alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!");
            closeAll();
            await updateUI();
            
        } catch (error) {
            console.error('Purchase error:', error);
            alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        }
    }

    // ===== Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ù„Ù„Ø¹Ù…Ù„ Ù…Ø¹ Firebase =====
    async function submitTopUp() {
        const amount = document.getElementById('topUpAmount').value;
        const paymentMethod = document.getElementById('paymentMethod').value;
        const fileInput = document.getElementById('topUpReceipt');
        
        if (!amount || amount <= 0) {
            showFirebaseAlert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºØ§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹", 'error');
            return;
        }
        
        if (!paymentMethod) {
            showFirebaseAlert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹", 'error');
            return;
        }
        
        if (fileInput.files.length === 0) {
            showFirebaseAlert("ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„", 'error');
            return;
        }
        
        try {
            const user = await getCurrentUserFullData();
            if (!user) {
                showFirebaseAlert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹", 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const generatedId = "DEP-" + Date.now();
                
                // Ø§Ø³Ù… ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹
                const methodNames = {
                    'vodafone': 'ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´',
                    'instapay': 'Ø¥Ù†Ø³ØªØ§ Ø¨Ø§ÙŠ',
                    'binance': 'Binance Pay'
                };
                const methodName = methodNames[paymentMethod] || paymentMethod;
                
                // Ø­ÙØ¸ Ø·Ù„Ø¨ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ ÙÙŠ Firebase
                const orderData = {
                    orderId: generatedId,
                    userId: user.numericId,
                    username: user.username,
                    nickname: user.nickname || user.username,
                    product: `Ø¥ÙŠØ¯Ø§Ø¹ ${selectedCurrency} Ø¹Ø¨Ø± ${methodName}`,
                    price: `${amount} ${selectedCurrency}`,
                    paymentMethod: paymentMethod,
                    method: methodName,
                    currency: selectedCurrency,
                    receipt: e.target.result,
                    status: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
                    type: 'deposit',
                    createdAt: new Date().toISOString(),
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                await database.ref('orders').push(orderData);
                
                // Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const notification = {
                    id: Date.now(),
                    text: `â³ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø¹Ø¨Ø± ${methodName}. Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨: ${generatedId}. Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø­ÙŠÙ† Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.`,
                    read: false,
                    date: new Date().toLocaleString('ar-EG'),
                    type: 'deposit',
                    createdAt: new Date().toISOString()
                };
                
                await database.ref('users/' + user.firebaseKey + '/notifications').push(notification);
                
                showFirebaseAlert(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù† Ø¹Ø¨Ø± ${methodName} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                closeAll();
                await updateUI();
            };
            
            reader.readAsDataURL(fileInput.files[0]);
            
        } catch (error) {
            console.error('Top-up error:', error);
            showFirebaseAlert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨", 'error');
        }
    }

    // ===== Ø¯ÙˆØ§Ù„ Ø£Ø®Ø±Ù‰ =====
    document.getElementById('currentYear').textContent = new Date().getFullYear();
    let selectedCurrency = 'EGP';
    let activeProduct = {};

    function handleProfileClick() {
        if (!isLoggedIn()) window.location.href = 'Login.html';
        else openMenu('profileDropdown');
    }

    function handleSupportClick() {
        if (!isLoggedIn()) window.location.href = 'Login.html';
        else window.location.href = 'support.html';
    }

    function copyText(id) {
        const text = document.getElementById(id).innerText;
        navigator.clipboard.writeText(text).then(() => { 
            showFirebaseAlert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù: " + text, 'success'); 
        });
    }

    function openMenu(id) {
        if (!isLoggedIn()) { window.location.href = 'Login.html'; return; }
        const target = document.getElementById(id);
        const isOpen = target.classList.contains('active');
        closeAll();
        if(!isOpen) {
            target.classList.add('active');
            document.getElementById('screenOverlay').style.display = 'block';
            updateUI();
        }
    }

    function closeAll() {
        document.querySelectorAll('.dropdown-overlay').forEach(m => m.classList.remove('active'));
        document.querySelectorAll('#purchaseModal, #topUpModal, #currencyModal').forEach(m => {
            m.style.display = 'none'; m.classList.remove('modal-active');
        });
        document.getElementById('screenOverlay').style.display = 'none';
        closeDesktopNotification();
    }

    function openCurrencySelection() {
        if (!isLoggedIn()) { window.location.href = 'Login.html'; return; }
        closeAll();
        const m = document.getElementById('currencyModal');
        m.style.display = 'flex'; m.classList.add('modal-active');
        document.getElementById('screenOverlay').style.display = 'block';
    }

    function updatePaymentMethodDisplay() {
        const method = document.getElementById('paymentMethod').value;
        const display = document.getElementById('selectedPaymentInfo');
        const nameSpan = document.getElementById('paymentMethodName');
        
        const methodNames = {
            'vodafone': 'ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´',
            'instapay': 'Ø¥Ù†Ø³ØªØ§ Ø¨Ø§ÙŠ',
            'binance': 'Binance Pay'
        };
        
        if(method && methodNames[method]) {
            nameSpan.textContent = methodNames[method];
            display.style.display = 'block';
        } else {
            display.style.display = 'none';
        }
    }

    function handleCurrencyChoice(currency) {
        selectedCurrency = currency;
        closeAll();
        const methodSelect = document.getElementById('paymentMethod');
        methodSelect.innerHTML = '';
        document.getElementById('topUpAmount').value = '';
        document.getElementById('finalRequiredAmount').innerText = '0';
        document.getElementById('calculationDisplay').style.display = 'none';
        document.getElementById('selectedPaymentInfo').style.display = 'none';
        
        if(currency === 'USD') {
            document.getElementById('topUpTitle').innerText = "Ø´Ø­Ù† Ø±ØµÙŠØ¯ (Ø¯ÙˆÙ„Ø§Ø±)";
            document.getElementById('amountLabel').innerText = "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥ÙŠØ¯Ø§Ø¹Ù‡ (USD):";
            const options = [{val: 'binance', text: 'Binance Pay'}, {val: 'vodafone', text: 'ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´'}, {val: 'instapay', text: 'Ø¥Ù†Ø³ØªØ§ Ø¨Ø§ÙŠ'}];
            options.forEach(opt => { let el = document.createElement('option'); el.value = opt.val; el.innerText = opt.text; methodSelect.appendChild(el); });
        } else {
            document.getElementById('topUpTitle').innerText = "Ø´Ø­Ù† Ø±ØµÙŠØ¯ (Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ)";
            document.getElementById('amountLabel').innerText = "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥ÙŠØ¯Ø§Ø¹Ù‡ (EGP):";
            const options = [{val: 'vodafone', text: 'ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´'}, {val: 'instapay', text: 'Ø¥Ù†Ø³ØªØ§ Ø¨Ø§ÙŠ'}];
            options.forEach(opt => { let el = document.createElement('option'); el.value = opt.val; el.innerText = opt.text; methodSelect.appendChild(el); });
        }
        updatePaymentDetails();
        updatePaymentMethodDisplay();
        document.getElementById('topUpModal').style.display = 'flex';
        document.getElementById('topUpModal').classList.add('modal-active');
        document.getElementById('screenOverlay').style.display = 'block';
    }

    function calculateRequiredAmount() {
        const amount = parseFloat(document.getElementById('topUpAmount').value) || 0;
        const method = document.getElementById('paymentMethod').value;
        const display = document.getElementById('calculationDisplay');
        const finalLabel = document.getElementById('finalRequiredAmount');
        if(amount <= 0) { display.style.display = 'none'; return; }
        display.style.display = 'block';
        if(selectedCurrency === 'USD') {
            if(method === 'binance') finalLabel.innerText = amount + " USDT";
            else finalLabel.innerText = (amount * 50) + " Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ";
        } else { finalLabel.innerText = amount + " Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ"; }
    }

    function updatePaymentDetails() {
        const method = document.getElementById('paymentMethod').value;
        const walletBox = document.getElementById('walletBox');
        const binanceDetails = document.getElementById('binanceDetails');
        const hint = document.getElementById('methodHint');
        walletBox.style.display = 'none'; binanceDetails.style.display = 'none';
        if(method === 'binance') { binanceDetails.style.display = 'block'; hint.innerText = "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Binance Pay:"; }
        else { walletBox.style.display = 'flex'; hint.innerText = "Ø­ÙˆÙ„ Ù„Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ§Ù„ÙŠ:"; document.getElementById('walletNumber').innerText = "01022797043"; }
        calculateRequiredAmount();
        updatePaymentMethodDisplay();
    }

    function openPurchase(name, price) {
        if (!isLoggedIn()) { window.location.href = 'Login.html'; return; }
        closeAll();
        
        getCurrentUserFullData().then(user => {
            if (!user) {
                window.location.href = 'Login.html';
                return;
            }
            
            activeProduct = { name, price };
            if ((user.balanceEGP || 0) < price) {
                alert(`Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ. ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ${price} Ø¬.Ù…`);
                openCurrencySelection();
                return;
            }
            
            document.getElementById('m_info').innerHTML = `Ø´Ø±Ø§Ø¡: <b>${name}</b><br>Ø§Ù„ØªÙƒÙ„ÙØ©: <b>${price} Ø¬.Ù…</b>`;
            document.getElementById('confirmPurchaseBtn').onclick = confirmDirectPurchase;
            document.getElementById('purchaseModal').style.display = 'flex';
            document.getElementById('purchaseModal').classList.add('modal-active');
            document.getElementById('screenOverlay').style.display = 'block';
        });
    }

    async function refreshData() {
        const icon = document.getElementById('refreshIcon');
        icon.classList.add('refreshing');
        await updateUI();
        icon.classList.remove('refreshing');
    }

    // ===== Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ =====
    async function logout() {
        try {
            if (auth) {
                await auth.signOut();
            }
            
            localStorage.removeItem('currentUser');
            window.location.reload();
            
        } catch (error) {
            console.error('Logout error:', error);
            localStorage.removeItem('currentUser');
            window.location.reload();
        }
    }

    // ===== Ø¯ÙˆØ§Ù„ Ø¯Ø¹Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© =====
    
    // 1. Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¶ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù…Ø­ÙØ¸Ø©
    async function prepareForWallet() {
        try {
            if (!isLoggedIn()) {
                window.location.href = 'Login.html';
                return false;
            }
            
            const user = await getCurrentUserFullData();
            if (!user) {
                alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
                window.location.href = 'Login.html';
                return false;
            }
            
            // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø³Ø· Ù„Ù„Ù…Ø­ÙØ¸Ø©
            const walletData = {
                id: user.numericId || user.id,
                nickname: user.nickname || user.username,
                balanceEGP: user.balanceEGP || "0",
                balanceUSD: user.balanceUSD || "0",
                numericId: user.numericId,
                username: user.username,
                email: user.email || '',
                phone: user.phone || '',
                firebaseKey: user.firebaseKey,
                // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ù† Firebase Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
                purchasedCards: user.purchasedCards || []
            };
            
            // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙÙŠ localStorage
            localStorage.setItem('walletUserData', JSON.stringify(walletData));
            
            // Ø­ÙØ¸ Ø±Ù…Ø² Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø©
            const walletSession = {
                timestamp: Date.now(),
                userId: user.numericId,
                sessionId: 'wallet_' + Date.now()
            };
            localStorage.setItem('walletSession', JSON.stringify(walletSession));
            
            console.log('âœ… ØªÙ… ØªØ­Ø¶ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:', user.nickname);
            showFirebaseAlert('âœ… ØªÙ… ØªØ­Ø¶ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø©', 'success');
            
            return true;
            
        } catch (error) {
            console.error('Error preparing wallet data:', error);
            showFirebaseAlert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¶ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø©', 'error');
            return false;
        }
    }
    
    // 2. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø©
    function checkWalletSession() {
        const session = JSON.parse(localStorage.getItem('walletSession'));
        if (!session) return false;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ø­Ø¯ÙŠØ«Ø© (Ø£Ù‚Ù„ Ù…Ù† 5 Ø¯Ù‚Ø§Ø¦Ù‚)
        const sessionAge = Date.now() - session.timestamp;
        if (sessionAge > 5 * 60 * 1000) { // 5 Ø¯Ù‚Ø§Ø¦Ù‚
            localStorage.removeItem('walletSession');
            localStorage.removeItem('walletUserData');
            return false;
        }
        
        return true;
    }
    
    // 3. Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø¨Ø§Ù†ØªØ¸Ø§Ù…
    async function refreshWalletData() {
        try {
            const user = await getCurrentUserFullData();
            if (!user) return false;
            
            // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø©
            const walletData = {
                id: user.numericId || user.id,
                nickname: user.nickname || user.username,
                balanceEGP: user.balanceEGP || "0",
                balanceUSD: user.balanceUSD || "0",
                numericId: user.numericId,
                username: user.username,
                email: user.email || '',
                phone: user.phone || '',
                firebaseKey: user.firebaseKey,
                purchasedCards: user.purchasedCards || []
            };
            
            localStorage.setItem('walletUserData', JSON.stringify(walletData));
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø©
            const walletSession = {
                timestamp: Date.now(),
                userId: user.numericId,
                sessionId: 'wallet_' + Date.now()
            };
            localStorage.setItem('walletSession', JSON.stringify(walletSession));
            
            console.log('ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø©');
            return true;
            
        } catch (error) {
            console.error('Error refreshing wallet data:', error);
            return false;
        }
    }

    // ===== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© =====
    window.onload = async function() {
        initializeFirebase();
        await updateUI();
        
        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        setTimeout(async () => {
            await refreshWalletData();
        }, 1000);
        
        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
        setInterval(async () => {
            await refreshWalletData();
        }, 60000);
        
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ©
        setTimeout(async () => {
            await listenForRealTimeNotifications();
        }, 2000);
        
        setInterval(checkBanStatus, 30000); // ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
    };
</script>
</body>
</html>