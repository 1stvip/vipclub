<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="images//videoslogo/vip.png">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© - VipClub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root {
            --whatsapp-dark: #0c1317;
            --whatsapp-dark-2: #111b21;
            --whatsapp-dark-3: #202c33;
            --whatsapp-dark-4: #2a3942;
            --whatsapp-green: #005c4b;
            --whatsapp-green-light: #008069;
            --whatsapp-blue: #53bdeb;
            --text-primary: #e9edef;
            --text-secondary: #8696a0;
            --text-muted: #667781;
            --border-color: #303d45;
            --online: #00a884;
            --away: #ffb347;
            --offline: #8696a0;
            --danger: #f15c6d;
            --warning: #ffb347;
            --success: #00a884;
        }

        * {
            box-sizing: border-box;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; 
            background: var(--whatsapp-dark); 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            overflow: hidden;
            color: var(--text-primary);
        }

        .users-sidebar {
            width: 380px; 
            background: var(--whatsapp-dark-2); 
            border-left: 1px solid var(--border-color);
            display: flex; 
            flex-direction: column; 
            z-index: 100; 
            position: relative;
            min-width: 300px;
        }

        .sidebar-header { 
            padding: 15px 20px; 
            background: var(--whatsapp-dark-3); 
            color: var(--text-primary); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            min-height: 70px;
        }
        
        .sidebar-search-wrap { 
            padding: 12px 15px; 
            background: var(--whatsapp-dark-3); 
            border-bottom: 1px solid var(--border-color); 
        }
        
        .search-input-inner {
            display: flex; 
            align-items: center; 
            background: var(--whatsapp-dark-4); 
            border: none; 
            border-radius: 8px; 
            padding: 8px 12px;
        }
        
        .search-input-inner input { 
            border: none; 
            outline: none; 
            width: 100%; 
            padding: 5px; 
            font-size: 0.9rem; 
            background: transparent;
            color: var(--text-primary);
            font-family: inherit;
        }
        
        .search-input-inner input::placeholder {
            color: var(--text-muted);
        }
        
        .search-input-inner i { 
            color: var(--text-secondary); 
            margin-left: 8px;
        }

        .sidebar-refresh-btn {
            background: var(--whatsapp-dark-4);
            border: none;
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .sidebar-refresh-btn:hover { 
            background: var(--whatsapp-dark-3); 
            color: var(--text-primary);
            transform: rotate(90deg);
        }
        
        .rotate-anim { animation: spin 0.6s ease-in-out; }
        
        @keyframes spin { 
            100% { transform: rotate(360deg); } 
        }

        .sidebar-tabs { 
            display: flex; 
            background: var(--whatsapp-dark-3); 
            border-bottom: 1px solid var(--border-color); 
        }
        
        .tab { 
            flex: 1; 
            padding: 14px; 
            text-align: center; 
            cursor: pointer; 
            font-size: 0.85rem; 
            transition: 0.3s; 
            color: var(--text-secondary); 
            position: relative;
            font-weight: 500;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active { 
            color: var(--whatsapp-blue); 
            border-bottom: 3px solid var(--whatsapp-blue);
            background: var(--whatsapp-dark);
        }
        
        .tab-badge {
            background: var(--whatsapp-blue);
            color: var(--text-primary);
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-right: 5px;
        }

        .user-list { 
            flex: 1; 
            overflow-y: auto; 
            overflow-x: hidden;
            background: var(--whatsapp-dark-2);
        }
        
        .user-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .user-list::-webkit-scrollbar-track {
            background: var(--whatsapp-dark);
        }
        
        .user-list::-webkit-scrollbar-thumb {
            background: var(--whatsapp-dark-4);
            border-radius: 3px;
        }
        
        .user-item {
            padding: 16px; 
            border-bottom: 1px solid var(--border-color); 
            cursor: pointer;
            display: flex; 
            flex-direction: column; 
            position: relative; 
            transition: all 0.2s;
            background: var(--whatsapp-dark-2);
        }
        
        .user-item:hover { 
            background: var(--whatsapp-dark-3); 
        }
        
        .user-item.active { 
            background: var(--whatsapp-dark-4); 
        }
        
        .user-item.escalated { 
            background: rgba(239, 68, 68, 0.1); 
            border-right: 4px solid var(--danger);
        }
        
        .user-item.archived {
            opacity: 0.7;
            background: var(--whatsapp-dark);
        }

        .user-info-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .user-name-container {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }

        .user-nickname {
            color: var(--text-primary);
            font-size: 0.95rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-id-tag { 
            font-size: 0.75rem; 
            background: var(--whatsapp-dark-4); 
            color: var(--text-secondary); 
            padding: 3px 8px; 
            border-radius: 12px; 
            margin-left: 8px; 
            font-family: 'Monaco', 'Courier New', monospace; 
            font-weight: 400;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        
        .copy-id-btn {
            cursor: pointer;
            color: var(--whatsapp-blue);
            transition: 0.2s;
            font-size: 0.7rem;
        }
        
        .copy-id-btn:hover {
            color: var(--text-primary);
            transform: scale(1.1);
        }

        .user-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-online { background-color: var(--online); }
        .status-away { background-color: var(--away); }
        .status-offline { background-color: var(--offline); }

        .item-actions { 
            position: absolute; 
            left: 10px; 
            top: 50%; 
            transform: translateY(-50%);
            display: flex; 
            gap: 5px; 
            opacity: 0; 
            transition: 0.3s; 
            z-index: 5; 
            background: var(--whatsapp-dark-4);
            padding: 5px;
            border-radius: 6px;
        }
        
        .user-item:hover .item-actions { 
            opacity: 1; 
        }
        
        .action-icon { 
            font-size: 0.8rem; 
            padding: 6px; 
            border-radius: 4px; 
            background: var(--whatsapp-dark-3); 
            color: var(--text-secondary); 
            transition: 0.2s; 
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-icon:hover { 
            background: var(--whatsapp-blue); 
            color: white; 
        }

        .chat-area { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            background: var(--whatsapp-dark); 
            position: relative; 
            min-width: 0;
        }
        
        .chat-header {
            padding: 15px 20px; 
            background: var(--whatsapp-dark-3); 
            border-bottom: 1px solid var(--border-color);
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            min-height: 70px;
            box-sizing: border-box;
            flex-wrap: wrap;
            gap: 15px;
        }

        .user-header-info {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
            flex: 1;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--whatsapp-green), var(--whatsapp-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 16px;
            flex-shrink: 0;
        }

        .header-text-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
            min-width: 0;
            flex: 1;
        }

        #currentUserName {
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #currentUserDisplayId {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-family: 'Monaco', 'Courier New', monospace;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #statusIndicator {
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .chat-search-box {
            display: flex; 
            align-items: center; 
            background: var(--whatsapp-dark-4); 
            border-radius: 20px; 
            padding: 6px 15px; 
            gap: 8px; 
            border: none;
            min-width: 150px;
            flex-shrink: 0;
        }
        
        .chat-search-box input { 
            border: none; 
            background: transparent; 
            outline: none; 
            font-size: 0.85rem; 
            width: 100px; 
            transition: width 0.3s; 
            color: var(--text-primary);
        }
        
        .chat-search-box input:focus { 
            width: 200px; 
        }
        
        .chat-search-box i { 
            color: var(--text-secondary); 
            font-size: 0.8rem;
        }

        .header-btns { 
            display: flex; 
            gap: 8px; 
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        
        .btn { 
            padding: 8px 12px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 0.75rem; 
            font-weight: 600; 
            transition: all 0.3s; 
            display: flex;
            align-items: center;
            gap: 6px;
            height: 36px;
            white-space: nowrap;
        }
        
        .btn-refresh { 
            background: var(--whatsapp-dark-4); 
            color: var(--text-primary); 
            border: 1px solid var(--border-color);
        }
        
        .btn-refresh:hover { 
            background: var(--whatsapp-dark-3); 
        }
        
        .btn-quick-replies { 
            background: var(--whatsapp-green-light); 
            color: white; 
        }
        
        .btn-quick-replies:hover { 
            background: var(--whatsapp-green); 
        }
        
        .btn-end { 
            background: var(--warning); 
            color: #000; 
        }
        
        .btn-end:hover { 
            background: #e68900; 
        }
        
        .btn-delete-mine { 
            background: var(--whatsapp-dark-4); 
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-delete-mine:hover { 
            background: var(--whatsapp-dark-3); 
        }
        
        .btn-delete-all { 
            background: var(--danger); 
            color: white; 
        }
        
        .btn-delete-all:hover { 
            background: #d03c4d; 
        }

        .quick-replies-panel {
            position: absolute;
            bottom: 85px;
            right: 20px;
            background: var(--whatsapp-dark-4);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            z-index: 1000;
            display: none;
            width: 320px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }
        
        .quick-replies-panel::-webkit-scrollbar {
            width: 6px;
        }
        
        .quick-replies-panel::-webkit-scrollbar-thumb {
            background: var(--whatsapp-dark-3);
            border-radius: 3px;
        }
        
        .quick-replies-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .quick-replies-header h4 {
            margin: 0;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .manage-quick-replies-btn {
            background: var(--whatsapp-dark-3);
            border: none;
            color: var(--text-secondary);
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: 0.3s;
        }
        
        .manage-quick-replies-btn:hover {
            background: var(--whatsapp-blue);
            color: white;
        }
        
        .quick-reply-btn {
            display: block;
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 8px;
            background: var(--whatsapp-dark-3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            text-align: right;
            font-size: 0.85rem;
            color: var(--text-primary);
            transition: all 0.3s;
            font-family: inherit;
        }
        
        .quick-reply-btn:hover {
            background: var(--whatsapp-blue);
            color: white;
            transform: translateX(-3px);
            border-color: var(--whatsapp-blue);
        }
        
        .quick-reply-actions {
            display: flex;
            justify-content: flex-end;
            gap: 5px;
            margin-top: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .quick-reply-btn:hover .quick-reply-actions {
            opacity: 1;
        }
        
        .quick-reply-action-btn {
            background: rgba(0,0,0,0.3);
            border: none;
            color: var(--text-primary);
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .quick-reply-action-btn:hover {
            background: var(--whatsapp-blue);
        }

        .chat-messages {
            flex: 1; 
            padding: 20px; 
            overflow-y: auto;
            overflow-x: hidden;
            display: flex; 
            flex-direction: column; 
            gap: 12px;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-color: var(--whatsapp-dark-2);
            background-blend-mode: overlay;
            position: relative;
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--whatsapp-dark-4);
            border-radius: 3px;
        }

        .highlight { 
            background: rgba(255, 235, 59, 0.3); 
            color: inherit; 
            font-weight: bold; 
            padding: 0 2px; 
            border-radius: 3px; 
        }

        .msg-row { 
            display: flex; 
            align-items: flex-end; 
            gap: 8px; 
            max-width: 75%; 
            position: relative; 
        }
        
        .msg-row.admin { 
            margin-left: auto; 
            flex-direction: row-reverse;
        }
        
        .msg-row.user { 
            margin-right: auto; 
            flex-direction: row;
        }

        .msg { 
            padding: 8px 12px; 
            border-radius: 12px; 
            font-size: 0.9rem; 
            position: relative; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); 
            line-height: 1.4;
            word-break: break-word;
            max-width: 100%;
            overflow-wrap: break-word;
        }
        
        .msg.admin { 
            background: var(--whatsapp-green); 
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .msg.user { 
            background: var(--whatsapp-dark-4); 
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
        }
        
        .msg-options-trigger {
            cursor: pointer; 
            color: var(--text-secondary); 
            padding: 8px; 
            font-size: 0.9rem; 
            transition: 0.2s; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            background: var(--whatsapp-dark-3);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            opacity: 0;
            visibility: hidden;
            flex-shrink: 0;
        }
        
        .msg-row:hover .msg-options-trigger {
            opacity: 1;
            visibility: visible;
        }
        
        .msg-options-trigger:hover { 
            color: var(--whatsapp-blue); 
            background: var(--whatsapp-dark-4);
        }

        .msg-options-menu {
            position: fixed;
            background: var(--whatsapp-dark-4);
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            z-index: 1000;
            min-width: 180px;
            overflow: hidden;
            display: none;
            border: 1px solid var(--border-color);
        }
        
        .msg-option {
            padding: 10px 15px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.85rem;
        }
        
        .msg-option:hover {
            background: var(--whatsapp-dark-3);
        }
        
        .msg-option.edit { color: var(--warning); }
        .msg-option.delete-for-me { color: var(--text-secondary); }
        .msg-option.delete-for-all { color: var(--danger); }

        .msg img, .msg video { 
            max-width: 100%; 
            border-radius: 8px; 
            margin-top: 5px; 
            display: block; 
            cursor: pointer; 
            max-height: 300px;
            object-fit: contain;
        }
        
        .file-attachment {
            display: flex; 
            align-items: center; 
            gap: 10px; 
            background: rgba(255,255,255,0.05);
            padding: 10px; 
            border-radius: 8px; 
            text-decoration: none; 
            color: inherit;
            border: 1px dashed var(--border-color); 
            transition: 0.2s;
            margin-top: 5px;
        }
        
        .file-attachment:hover { 
            background: rgba(255,255,255,0.1); 
            border-color: var(--whatsapp-blue);
        }

        .msg-status-tag { 
            font-size: 0.7rem; 
            color: rgba(255,255,255,0.6); 
            font-style: italic; 
            margin-right: 5px; 
        }
        
        .read-check { 
            color: var(--whatsapp-blue) !important; 
            font-size: 0.75rem !important; 
            margin-right: 3px !important;
        }
        
        .unread-check {
            color: var(--text-secondary) !important;
            font-size: 0.7rem !important;
            margin-right: 3px !important;
        }

        .chat-input-wrap {
            padding: 10px 15px; 
            background: var(--whatsapp-dark-3); 
            border-top: 1px solid var(--border-color);
            display: flex; 
            gap: 10px; 
            align-items: center; 
            position: relative;
            flex-wrap: nowrap;
            min-height: 70px;
            z-index: 100;
        }
        
        #adminInput { 
            flex: 1; 
            padding: 12px 15px; 
            border: none; 
            border-radius: 25px; 
            outline: none; 
            background: var(--whatsapp-dark-4);
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            min-width: 150px;
            height: 44px;
            margin: 0;
            position: relative;
        }
        
        #adminInput::placeholder {
            color: var(--text-secondary);
        }

        .emoji-btn, .attach-btn, .external-upload-btn {
            background: none; 
            border: none; 
            font-size: 1.2rem; 
            color: var(--text-secondary); 
            cursor: pointer; 
            transition: all 0.2s;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            flex-shrink: 0;
            position: relative;
        }
        
        .emoji-btn:hover, .attach-btn:hover, .external-upload-btn:hover { 
            color: var(--whatsapp-blue); 
            background: var(--whatsapp-dark-4);
        }
        
        .external-upload-btn.active {
            color: var(--whatsapp-blue);
            background: var(--whatsapp-dark-4);
        }
        
        #fileInput { display: none; }

        #emojiPickerContainer {
            position: absolute; 
            bottom: 85px; 
            right: 20px;
            z-index: 1000;
            display: none;
            box-shadow: 0 5px 25px rgba(0,0,0,0.4); 
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .external-upload-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--whatsapp-dark-4);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            z-index: 9999;
            display: none;
            width: 300px;
            border: 1px solid var(--border-color);
            max-height: calc(100vh - 150px);
            overflow-y: auto;
        }
        
        .external-upload-btn-panel {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            margin-bottom: 10px;
            background: var(--whatsapp-dark-3);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            color: var(--text-primary);
            width: 100%;
            justify-content: flex-start;
            height: auto;
            border-radius: 8px;
        }
        
        .external-upload-btn-panel:hover {
            background: var(--whatsapp-blue);
            color: white;
            border-color: var(--whatsapp-blue);
        }
        
        .external-link-input {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .external-link-input input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9rem;
            background: var(--whatsapp-dark-3);
            color: var(--text-primary);
            outline: none;
        }
        
        .external-link-input input::placeholder {
            color: var(--text-secondary);
        }
        
        .external-link-input button {
            background: var(--whatsapp-green-light); 
            color: white; 
            border: none; 
            padding: 0 15px; 
            border-radius: 8px; 
            cursor: pointer;
            font-size: 0.9rem;
            transition: 0.3s;
            flex-shrink: 0;
        }
        
        .external-link-input button:hover {
            background: var(--whatsapp-green);
        }

        .send-btn {
            background: var(--whatsapp-green-light); 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 44px; 
            height: 44px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.1rem; 
            transition: 0.3s;
            flex-shrink: 0;
            position: relative;
        }
        
        .send-btn:hover {
            background: var(--whatsapp-green);
            transform: scale(1.05);
        }

        .empty-state {
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            height: 100%; 
            color: var(--text-secondary); 
            background: var(--whatsapp-dark);
            padding: 20px;
            text-align: center;
        }
        
        .empty-state i {
            font-size: 4rem;
            opacity: 0.2;
            margin-bottom: 20px;
        }
        
        .hidden-notice {
            display: flex; 
            height: 100%; 
            align-items: center; 
            justify-content: center;
            color: var(--text-secondary); 
            font-style: italic; 
            font-size: 1rem; 
            text-align: center;
            padding: 20px;
            background: var(--whatsapp-dark-2);
            border-radius: 10px;
            margin: 20px;
        }

        .typing-indicator { 
            color: var(--whatsapp-blue); 
            font-weight: 500; 
            font-style: italic; 
            animation: blink 1.5s infinite; 
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        @keyframes blink { 
            0% { opacity: 1; } 
            50% { opacity: 0.5; } 
            100% { opacity: 1; } 
        }
        
        .typing-dots {
            display: inline-flex;
            gap: 2px;
        }
        
        .typing-dots span {
            width: 4px;
            height: 4px;
            background: var(--whatsapp-blue);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }
        
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: var(--whatsapp-green-light);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 10000;
            display: none;
            animation: slideIn 0.3s ease;
            max-width: 350px;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .edit-mode {
            background: rgba(245, 158, 11, 0.1) !important;
            border: 1px solid var(--warning) !important;
        }
        
        .edit-input {
            display: flex;
            gap: 8px;
            margin-top: 5px;
            flex-direction: column;
        }
        
        .edit-input textarea {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid var(--warning);
            border-radius: 8px;
            font-size: 0.9rem;
            outline: none;
            background: var(--whatsapp-dark-3);
            color: var(--text-primary);
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }
        
        .edit-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .edit-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .edit-save {
            background: var(--success);
            color: white;
        }
        
        .edit-save:hover {
            background: #008069;
        }
        
        .edit-cancel {
            background: var(--whatsapp-dark-4);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .edit-cancel:hover {
            background: var(--whatsapp-dark-3);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(3px);
        }
        
        .modal-content {
            background: var(--whatsapp-dark-3);
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-title {
            color: var(--text-primary);
            margin: 0;
            font-size: 1.1rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }
        
        .modal-close:hover {
            background: var(--whatsapp-dark-4);
            color: var(--text-primary);
        }
        
        .add-quick-reply-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .add-quick-reply-form input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--whatsapp-dark-4);
            color: var(--text-primary);
            font-size: 0.9rem;
            outline: none;
        }
        
        .add-quick-reply-form button {
            background: var(--whatsapp-green-light);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: 0.3s;
        }
        
        .add-quick-reply-form button:hover {
            background: var(--whatsapp-green);
        }
        
        .quick-replies-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .quick-reply-item {
            background: var(--whatsapp-dark-4);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .quick-reply-text {
            flex: 1;
            color: var(--text-primary);
            font-size: 0.9rem;
            padding-right: 10px;
        }
        
        .quick-reply-item-actions {
            display: flex;
            gap: 5px;
        }
        
        .quick-reply-item-btn {
            background: var(--whatsapp-dark-3);
            border: none;
            color: var(--text-secondary);
            width: 30px;
            height: 30px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }
        
        .quick-reply-item-btn:hover {
            background: var(--whatsapp-blue);
            color: white;
        }
        
        .quick-reply-item-btn.delete:hover {
            background: var(--danger);
        }
        
        .escalation-tag {
            background: var(--danger);
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 12px;
            margin-right: 5px;
            font-weight: 500;
        }
        
        @media (max-width: 1200px) {
            .users-sidebar {
                width: 320px;
            }
        }
        
        @media (max-width: 992px) {
            body {
                flex-direction: column;
            }
            
            .users-sidebar {
                width: 100%;
                height: 40vh;
                border-left: none;
                border-bottom: 1px solid var(--border-color);
            }
            
            .chat-area {
                height: 60vh;
            }
        }
        
        @media (max-width: 768px) {
            .chat-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .header-btns {
                width: 100%;
                overflow-x: auto;
                padding-bottom: 5px;
            }
            
            .btn {
                font-size: 0.7rem;
                padding: 6px 10px;
            }
            
            .external-upload-btn {
                display: flex !important;
            }
            
            .chat-input-wrap {
                gap: 8px;
            }
            
            .emoji-btn, .attach-btn {
                width: 32px;
                height: 32px;
                font-size: 1rem;
            }
            
            .external-upload-panel {
                width: 90%;
                right: 5%;
                bottom: 85px;
            }
            
            #emojiPickerContainer {
                width: 90%;
                right: 5%;
                bottom: 85px;
            }
        }
        
        @media (max-width: 576px) {
            .users-sidebar {
                height: 50vh;
            }
            
            .chat-area {
                height: 50vh;
            }
            
            .chat-messages {
                padding: 10px;
            }
            
            .msg-row {
                max-width: 85%;
            }
            
            .external-upload-panel {
                width: 95%;
                right: 2.5%;
            }
            
            #emojiPickerContainer {
                width: 95%;
                right: 2.5%;
            }
        }
    </style>
</head>
<body>

    <div id="notification" class="notification"></div>
    <div id="modalOverlay" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="add-quick-reply-form">
                <input type="text" id="newQuickReplyInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯ Ø³Ø±ÙŠØ¹ Ø¬Ø¯ÙŠØ¯...">
                <button onclick="addQuickReply()">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
            <div class="quick-replies-list" id="quickRepliesList">
                <!-- Quick replies will be loaded here -->
            </div>
        </div>
    </div>
    <audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3" preload="auto"></audio>

    <div class="users-sidebar">
        <div class="sidebar-header">
            <h4 style="margin:0; font-weight:600; color:var(--text-primary);">
                <i class="fas fa-headset" style="margin-left:8px; color:var(--whatsapp-blue);"></i> 
                Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª
            </h4>
            <button class="sidebar-refresh-btn" onclick="refreshSidebar(this)" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>

        <div class="sidebar-search-wrap">
            <div class="search-input-inner">
                <i class="fas fa-search"></i>
                <input type="text" id="sidebarSearchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø­Ø§Ø¯Ø«Ø©..." oninput="loadChats()">
            </div>
        </div>

        <div class="sidebar-tabs">
            <div class="tab active" id="tabActive" onclick="switchTab('active')">
                <span>ğŸ’¬ Ø§Ù„Ù†Ø´Ø·Ø©</span>
                <span class="tab-badge" id="activeCount">0</span>
            </div>
            <div class="tab" id="tabEscalated" onclick="switchTab('escalated')">
                <span>âš ï¸ Ø§Ù„Ù…ØµØ¹Ø¯Ø©</span>
                <span class="tab-badge" id="escalatedCount">0</span>
            </div>
            <div class="tab" id="tabArchived" onclick="switchTab('archived')">
                <span>ğŸ“ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</span>
                <span class="tab-badge" id="archivedCount">0</span>
            </div>
        </div>
        <div class="user-list" id="userList"></div>
    </div>

    <div class="chat-area">
        <div id="chatContent" style="display: none; flex-direction: column; height: 100%;">
            <div class="chat-header">
                <div class="user-header-info">
                    <div class="user-avatar" id="userAvatar">
                        <!-- Avatar will be generated from first letter -->
                    </div>
                    <div class="header-text-info">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <strong id="currentUserName">--</strong>
                            <span id="currentUserDisplayId" style="font-size:0.75rem;"></span>
                        </div>
                        <div id="statusIndicator">
                            <span class="status-dot" id="statusDot"></span>
                            <span id="statusText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                        </div>
                    </div>
                </div>

                <div class="chat-search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="chatSearchInput" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©..." oninput="handleChatSearch()">
                </div>

                <div class="header-btns">
                    <button class="btn btn-refresh" onclick="refreshChat()" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©">
                        <i class="fas fa-sync-alt"></i>
                        <span>ØªØ­Ø¯ÙŠØ«</span>
                    </button>
                    <button class="btn btn-quick-replies" onclick="toggleQuickReplies()" title="Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠØ¹Ø©">
                        <i class="fas fa-reply"></i>
                        <span>Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</span>
                    </button>
                    <button class="btn btn-end" onclick="endChatOfficial()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Ø¥Ù†Ù‡Ø§Ø¡</span>
                    </button>
                    <button class="btn btn-delete-mine" onclick="deleteAllMyMessages()">
                        <i class="fas fa-trash"></i>
                        <span>Ø­Ø°Ù Ø±Ø³Ø§Ø¦Ù„ÙŠ</span>
                    </button>
                    <button class="btn btn-delete-all" onclick="deleteFullConversation()">
                        <i class="fas fa-trash-alt"></i>
                        <span>Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</span>
                    </button>
                </div>
            </div>

            <div class="quick-replies-panel" id="quickRepliesPanel">
                <div class="quick-replies-header">
                    <h4>ğŸ’¬ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</h4>
                    <button class="manage-quick-replies-btn" onclick="openManageQuickReplies()">
                        <i class="fas fa-cog"></i>
                        <span>Ø¥Ø¯Ø§Ø±Ø©</span>
                    </button>
                </div>
                <div id="quickRepliesContent">
                    <!-- Quick replies will be loaded here -->
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØªØ¹Ø±Ø¶ Ù‡Ù†Ø§ -->
            </div>

            <div class="chat-input-wrap">
                <div id="emojiPickerContainer" onclick="event.stopPropagation()"></div>

                <button class="emoji-btn" onclick="toggleEmojiPicker(event)">
                    <i class="far fa-smile"></i>
                </button>

                <button class="attach-btn" onclick="document.getElementById('fileInput').click()" title="Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù">
                    <i class="fas fa-paperclip"></i>
                </button>
                
                <button class="external-upload-btn" onclick="toggleExternalUploadPanel(event)" title="Ø±ÙØ¹ Ù…Ù„Ù Ø®Ø§Ø±Ø¬ÙŠ">
                    <i class="fas fa-cloud-upload-alt"></i>
                </button>
                
                <input type="file" id="fileInput" onchange="handleFileUpload(this)" accept="image/*,video/*,.pdf,.doc,.docx,.txt">

                <input type="text" id="adminInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." onkeypress="handleInputKeyPress(event)">
                
                <button class="send-btn" onclick="sendReply()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <div class="empty-state" id="emptyState">
            <i class="fas fa-comments"></i>
            <p style="font-size:1.1rem; margin:10px 0 5px 0; color:var(--text-primary);">Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</p>
            <p style="font-size:0.9rem; color:var(--text-secondary);">Ø­Ø¯Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</p>
        </div>
    </div>

<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAVSzkDLqi1G-hpfEPqvBMmuyYRfEuaTKk",
        authDomain: "vipclub-1d04a.firebaseapp.com",
        databaseURL: "https://vipclub-1d04a-default-rtdb.firebaseio.com",
        projectId: "vipclub-1d04a",
        storageBucket: "vipclub-1d04a.firebasestorage.app",
        messagingSenderId: "120667552740",
        appId: "1:120667552740:web:02085765fd43eb0080e5f1"
    };

    // Initialize Firebase
    let database;
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    database = firebase.database();

    // Global Variables
    let activeUserId = null;
    let currentTab = 'active';
    let isDisplayHidden = false;
    let editingMsgId = null;
    let messagesListener = null;
    let chatsListener = null;
    let userStatusListener = null;
    let messagesMap = new Map();
    let adminTypingTimeout = null;
    let quickReplies = [
        "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¯Ø¹Ù… VipClub! ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ",
        "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ ÙˆØ³ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙƒ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª.",
        "Ù‡Ù„ ÙŠÙ…ÙƒÙ†Ùƒ ØªÙˆØ¶ÙŠØ­ Ù…Ø´ÙƒÙ„ØªÙƒ Ø¨Ø´ÙƒÙ„ Ø£ÙƒØ«Ø± ØªÙØµÙŠÙ„Ø§Ù‹ØŸ",
        "ØªÙ… Ø­Ù„ Ù…Ø´ÙƒÙ„ØªÙƒØŒ Ù‡Ù„ Ù‡Ù†Ø§Ùƒ Ø´ÙŠØ¡ Ø¢Ø®Ø± ØªØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠÙ‡ØŸ",
        "ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÙŠÙ†Ù…Ø§ Ø£ØªØ­Ù‚Ù‚ Ù…Ù† Ø·Ù„Ø¨Ùƒ.",
        "Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙˆØ§ØµÙ„Ùƒ Ù…Ø¹Ù†Ø§ØŒ Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ ÙŠÙˆÙ…Ø§Ù‹ Ø³Ø¹ÙŠØ¯Ø§Ù‹!",
        "Ù‡Ù„ ØªØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø´ÙŠØ¡ Ù…Ø­Ø¯Ø¯ØŸ",
        "ØªÙ… ØªØµØ¹ÙŠØ¯ Ø·Ù„Ø¨Ùƒ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§.",
        "Ù‡Ù„ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØ¶Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©ØŸ",
        "Ø³Ø£ÙƒÙˆÙ† Ù…Ø¹Ùƒ Ø®Ù„Ø§Ù„ Ù„Ø­Ø¸Ø§ØªØŒ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ù†ØªØ¸Ø±."
    ];

    // Load quick replies from Firebase
    async function loadQuickReplies() {
        try {
            const snapshot = await database.ref('quickReplies').once('value');
            if (snapshot.exists()) {
                const savedReplies = snapshot.val();
                if (Array.isArray(savedReplies)) {
                    quickReplies = savedReplies;
                }
            }
            renderQuickReplies();
        } catch (error) {
            console.error('Error loading quick replies:', error);
            renderQuickReplies();
        }
    }

    // Save quick replies to Firebase
    async function saveQuickReplies() {
        try {
            await database.ref('quickReplies').set(quickReplies);
            showNotification('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠØ¹Ø©', 'success');
        } catch (error) {
            console.error('Error saving quick replies:', error);
            showNotification('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø±Ø¯ÙˆØ¯', 'error');
        }
    }

    // Render quick replies
    function renderQuickReplies() {
        const container = document.getElementById('quickRepliesContent');
        const panelContent = document.getElementById('quickRepliesContent');
        
        if (!container && !panelContent) return;
        
        const target = panelContent || container;
        target.innerHTML = '';
        
        quickReplies.forEach((reply, index) => {
            const btn = document.createElement('button');
            btn.className = 'quick-reply-btn';
            btn.innerHTML = `
                ${reply}
                <div class="quick-reply-actions">
                    <button class="quick-reply-action-btn" onclick="editQuickReply(${index}, event)">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="quick-reply-action-btn" onclick="deleteQuickReply(${index}, event)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            btn.onclick = () => useQuickReply(reply);
            target.appendChild(btn);
        });
    }

    // Open manage quick replies modal
    function openManageQuickReplies() {
        const modal = document.getElementById('modalOverlay');
        const list = document.getElementById('quickRepliesList');
        
        list.innerHTML = '';
        quickReplies.forEach((reply, index) => {
            const item = document.createElement('div');
            item.className = 'quick-reply-item';
            item.innerHTML = `
                <div class="quick-reply-text">${reply}</div>
                <div class="quick-reply-item-actions">
                    <button class="quick-reply-item-btn" onclick="editQuickReplyInModal(${index})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="quick-reply-item-btn delete" onclick="deleteQuickReplyFromModal(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            list.appendChild(item);
        });
        
        modal.style.display = 'flex';
        document.getElementById('quickRepliesPanel').style.display = 'none';
    }

    // Close modal
    function closeModal() {
        document.getElementById('modalOverlay').style.display = 'none';
        document.getElementById('newQuickReplyInput').value = '';
    }

    // Add quick reply
    async function addQuickReply() {
        const input = document.getElementById('newQuickReplyInput');
        const text = input.value.trim();
        
        if (!text) {
            showNotification('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ù„Ù„Ø±Ø¯', 'warning');
            return;
        }
        
        quickReplies.push(text);
        await saveQuickReplies();
        renderQuickReplies();
        input.value = '';
        showNotification('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø±ÙŠØ¹', 'success');
    }

    // Edit quick reply
    function editQuickReply(index, event) {
        event.stopPropagation();
        const newText = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø±ÙŠØ¹:', quickReplies[index]);
        if (newText !== null && newText.trim() !== '') {
            quickReplies[index] = newText.trim();
            saveQuickReplies();
            renderQuickReplies();
            showNotification('âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø±ÙŠØ¹', 'success');
        }
    }

    function editQuickReplyInModal(index) {
        const newText = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø±ÙŠØ¹:', quickReplies[index]);
        if (newText !== null && newText.trim() !== '') {
            quickReplies[index] = newText.trim();
            saveQuickReplies();
            openManageQuickReplies(); // Refresh the modal
            showNotification('âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø±ÙŠØ¹', 'success');
        }
    }

    // Delete quick reply
    function deleteQuickReply(index, event) {
        event.stopPropagation();
        if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø±ÙŠØ¹ØŸ')) {
            quickReplies.splice(index, 1);
            saveQuickReplies();
            renderQuickReplies();
            showNotification('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø±ÙŠØ¹', 'success');
        }
    }

    function deleteQuickReplyFromModal(index) {
        if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø±ÙŠØ¹ØŸ')) {
            quickReplies.splice(index, 1);
            saveQuickReplies();
            openManageQuickReplies(); // Refresh the modal
            showNotification('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø±ÙŠØ¹', 'success');
        }
    }

    // ====== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªØ«Ø¨ÙŠØª Ù†Ø§ÙØ°Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© ======
    function toggleExternalUploadPanel(e) {
        e.stopPropagation();
        closeAllMenus();
        closeEmojiPicker();
        document.getElementById('quickRepliesPanel').style.display = 'none';
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
        let uploadPanel = document.getElementById('externalUploadPanel');
        if (!uploadPanel) {
            uploadPanel = document.createElement('div');
            uploadPanel.className = 'external-upload-panel';
            uploadPanel.id = 'externalUploadPanel';
            uploadPanel.innerHTML = `
                <h4 style="margin-bottom: 15px; text-align: center; color:var(--text-primary);">ğŸ“ Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø®Ø§Ø±Ø¬ÙŠØ©</h4>
                <button class="external-upload-btn-panel" onclick="window.open('https://ufile.io/', '_blank')">
                    <i class="fas fa-cloud-upload-alt" style="color: #4CAF50;"></i>
                    <span>Ø±ÙØ¹ Ø¹Ù„Ù‰ UFile.io</span>
                    <i class="fas fa-external-link-alt"></i>
                </button>
                <button class="external-upload-btn-panel" onclick="window.open('https://gofile.io/', '_blank')">
                    <i class="fas fa-file-upload" style="color: #2196F3;"></i>
                    <span>Ø±ÙØ¹ Ø¹Ù„Ù‰ GoFile.io</span>
                    <i class="fas fa-external-link-alt"></i>
                </button>
                <div class="external-link-input">
                    <input type="text" id="externalLinkInput" placeholder="Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ Ù‡Ù†Ø§...">
                    <button onclick="sendExternalLink()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(uploadPanel);
        }
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø²Ø± Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
        const emojiBtn = document.querySelector('.emoji-btn');
        const emojiBtnRect = emojiBtn.getBoundingClientRect();
        
        // ØªØ­Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø©
        if (uploadPanel.style.display === 'block') {
            uploadPanel.style.display = 'none';
            document.querySelector('.external-upload-btn').classList.remove('active');
        } else {
            // Ø¶Ø¨Ø· Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ù†ÙØ³ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
            uploadPanel.style.display = 'block';
            uploadPanel.style.position = 'fixed';
            uploadPanel.style.bottom = (window.innerHeight - emojiBtnRect.top + 50) + 'px';
            uploadPanel.style.right = (window.innerWidth - emojiBtnRect.right - 20) + 'px';
            uploadPanel.style.zIndex = '10000';
            
            document.querySelector('.external-upload-btn').classList.add('active');
            
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
            setTimeout(() => {
                const closeOnClickOutside = (e) => {
                    if (!uploadPanel.contains(e.target) && 
                        !e.target.closest('.external-upload-btn') &&
                        !e.target.closest('#emojiPickerContainer') &&
                        !e.target.closest('#quickRepliesPanel')) {
                        uploadPanel.style.display = 'none';
                        document.querySelector('.external-upload-btn').classList.remove('active');
                        document.removeEventListener('click', closeOnClickOutside);
                    }
                };
                document.addEventListener('click', closeOnClickOutside);
            }, 10);
        }
    }

    function updateExternalUploadBtn() {
        const btn = document.querySelector('.external-upload-btn');
        const panel = document.getElementById('externalUploadPanel');
        if (panel && panel.style.display === 'block') {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    }

    function closeExternalUploadPanel() {
        const panel = document.getElementById('externalUploadPanel');
        if (panel) {
            panel.style.display = 'none';
        }
        updateExternalUploadBtn();
    }

    function toggleEmojiPicker(e) {
        e.stopPropagation();
        const container = document.getElementById('emojiPickerContainer');
        const panel = document.getElementById('quickRepliesPanel');
        
        container.style.display = container.style.display === 'block' ? 'none' : 'block';
        panel.style.display = 'none';
        closeExternalUploadPanel();
        closeAllMenus();
    }

    function closeEmojiPicker() {
        document.getElementById('emojiPickerContainer').style.display = 'none';
    }

    function toggleQuickReplies() {
        const panel = document.getElementById('quickRepliesPanel');
        const emojiPanel = document.getElementById('emojiPickerContainer');
        
        panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        emojiPanel.style.display = 'none';
        closeExternalUploadPanel();
        closeAllMenus();
    }

    function useQuickReply(text) {
        const input = document.getElementById('adminInput');
        input.value = text;
        input.focus();
        document.getElementById('quickRepliesPanel').style.display = 'none';
        setAdminTyping(true);
    }

    function closeAllMenus() {
        const menus = document.querySelectorAll('.msg-options-menu');
        menus.forEach(menu => menu.remove());
    }

    // Set admin typing status
    function setAdminTyping(isTyping) {
        if (!activeUserId) return;
        
        if (adminTypingTimeout) {
            clearTimeout(adminTypingTimeout);
        }
        
        if (isTyping) {
            database.ref('chats').child(activeUserId).update({
                adminTyping: true,
                adminTypingTime: new Date().toISOString()
            }).catch(error => {
                console.error('Error setting typing status:', error);
            });
            
            adminTypingTimeout = setTimeout(() => {
                setAdminTyping(false);
            }, 3000);
        } else {
            database.ref('chats').child(activeUserId).update({
                adminTyping: false
            }).catch(error => {
                console.error('Error clearing typing status:', error);
            });
        }
    }

    // File Upload Functions
    async function handleFileUpload(input) {
        if (!input || !activeUserId) return;
        const file = input.files[0];
        if (!file) return;
        
        if (file.size > 2 * 1024 * 1024) {
            showNotification('âš ï¸ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø£Ù‚Ù„ Ù…Ù† 2 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª.', 'warning');
            return;
        }
        
        const reader = new FileReader();
        let fileType = 'file';
        if (file.type.startsWith('image/')) fileType = 'image';
        else if (file.type.startsWith('video/')) fileType = 'video';
        
        reader.onload = async function(e) {
            const fileData = e.target.result;
            await sendMessage('admin', fileData, fileType, file.name);
            input.value = ''; 
        };
        reader.readAsDataURL(file);
    }

    async function sendExternalLink() {
        const linkInput = document.getElementById('externalLinkInput');
        const link = linkInput.value.trim();
        
        if (!link) {
            showNotification('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· ØµØ­ÙŠØ­', 'warning');
            return;
        }
        
        if (!link.startsWith('http')) {
            showNotification('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· ØµØ­ÙŠØ­ ÙŠØ¨Ø¯Ø£ Ø¨Ù€ http Ø£Ùˆ https', 'warning');
            return;
        }
        
        await sendMessage('admin', link, 'text');
        linkInput.value = '';
        closeExternalUploadPanel();
    }

    // Chat Management Functions
    async function sendMessage(sender = 'admin', text, type = 'text', fileName = null) {
        if (!activeUserId || !text) {
            console.log('Cannot send message: missing activeUserId or text');
            return;
        }

        const msgObj = { 
            id: Date.now(), 
            sender: sender, 
            text: text, 
            type: type, 
            fileName: fileName, 
            time: new Date().toISOString(),
            isEdited: false,
            isDeleted: false,
            isRead: false, // Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£Ø¯Ù…Ù† ØªÙƒÙˆÙ† ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            hiddenForAdmin: false
        };

        try {
            const msgRef = database.ref('chats').child(activeUserId).child('messages').push();
            const messageKey = msgRef.key;
            await msgRef.set({
                ...msgObj,
                firebaseKey: messageKey
            });
            
            // Ø¹Ù†Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ø¯Ù…Ù†ØŒ Ù†Ø²ÙŠØ¯ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if (sender === 'admin') {
                await database.ref('chats').child(activeUserId).update({
                    lastActivity: new Date().toISOString(),
                    unreadCount: firebase.database.ServerValue.increment(1),
                    adminTyping: false
                });
            } else {
                // Ø¹Ù†Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©)
                await database.ref('chats').child(activeUserId).update({
                    lastActivity: new Date().toISOString(),
                    adminTyping: false
                });
            }

            playNotificationSound();
            
            if (sender === 'admin') {
                document.getElementById('adminInput').value = '';
                setAdminTyping(false);
            }
            
        } catch (error) {
            console.error('Error sending message:', error);
            showNotification('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 'error');
        }
    }

    // ====== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ======
    async function markAllMessagesAsRead(userId) {
        if (!userId) return;
        
        try {
            const messagesRef = database.ref('chats').child(userId).child('messages');
            const snapshot = await messagesRef.once('value');
            
            if (!snapshot.exists()) return;
            
            const updates = {};
            const now = new Date().toISOString();
            
            snapshot.forEach((childSnapshot) => {
                const msg = childSnapshot.val();
                // ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø· Ù„ØªØµØ¨Ø­ Ù…Ù‚Ø±ÙˆØ¡Ø©
                if (msg.sender === 'admin' && !msg.isRead) {
                    updates[`${childSnapshot.key}/isRead`] = true;
                    updates[`${childSnapshot.key}/readAt`] = now;
                    
                    // ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    database.ref('chats').child(userId).child('messages').child(childSnapshot.key).update({
                        isRead: true,
                        readAt: now
                    }).catch(e => console.log('Error updating read status:', e));
                }
            });
            
            if (Object.keys(updates).length > 0) {
                await messagesRef.update(updates);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                await database.ref('chats').child(userId).update({
                    unreadCount: 0,
                    lastSeen: now
                });
            }
            
        } catch (error) {
            console.error('Error marking messages as read:', error);
        }
    }

    // ====== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© openChat Ù„ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¨Ø§Ø´Ø±Ø© ======
    async function openChat(userId) {
        if (messagesListener) {
            database.ref('chats').child(activeUserId).child('messages').off('value', messagesListener);
            messagesListener = null;
        }
        
        if (userStatusListener) {
            database.ref('chats').child(activeUserId).off('value', userStatusListener);
            userStatusListener = null;
        }

        activeUserId = userId;
        editingMsgId = null;
        
        closeEmojiPicker();
        closeExternalUploadPanel();
        closeAllMenus();
        document.getElementById('quickRepliesPanel').style.display = 'none';

        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('chatContent').style.display = 'flex';
        
        try {
            const chatSnapshot = await database.ref('chats').child(userId).once('value');
            const chatData = chatSnapshot.val();
            
            if (!chatData) {
                showNotification('âŒ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
                return;
            }
            
            const displayName = chatData.username || 'Ù…Ø³ØªØ®Ø¯Ù…';
            const cleanUserId = userId.replace('user_', '');
            document.getElementById('currentUserName').innerText = displayName;
            document.getElementById('currentUserDisplayId').innerText = `(${cleanUserId})`;
            
            const avatar = document.getElementById('userAvatar');
            if (avatar) {
                const firstLetter = displayName.charAt(0).toUpperCase();
                avatar.textContent = firstLetter;
            }
            
            updateCurrentUserStatus(chatData);
            
        } catch (error) {
            console.log('Error loading user info:', error);
            const displayName = 'Ù…Ø³ØªØ®Ø¯Ù…';
            const cleanUserId = userId.replace('user_', '');
            document.getElementById('currentUserName').innerText = displayName;
            document.getElementById('currentUserDisplayId').innerText = `(${cleanUserId})`;
            
            const avatar = document.getElementById('userAvatar');
            if (avatar) {
                const firstLetter = displayName.charAt(0).toUpperCase();
                avatar.textContent = firstLetter;
            }
        }
        
        document.getElementById('chatSearchInput').value = "";
        document.getElementById('adminInput').value = '';
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ
        userStatusListener = database.ref('chats').child(userId).on('value', (snapshot) => {
            const chatData = snapshot.val();
            if (chatData) {
                updateCurrentUserStatus(chatData);
            }
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        await markAllMessagesAsRead(userId);
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©
        await loadMessages(userId);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
        loadChats();
    }

    // Load messages
    async function loadMessages(userId) {
        try {
            if (messagesListener) {
                database.ref('chats').child(activeUserId).child('messages').off('value', messagesListener);
                messagesListener = null;
            }
            
            const messagesRef = database.ref('chats').child(userId).child('messages');
            
            messagesListener = messagesRef.on('value', (snapshot) => {
                try {
                    const messages = [];
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const msgData = childSnapshot.val();
                            if (msgData && !msgData.hiddenForAdmin) {
                                messages.push({
                                    firebaseKey: childSnapshot.key,
                                    ...msgData
                                });
                            }
                        });
                    }
                    
                    messages.sort((a, b) => new Date(a.time) - new Date(b.time));
                    
                    renderMessages(messages);
                    
                } catch (renderError) {
                    console.error('Error rendering messages:', renderError);
                    showNotification('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„', 'error');
                }
            }, (error) => {
                console.error('Error listening to messages:', error);
                showNotification('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„', 'error');
            });
            
        } catch (error) {
            console.error('Error setting up messages listener:', error);
            showNotification('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„', 'error');
        }
    }

    // Render messages
    function renderMessages(messages) {
        if (isDisplayHidden) {
            const container = document.getElementById('chatMessages');
            if (container) {
                container.innerHTML = `<div class="hidden-notice">
                    <div>
                        <i class="fas fa-eye-slash fa-3x" style="opacity:0.2; display:block; margin-bottom:10px;"></i>
                        Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø®ÙÙŠ Ø§Ù„Ø¢Ù†.<br>
                        <small>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¹ÙŠÙ† Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Øµ.</small>
                    </div>
                </div>`;
            }
            return;
        }
        
        if (!activeUserId) return;
        
        const container = document.getElementById('chatMessages');
        const chatSearchKeyword = document.getElementById('chatSearchInput').value.toLowerCase().trim();

        if (!container) return;
        
        container.innerHTML = '';
        
        messagesMap.clear();
        
        if (!messages || messages.length === 0) {
            container.innerHTML += `
                <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fas fa-comments fa-3x" style="opacity: 0.2;"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯</p>
                </div>
            `;
            return;
        }
        
        messages.forEach((msg) => {
            if (!msg || msg.hiddenForAdmin) return;
            
            const row = createMessageElement(msg, chatSearchKeyword);
            container.appendChild(row);
            messagesMap.set(msg.firebaseKey, { row, msg });
        });

        container.scrollTop = container.scrollHeight;
    }

    // Create message element
    function createMessageElement(msg, chatSearchKeyword) {
        const row = document.createElement('div');
        row.className = `msg-row ${msg.sender}`;
        row.id = `msg-${msg.firebaseKey}`;

        let content = "";
        
        if (msg.isDeleted) {
            content = `<span style="color:var(--text-secondary); font-style:italic;">
                <i class="fas fa-ban"></i> ØªÙ… Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            </span>`;
        } else {
            if (msg.type === 'image') {
                content = `<img src="${msg.text}" style="max-width: 100%; border-radius: 8px; cursor: pointer;" 
                       onclick="window.open('${msg.text}', '_blank')" alt="ØµÙˆØ±Ø©">`;
            } else if (msg.type === 'video') {
                content = `<video src="${msg.text}" controls style="max-width: 100%; border-radius: 8px;"></video>`;
            } else if (msg.type === 'file') {
                content = `
                    <a href="${msg.text}" download="${msg.fileName || 'file'}" class="file-attachment">
                        <i class="fas fa-file-download fa-2x" style="color:var(--whatsapp-blue)"></i>
                        <div style="overflow:hidden">
                            <div style="font-weight:bold; font-size:0.8rem; white-space:nowrap; text-overflow:ellipsis;">
                                ${msg.fileName || 'ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù'}
                            </div>
                            <small style="opacity:0.7">Ø§Ø¶ØºØ· Ù„Ù„ØªØ­Ù…ÙŠÙ„</small>
                        </div>
                    </a>`;
            } else {
                let displayText = msg.text || "";
                const urlPattern = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
                displayText = displayText.replace(urlPattern, function(url) {
                    return `<a href="${url}" target="_blank" style="color:inherit; text-decoration:underline;">${url}</a>`;
                });
                
                if (chatSearchKeyword !== "" && displayText.toLowerCase().includes(chatSearchKeyword)) {
                    const regex = new RegExp(`(${chatSearchKeyword})`, 'gi');
                    displayText = displayText.replace(regex, `<span class="highlight">$1</span>`);
                }
                content = `<span>${displayText}</span>`;
            }
        }

        // ====== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ======
        let readStatus = '';
        if (msg.sender === 'admin') {
            // Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£Ø¯Ù…Ù†: ØªØ¸Ù‡Ø± Ø¹Ù„Ø§Ù…Ø© Ø²Ø±Ù‚Ø§Ø¡ Ø¥Ø°Ø§ Ù‚Ø±Ø£Ù‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if (msg.isRead) {
                readStatus = '<i class="fas fa-check-double read-check"></i>';
            } else {
                readStatus = '<i class="fas fa-check unread-check"></i>';
            }
        }

        const statusTags = `
            <div style="display:flex; align-items:center; justify-content:flex-end; gap:4px; margin-top:2px;">
                ${msg.isEdited ? '<span class="msg-status-tag">Ù…Ø¹Ø¯Ù„Ø©</span>' : ''}
                <small style="font-size:0.65rem; opacity:0.7; color:${msg.sender === 'admin' ? 'rgba(255,255,255,0.7)' : 'var(--text-secondary)'}">
                    ${formatTime(msg.time)}
                </small>
                ${readStatus}
            </div>
        `;

        let optionsButton = '';
        if (!msg.isDeleted && (msg.sender === 'admin' || msg.sender === 'user')) {
            optionsButton = `
                <div class="msg-options-trigger" onclick="showMessageMenu(event, '${msg.firebaseKey}', '${msg.sender}', '${msg.text ? msg.text.replace(/'/g, "\\'") : ''}')">
                    <i class="fas fa-ellipsis-v"></i>
                </div>
            `;
        }

        row.innerHTML = `
            ${msg.sender === 'admin' ? '' : optionsButton}
            <div class="msg ${msg.sender}" id="message-content-${msg.firebaseKey}">
                <div id="message-text-${msg.firebaseKey}">
                    ${content}
                </div>
                ${statusTags}
            </div>
            ${msg.sender === 'admin' ? optionsButton : ''}
        `;
        
        return row;
    }

    // Show message options menu
    function showMessageMenu(event, messageId, sender, messageText) {
        event.stopPropagation();
        
        closeAllMenus();
        
        const menu = document.createElement('div');
        menu.className = 'msg-options-menu';
        menu.style.left = event.clientX + 'px';
        menu.style.top = event.clientY + 'px';
        
        let menuItems = '';
        
        if (sender === 'admin' && messageText && !messageText.includes('ØªÙ… Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©')) {
            menuItems += `
                <div class="msg-option edit" onclick="editMessage('${messageId}', '${messageText.replace(/'/g, "\\'")}')">
                    <i class="fas fa-edit"></i>
                    <span>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</span>
                </div>
            `;
        }
        
        menuItems += `
            <div class="msg-option delete-for-me" onclick="deleteForMe('${messageId}')">
                <i class="fas fa-user-slash"></i>
                <span>Ø­Ø°Ù Ù…Ù† Ø´Ø§Ø´ØªÙŠ</span>
            </div>
            <div class="msg-option delete-for-all" onclick="deleteForAll('${messageId}')">
                <i class="fas fa-trash-alt"></i>
                <span>Ø­Ø°Ù Ù„Ù„Ø¬Ù…ÙŠØ¹</span>
            </div>
        `;
        
        menu.innerHTML = menuItems;
        document.body.appendChild(menu);
        menu.style.display = 'block';
        
        setTimeout(() => {
            document.addEventListener('click', function closeMenu(e) {
                if (!menu.contains(e.target) && !e.target.closest('.msg-options-trigger')) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            });
        }, 10);
    }

    // Edit message
    function editMessage(messageId, currentText) {
        closeAllMenus();
        
        editingMsgId = messageId;
        
        const messageContent = document.getElementById(`message-content-${messageId}`);
        const messageTextDiv = document.getElementById(`message-text-${messageId}`);
        
        if (!messageContent || !messageTextDiv) return;
        
        const originalHTML = messageTextDiv.innerHTML;
        
        messageContent.classList.add('edit-mode');
        messageTextDiv.innerHTML = `
            <div class="edit-input">
                <textarea id="editInput_${messageId}" rows="2">${currentText}</textarea>
                <div class="edit-buttons">
                    <button class="edit-btn edit-save" onclick="saveMessageEdit('${messageId}')">
                        <i class="fas fa-check"></i> Ø­ÙØ¸
                    </button>
                    <button class="edit-btn edit-cancel" onclick="cancelEditMessage('${messageId}', '${originalHTML.replace(/'/g, "\\'")}')">
                        <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
            </div>
        `;
        
        setTimeout(() => {
            const editInput = document.getElementById(`editInput_${messageId}`);
            if (editInput) {
                editInput.focus();
                editInput.select();
            }
        }, 100);
    }

    // Cancel edit
    function cancelEditMessage(messageId, originalHTML) {
        const messageContent = document.getElementById(`message-content-${messageId}`);
        const messageTextDiv = document.getElementById(`message-text-${messageId}`);
        
        if (messageContent && messageTextDiv) {
            messageContent.classList.remove('edit-mode');
            if (originalHTML) {
                messageTextDiv.innerHTML = originalHTML;
            }
        }
        
        editingMsgId = null;
    }

    // Save message edit
    async function saveMessageEdit(messageId) {
        const editInput = document.getElementById(`editInput_${messageId}`);
        if (!editInput) return;
        
        const newText = editInput.value.trim();
        
        if (!newText) {
            showNotification('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ±Ùƒ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙØ§Ø±ØºØ©', 'warning');
            return;
        }
        
        try {
            const msgData = messagesMap.get(messageId);
            const originalTime = msgData?.msg?.time || new Date().toISOString();
            
            await database.ref('chats').child(activeUserId).child('messages').child(messageId).update({
                text: newText,
                isEdited: true,
                time: originalTime
            });
            
            const messageContent = document.getElementById(`message-content-${messageId}`);
            const messageTextDiv = document.getElementById(`message-text-${messageId}`);
            
            if (messageContent && messageTextDiv) {
                messageContent.classList.remove('edit-mode');
                
                const urlPattern = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
                const linkedText = newText.replace(urlPattern, function(url) {
                    return `<a href="${url}" target="_blank" style="color:inherit; text-decoration:underline;">${url}</a>`;
                });
                
                messageTextDiv.innerHTML = `<span>${linkedText}</span>`;
                
                const statusTags = messageContent.querySelector('small')?.parentElement;
                if (statusTags) {
                    const statusTagElement = statusTags.querySelector('.msg-status-tag');
                    if (!statusTagElement) {
                        const statusTag = document.createElement('span');
                        statusTag.className = 'msg-status-tag';
                        statusTag.innerHTML = 'Ù…Ø¹Ø¯Ù„Ø©';
                        statusTags.insertBefore(statusTag, statusTags.querySelector('small'));
                    }
                }
            }
            
            if (messagesMap.has(messageId)) {
                const msg = messagesMap.get(messageId).msg;
                msg.text = newText;
                msg.isEdited = true;
            }
            
            editingMsgId = null;
            showNotification('âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            
        } catch (error) {
            console.error('Error saving edit:', error);
            showNotification('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 'error');
        }
    }

    // Delete for me
    async function deleteForMe(messageId) {
        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø´Ø§Ø´ØªÙƒ ÙÙ‚Ø·ØŸ')) return;
        
        try {
            await database.ref('chats').child(activeUserId).child('messages').child(messageId).update({
                hiddenForAdmin: true
            });
            
            const row = document.getElementById(`msg-${messageId}`);
            if (row) {
                row.style.display = 'none';
            }
            
            showNotification('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø´Ø§Ø´ØªÙƒ', 'success');
        } catch (error) {
            console.error('Error deleting for me:', error);
            showNotification('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 'error');
        }
    }

    // Delete for all
    async function deleteForAll(messageId) {
        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„Ø·Ø±ÙÙŠÙ†ØŸ')) return;
        
        try {
            await database.ref('chats').child(activeUserId).child('messages').child(messageId).update({
                isDeleted: true,
                text: "ØªÙ… Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©"
            });
            
            const messageTextDiv = document.getElementById(`message-text-${messageId}`);
            if (messageTextDiv) {
                messageTextDiv.innerHTML = `
                    <span style="color:var(--text-secondary); font-style:italic;">
                        <i class="fas fa-ban"></i> ØªÙ… Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                    </span>`;
                
                const optionsTrigger = document.querySelector(`#msg-${messageId} .msg-options-trigger`);
                if (optionsTrigger) {
                    optionsTrigger.style.display = 'none';
                }
            }
            
            showNotification('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹', 'success');
        } catch (error) {
            console.error('Error deleting for all:', error);
            showNotification('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 'error');
        }
    }

    // Delete all my messages
    async function deleteAllMyMessages() {
        if (!activeUserId) return;
        
        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø±Ø³Ø§Ø¦Ù„Ùƒ Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù† Ø´Ø§Ø´ØªÙƒ ÙÙ‚Ø·ØŸ')) return;
        
        try {
            const messagesRef = database.ref('chats').child(activeUserId).child('messages');
            const snapshot = await messagesRef.once('value');
            
            const updates = {};
            snapshot.forEach((childSnapshot) => {
                const msg = childSnapshot.val();
                if (msg.sender === 'admin' && !msg.hiddenForAdmin) {
                    updates[`${childSnapshot.key}/hiddenForAdmin`] = true;
                    
                    const row = document.getElementById(`msg-${childSnapshot.key}`);
                    if (row) {
                        row.style.display = 'none';
                    }
                }
            });
            
            if (Object.keys(updates).length > 0) {
                await messagesRef.update(updates);
                showNotification('âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø±Ø³Ø§Ø¦Ù„Ùƒ Ù…Ù† Ø´Ø§Ø´ØªÙƒ', 'success');
            } else {
                showNotification('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø®Ø§ØµØ© Ø¨Ùƒ Ù„Ø­Ø°ÙÙ‡Ø§', 'info');
            }
        } catch (error) {
            console.error('Error deleting all my messages:', error);
            showNotification('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„', 'error');
        }
    }

    function handleInputKeyPress(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendReply();
        } else {
            setAdminTyping(true);
        }
    }

    async function sendReply() {
        const input = document.getElementById('adminInput');
        const text = input.value.trim();
        
        if (!text || !activeUserId) {
            if (!text) {
                showNotification('âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø±Ø³Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹', 'warning');
            }
            return;
        }
        
        if (editingMsgId !== null) {
            try {
                await saveMessageEdit(editingMsgId);
            } catch (error) {
                showNotification('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 'error');
            }
        } else {
            await sendMessage('admin', text, 'text');
        }
        
        input.value = '';
        setAdminTyping(false);
    }

    async function toggleArchive(userId, e) {
        e.stopPropagation();
        try {
            const chatRef = database.ref('chats').child(userId);
            const snapshot = await chatRef.once('value');
            const chatData = snapshot.val() || {};
            
            await chatRef.update({
                isArchived: !chatData.isArchived,
                isHidden: false
            });
            
            showNotification(chatData.isArchived ? 'âœ… ØªÙ… Ø¥Ø®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ' : 'âœ… ØªÙ… Ø£Ø±Ø´ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©', 'success');
            loadChats();
        } catch (error) {
            console.error('Error toggling archive:', error);
            showNotification('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ø´ÙŠÙ', 'error');
        }
    }

    function hideDisplay(userId, e) {
        e.stopPropagation();
        
        isDisplayHidden = !isDisplayHidden;
        
        if (activeUserId === userId) {
            loadMessages(userId);
        }
        
        showNotification(isDisplayHidden ? 'âœ… ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©' : 'âœ… ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©', 'success');
        
        loadChats();
    }

    async function endChatOfficial() {
        if (!activeUserId) {
            showNotification('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…Ø­Ø§Ø¯Ø«Ø© Ø£ÙˆÙ„Ø§Ù‹', 'warning');
            return;
        }
        
        if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨Ø´ÙƒÙ„ Ø±Ø³Ù…ÙŠØŸ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù†Ù‡Ø§Ø¡ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù….")) return;
        
        try {
            await sendMessage('admin', "ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù† Ø®Ù„Ø§Ù„ ÙØ±ÙŠÙ‚ Ø§Ù„Ø¯Ø¹Ù…. Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒÙ….", 'text');
            
            await database.ref('chats').child(activeUserId).update({
                isArchived: true,
                isHidden: false
            });
            
            showNotification('âœ… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ£Ø±Ø´ÙØªÙ‡Ø§', 'success');
            
            loadChats();
            
        } catch (error) {
            console.error('Error ending chat:', error);
            showNotification('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©', 'error');
        }
    }

    async function deleteFullConversation() {
        if (!activeUserId) {
            showNotification('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…Ø­Ø§Ø¯Ø«Ø© Ø£ÙˆÙ„Ø§Ù‹', 'warning');
            return;
        }
        
        if (!confirm("ØªØ­Ø°ÙŠØ±: Ø­Ø°Ù ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹! Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ±Ø¬Ø§Ø¹Ù‡Ø§.")) return;
        
        try {
            const messagesRef = database.ref('chats').child(activeUserId).child('messages');
            await messagesRef.remove();
            
            await database.ref('chats').child(activeUserId).remove();
            
            const cleanUserId = activeUserId.replace('user_', '');
            await database.ref('users').child(cleanUserId).remove();
            
            activeUserId = null;
            document.getElementById('chatContent').style.display = 'none';
            document.getElementById('emptyState').style.display = 'flex';
            
            showNotification('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹', 'success');
            
            loadChats();
            
        } catch (error) {
            console.error('Error deleting conversation:', error);
            showNotification('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©', 'error');
        }
    }

    function refreshChat() {
        if (activeUserId) {
            if (messagesListener) {
                database.ref('chats').child(activeUserId).child('messages').off('value', messagesListener);
                messagesListener = null;
            }
            
            loadMessages(activeUserId);
            showNotification('ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©...', 'info');
        }
    }

    function copyToClipboard(text, event) {
        event.stopPropagation();
        navigator.clipboard.writeText(text).then(() => {
            const icon = event.target;
            const originalClass = icon.className;
            icon.className = 'fas fa-check';
            icon.style.color = 'var(--success)';
            setTimeout(() => {
                icon.className = originalClass;
                icon.style.color = '';
            }, 1500);
        }).catch(err => {
            console.error('Error copying to clipboard:', err);
            showNotification('âŒ ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ù†Øµ', 'error');
        });
    }

    function handleChatSearch() {
        if (activeUserId) {
            loadMessages(activeUserId);
        }
    }

    // ====== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ ======
    function updateCurrentUserStatus(chatData) {
        if (!chatData) return;
        
        const statusIndicator = document.getElementById('statusIndicator');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        
        if (!statusIndicator || !statusDot || !statusText) return;
        
        const isOnline = chatData.isOnline || false;
        const lastSeen = chatData.lastSeen || null;
        const isTyping = chatData.isTyping || false;
        
        if (isTyping) {
            statusText.innerHTML = '<span class="typing-indicator">ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†<span class="typing-dots"><span></span><span></span><span></span></span></span>';
            statusDot.className = 'status-dot status-online';
            statusDot.style.backgroundColor = 'var(--whatsapp-blue)';
        } else if (isOnline === true) {
            statusText.textContent = 'Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†';
            statusDot.className = 'status-dot status-online';
            statusDot.style.backgroundColor = 'var(--online)';
        } else if (lastSeen) {
            const lastSeenTime = new Date(lastSeen);
            const now = new Date();
            const diffMinutes = Math.floor((now - lastSeenTime) / (1000 * 60));
            
            if (diffMinutes < 5) {
                statusText.textContent = 'Ù†Ø´Ø· Ø§Ù„Ø¢Ù†';
                statusDot.className = 'status-dot status-online';
                statusDot.style.backgroundColor = 'var(--online)';
            } else {
                statusText.textContent = `Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± Ù…Ù†Ø° ${diffMinutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
                statusDot.className = 'status-dot status-offline';
                statusDot.style.backgroundColor = 'var(--offline)';
            }
        } else {
            statusText.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
            statusDot.className = 'status-dot status-offline';
            statusDot.style.backgroundColor = 'var(--offline)';
        }
    }

    // Load chats function
    async function loadChats() {
        try {
            if (chatsListener) {
                database.ref('chats').off('value', chatsListener);
                chatsListener = null;
            }
            
            chatsListener = database.ref('chats').on('value', 
                (snapshot) => {
                    try {
                        const chats = snapshot.val() || {};
                        renderUserList(chats);
                    } catch (renderError) {
                        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª:', renderError);
                        showNotification('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª', 'error');
                    }
                }, 
                (error) => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª:', error);
                    showNotification('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                }
            );
            
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª:', error);
            showNotification('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©', 'error');
        }
    }

    // Render user list function
    function renderUserList(chats) {
        const userListDiv = document.getElementById('userList');
        const searchKeyword = document.getElementById('sidebarSearchInput').value.toLowerCase().trim();
        
        if (!userListDiv) return;
        
        userListDiv.innerHTML = '';
        
        let userIds = Object.keys(chats);
        
        let activeCount = 0;
        let escalatedCount = 0;
        let archivedCount = 0;

        let filteredIds = userIds.filter(id => {
            const chat = chats[id];
            if (!chat) return false;
            
            if (chat.isArchived) {
                archivedCount++;
            } else if (chat.isEscalated && !chat.isHidden) {
                escalatedCount++;
            } else if (!chat.isHidden) {
                activeCount++;
            }

            if (currentTab === 'archived') {
                if (!chat.isArchived) return false;
            } else if (currentTab === 'escalated') {
                if (!chat.isEscalated || chat.isArchived || chat.isHidden) return false;
            } else {
                if (chat.isArchived || chat.isHidden || chat.isEscalated) return false;
            }

            if (searchKeyword === "") return true;
            
            const nameMatch = (chat.username || '').toLowerCase().includes(searchKeyword);
            const idMatch = id.toLowerCase().includes(searchKeyword);
            
            let contentMatch = false;
            if (chat.messages) {
                const messages = Object.values(chat.messages);
                contentMatch = messages.some(m => 
                    m && m.text && typeof m.text === 'string' && m.text.toLowerCase().includes(searchKeyword)
                );
            }
            
            return nameMatch || idMatch || contentMatch;
        });

        document.getElementById('activeCount').textContent = activeCount;
        document.getElementById('escalatedCount').textContent = escalatedCount;
        document.getElementById('archivedCount').textContent = archivedCount;

        filteredIds.sort((a, b) => {
            const tA = new Date(chats[a]?.lastActivity || 0);
            const tB = new Date(chats[b]?.lastActivity || 0);
            return tB - tA;
        });

        if (filteredIds.length === 0) {
            const message = currentTab === 'archived' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ' :
                           currentTab === 'escalated' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù…ØµØ¹Ø¯Ø©' :
                           searchKeyword ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø­Ø«' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù†Ø´Ø·Ø©';
            
            userListDiv.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fas fa-comments fa-3x" style="opacity: 0.2;"></i>
                    <p style="margin-top: 15px;">${message}</p>
                </div>
            `;
            return;
        }

        filteredIds.forEach(userId => {
            try {
                const chatData = chats[userId];
                if (!chatData) return;
                
                const messages = chatData.messages ? Object.values(chatData.messages) : [];
                const lastMsg = messages[messages.length - 1];
                const unreadCount = chatData.unreadCount || 0;
                const isTyping = chatData.isTyping || false;
                
                const isOnline = chatData.isOnline || false;
                const lastSeen = chatData.lastSeen || null;

                let lastMsgPrefix = "";
                if (lastMsg) {
                    lastMsgPrefix = lastMsg.sender === 'admin' ? "Ø£Ù†Øª: " : `${chatData.username || 'Ù…Ø³ØªØ®Ø¯Ù…'}: `;
                }

                const userItem = document.createElement('div');
                userItem.className = `user-item ${chatData.isEscalated ? 'escalated' : ''} ${chatData.isArchived ? 'archived' : ''} ${activeUserId === userId ? 'active' : ''}`;
                userItem.onclick = () => openChat(userId);

                const displayName = chatData.username || 'Ù…Ø³ØªØ®Ø¯Ù…';
                
                let statusText = 'ØºÙŠØ± Ù…ØªØµÙ„';
                let statusClass = 'status-offline';
                
                if (isOnline === true) {
                    statusText = 'Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†';
                    statusClass = 'status-online';
                } else if (lastSeen) {
                    const lastSeenTime = new Date(lastSeen);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - lastSeenTime) / (1000 * 60));
                    
                    if (diffMinutes < 5) {
                        statusText = 'Ù†Ø´Ø· Ø§Ù„Ø¢Ù†';
                        statusClass = 'status-online';
                    } else {
                        statusText = `Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± Ù…Ù†Ø° ${diffMinutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
                        statusClass = 'status-offline';
                    }
                } else {
                    statusText = 'ØºÙŠØ± Ù…ØªØµÙ„';
                    statusClass = 'status-offline';
                }

                const cleanUserId = userId.replace('user_', '');
                
                userItem.innerHTML = `
                    <div class="item-actions">
                        <i class="fas ${chatData.isArchived ? 'fa-inbox' : 'fa-archive'} action-icon" 
                           title="${chatData.isArchived ? 'Ø¥Ø®Ø±Ø§Ø¬ Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ' : 'Ø£Ø±Ø´ÙØ©'}" 
                           onclick="toggleArchive('${userId}', event)"></i>
                        <i class="fas ${isDisplayHidden ? 'fa-eye' : 'fa-eye-slash'} action-icon" 
                           title="${isDisplayHidden ? 'Ø¥Ø¸Ù‡Ø§Ø±' : 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Øµ'}" 
                           onclick="hideDisplay('${userId}', event)"></i>
                    </div>
                    <div class="user-info-row">
                        <div class="user-name-container">
                            <span class="user-nickname">${displayName}</span>
                            ${chatData.isEscalated ? '<span class="escalation-tag">Ù…ØµØ¹Ø¯</span>' : ''}
                            <span class="user-id-tag">
                                ${cleanUserId}
                                <i class="fas fa-copy copy-id-btn" title="Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù" onclick="copyToClipboard('${cleanUserId}', event)"></i>
                            </span>
                        </div>
                        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:4px;">
                            <small style="font-size:0.7rem; color:var(--text-secondary);">
                                ${lastMsg ? formatTime(lastMsg.time) : ''}
                            </small>
                            ${unreadCount > 0 ? `<span style="background:var(--danger); color:white; font-size:0.7rem; min-width:18px; height:18px; border-radius:10px; display:flex; align-items:center; justify-content:center; padding:0 5px; font-weight:bold;">${unreadCount}</span>` : ''}
                        </div>
                    </div>
                    <div style="font-size:0.8rem; color:var(--text-secondary); margin-top:4px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                        ${isTyping ? 
                            '<span class="typing-indicator">ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†...</span>' : 
                            `<span style="font-weight: 500; color: var(--text-muted);">${lastMsgPrefix}</span>
                             ${lastMsg ? (lastMsg.isDeleted ? 'ğŸš« ØªÙ… Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©' : 
                                        (lastMsg.type === 'text' || !lastMsg.type ? 
                                         (lastMsg.text || '').substring(0, 35) + ((lastMsg.text || '').length > 35 ? '...' : '') : 
                                         'ğŸ“ ÙˆØ³Ø§Ø¦Ø·')) : 'Ù…Ø­Ø§Ø¯Ø«Ø© ÙØ§Ø±ØºØ©'}`
                        }
                    </div>
                    <div class="user-status">
                        <span class="status-indicator ${statusClass}"></span>
                        <span>${statusText}</span>
                    </div>
                `;
                userListDiv.appendChild(userItem);
            } catch (error) {
                console.error(`Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ù…Ø­Ø§Ø¯Ø«Ø© ${userId}:`, error);
            }
        });

        if (activeUserId && chats[activeUserId]) {
            updateCurrentUserStatus(chats[activeUserId]);
        }
    }

    // Refresh sidebar function
    function refreshSidebar(btn) {
        const icon = btn.querySelector('i');
        icon.classList.add('rotate-anim');
        
        if (chatsListener) {
            database.ref('chats').off('value', chatsListener);
            chatsListener = null;
        }
        
        loadChats();
        
        setTimeout(() => { 
            icon.classList.remove('rotate-anim'); 
        }, 600);
    }

    function switchTab(tab) {
        currentTab = tab;
        document.getElementById('tabActive').classList.toggle('active', tab === 'active');
        document.getElementById('tabEscalated').classList.toggle('active', tab === 'escalated');
        document.getElementById('tabArchived').classList.toggle('active', tab === 'archived');
        loadChats();
    }

    function formatTime(isoStr) {
        try {
            const d = new Date(isoStr);
            return d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2, '0');
        } catch (e) {
            return '--:--';
        }
    }

    function playNotificationSound() {
        try {
            const sound = document.getElementById('notifSound');
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.log("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª: ", e));
            }
        } catch (error) {
            console.log('Error playing sound:', error);
        }
    }

    function showNotification(message, type = 'info') {
        const notification = document.getElementById('notification');
        if (!notification) return;
        
        notification.textContent = message;
        notification.style.background = type === 'error' ? 'var(--danger)' : 
                                      type === 'warning' ? 'var(--warning)' : 
                                      type === 'success' ? 'var(--success)' : 'var(--whatsapp-green-light)';
        notification.style.display = 'block';
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }

    // Initialize Emoji Picker
    try {
        const pickerOptions = { 
            onEmojiSelect: (emoji) => {
                const input = document.getElementById('adminInput');
                input.value += emoji.native;
                input.focus();
                setAdminTyping(true);
            },
            locale: 'ar',
            theme: 'dark',
            set: 'apple',
            previewPosition: 'none',
            skinTonePosition: 'none'
        };
        
        const picker = new EmojiMart.Picker(pickerOptions);
        document.getElementById('emojiPickerContainer').appendChild(picker);
    } catch (e) {
        console.log('Emoji picker failed to load:', e);
    }

    // Initialize
    window.onload = function() {
        loadChats();
        loadQuickReplies();
        showNotification('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª', 'success');
    };

    // Cleanup on unload
    window.onbeforeunload = function() {
        if (messagesListener && activeUserId) {
            database.ref('chats').child(activeUserId).child('messages').off('value', messagesListener);
        }
        if (chatsListener) {
            database.ref('chats').off('value', chatsListener);
        }
        if (userStatusListener && activeUserId) {
            database.ref('chats').child(activeUserId).off('value', userStatusListener);
        }
        setAdminTyping(false);
    };
</script>
</body>
</html>