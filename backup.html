<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="images//videoslogo/vip.png">
    <title>ğŸ‘‘ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© VIP Club</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo h1 {
            color: #333;
            font-size: 28px;
            font-weight: 800;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
        
        /* Ø§Ù„Ø¨Ø­Ø« */
        .search-container {
            flex: 1;
            min-width: 300px;
            position: relative;
        }
        
        .search-box {
            width: 100%;
            padding: 12px 20px 12px 45px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }
        
        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-info {
            background: #3b82f6;
            color: white;
        }
        
        /* Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-top: 20px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        
        thead {
            background: #667eea;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            padding: 15px;
            color: white;
            font-weight: 600;
            text-align: right;
            border-bottom: 2px solid #5a67d8;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            text-align: center;
            transition: background-color 0.2s ease;
        }
        
        tr:hover td {
            background: #f8fafc;
        }
        
        .banned-row {
            background-color: #fff5f5 !important;
        }
        
        /* Ø®Ù„Ø§ÙŠØ§ Ø®Ø§ØµØ© */
        .user-id {
            background: linear-gradient(90deg, #4f46e5, #8b5cf6);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            letter-spacing: 1px;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }
        
        .username {
            font-weight: bold;
            color: #333;
        }
        
        .password {
            font-family: monospace;
            background: #f1f5f9;
            padding: 5px 10px;
            border-radius: 5px;
            color: #4338ca;
            font-weight: bold;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-active {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-banned {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* Ø£Ø±ØµØ¯Ø© */
        .balance-cell {
            font-weight: bold;
            padding: 6px 10px;
            border-radius: 6px;
            display: inline-block;
            min-width: 80px;
        }
        
        .balance-egp {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        
        .balance-usd {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }
        
        /* Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© */
        .user-info-tooltip {
            position: relative;
            display: inline-block;
        }
        
        .user-info-tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            right: 50%;
            transform: translateX(50%);
            background: #334155;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: pre-line;
            z-index: 1000;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Ø£ÙØ¹Ø§Ù„ */
        .actions {
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 6px 10px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 3px;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        
        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(3px);
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalFadeIn 0.3s ease;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal h2 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }
        
        /* Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: alertSlideIn 0.3s ease;
        }
        
        @keyframes alertSlideIn {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .alert-info {
            background: #e0f2fe;
            color: #0369a1;
            border: 1px solid #bae6fd;
        }
        
        /* Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Ø¥Ø´Ø¹Ø§Ø± Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ */
        .new-user-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(90deg, #10b981, #34d399);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1001;
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© */
        .section-title {
            margin: 20px 0 10px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
            color: #4f46e5;
            font-size: 18px;
            font-weight: 600;
        }
        
        .row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .row .form-group {
            flex: 1;
        }
        
        .balance-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .balance-input {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .balance-input input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        /* Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø°ÙˆÙÙŠÙ† */
        .deleted-section {
            margin-top: 30px;
            background: #fef2f2;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #fecaca;
            animation: sectionFadeIn 0.5s ease;
        }
        
        @keyframes sectionFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .deleted-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .deleted-table th {
            background: #ef4444;
            padding: 10px;
            color: white;
            font-size: 12px;
        }
        
        .deleted-table td {
            padding: 8px;
            font-size: 12px;
            border-bottom: 1px solid #fee2e2;
        }
        
        .deleted-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .status-permanent {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status-temporary {
            background: #fef3c7;
            color: #92400e;
        }
        
        /* ÙÙ„ØªØ± */
        .filter-container {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }
        
        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #64748b;
        }
        
        .quick-actions {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª */
        .icon-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .gender-icon {
            font-size: 14px;
        }
        
        .country-flag {
            font-size: 14px;
            margin-left: 5px;
        }
        
        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¹Ø§Ù… */
        .password-container {
            position: relative;
            display: inline-block;
        }
        
        .toggle-password {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 12px;
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }
        
        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 10px;
        }
        
        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: #4f46e5;
        }
        
        /* ØªØ®ØµÙŠØµ Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #5a67d8;
        }
        
        /* Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø£ÙØ¶Ù„ */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .search-container {
                width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .quick-actions {
                justify-content: center;
            }
            
            .filter-container {
                flex-direction: column;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .modal-content {
                padding: 20px;
            }
            
            .row {
                flex-direction: column;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
                gap: 3px;
            }
            
            .action-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Ø¥Ø´Ø¹Ø§Ø± Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ -->
    <div id="newUserNotification" class="new-user-notification">
        ğŸ‘¤ <strong>ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯!</strong>
        <div id="newUserInfo" style="font-size: 12px; margin-top: 5px;"></div>
    </div>
    
    <div class="container">
        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">ğŸ‘‘</div>
                <h1>VIP Club - Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
            </div>
            
            <div class="search-container">
                <div class="search-icon">ğŸ”</div>
                <input type="text" id="searchInput" class="search-box" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…..." onkeyup="filterUsers()">
            </div>
            
            <div>
                <button class="btn btn-primary" onclick="loadUsers()">
                    <span>ğŸ”„</span> ØªØ­Ø¯ÙŠØ«
                </button>
                <button class="btn btn-success" onclick="showAddModal()">
                    <span>â•</span> Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…
                </button>
                <button class="btn btn-warning" onclick="showDeletedUsersSection()">
                    <span>ğŸ—‘ï¸</span> Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø°ÙˆÙÙŠÙ†
                </button>
                <button class="btn btn-info" onclick="exportUsersData()">
                    <span>ğŸ“Š</span> ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                </button>
                <button class="btn btn-danger" onclick="goToHome()">
                    <span>ğŸ </span> Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                </button>
            </div>
        </div>
        
        <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-label">ğŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeUsers">0</div>
                <div class="stat-label">âœ… Ù†Ø´Ø·ÙŠÙ†</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="bannedUsers">0</div>
                <div class="stat-label">ğŸš« Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayUsers">0</div>
                <div class="stat-label">ğŸ“… Ù…Ø³Ø¬Ù„ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…</div>
            </div>
        </div>
        
        <!-- Ø£Ø¯ÙˆØ§Øª Ø³Ø±ÙŠØ¹Ø© -->
        <div class="quick-actions">
            <button class="btn btn-primary" onclick="showBalanceUpdateModal()">
                <span>ğŸ’°</span> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±ØµØ¯Ø©
            </button>
            <button class="btn btn-success" onclick="showBulkActionsModal()">
                <span>âš¡</span> Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¬Ù…Ø§Ø¹ÙŠØ©
            </button>
            <button class="btn btn-warning" onclick="showUserActivityReport()">
                <span>ğŸ“ˆ</span> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø·
            </button>
            <button class="btn btn-info" onclick="toggleConnectionInfo()">
                <span>ğŸ”—</span> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
            </button>
            <button class="btn btn-danger" onclick="cleanTestUsers()">
                <span>ğŸ§¹</span> ØªÙ†Ø¸ÙŠÙ ØªØ¬Ø±ÙŠØ¨ÙŠ
            </button>
        </div>
        
        <!-- Ø§Ù„ÙÙ„Ø§ØªØ± -->
        <div class="filter-container">
            <div class="filter-group">
                <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
                <select id="filterStatus" onchange="filterUsers()">
                    <option value="">Ø§Ù„ÙƒÙ„</option>
                    <option value="active">Ù†Ø´Ø·</option>
                    <option value="banned">Ù…Ø­Ø¸ÙˆØ±</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Ø§Ù„Ø¬Ù†Ø³</label>
                <select id="filterGender" onchange="filterUsers()">
                    <option value="">Ø§Ù„ÙƒÙ„</option>
                    <option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option>
                    <option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="filterDateFrom" onchange="filterUsers()">
            </div>
            
            <div class="filter-group">
                <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="filterDateTo" onchange="filterUsers()">
            </div>
            
            <div class="filter-group">
                <label>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ (EGP)</label>
                <input type="number" id="filterMinBalance" placeholder="0" onchange="filterUsers()">
            </div>
            
            <button class="btn btn-primary" onclick="resetFilters()">
                <span>ğŸ”„</span> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†
            </button>
        </div>
        
        <!-- Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ -->
        <div id="alertContainer"></div>
        
        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ -->
        <div id="connectionInfo" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
            <h3 style="margin-bottom: 10px;">ğŸ”— Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</h3>
            <div style="font-family: monospace; font-size: 14px;">
                <div>ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: <span style="color: green">us-central1</span></div>
                <div>ğŸ”— Ø±Ø§Ø¨Ø· Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: <span style="color: blue">https://vipclub-1d04a-default-rtdb.firebaseio.com</span></div>
                <div>âœ… Ø§Ù„Ø­Ø§Ù„Ø©: <span id="connectionStatus" style="color: green">Ø¬Ø§Ø±Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...</span></div>
                <div>ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="liveUserCount">0</span></div>
                <div>â±ï¸ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="lastUpdateTime">---</span></div>
            </div>
        </div>
        
        <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
        <div class="table-container">
            <table id="usersTable">
                <thead>
                    <tr>
                        <th width="100">Ø§Ù„Ù…Ø¹Ø±Ù</th>
                        <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                        <th>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±</th>
                        <th>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</th>
                        <th>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</th>
                        <th width="150">Ø§Ù„Ø±ØµÙŠØ¯</th>
                        <th width="100">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th width="150">Ø§Ù„ØªÙˆØ§ØµÙ„</th>
                        <th width="120">Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                        <th width="250">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="10">
                            <div class="loading">
                                <div class="spinner"></div>
                                <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø°ÙˆÙÙŠÙ† (Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹) -->
        <div id="deletedUsersSection" class="deleted-section" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0; color: #ef4444;">ğŸ—‘ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø°ÙˆÙÙŠÙ†</h3>
                <button class="btn btn-primary" onclick="loadDeletedUsers()">
                    <span>ğŸ”„</span> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                </button>
            </div>
            <table class="deleted-table">
                <thead>
                    <tr>
                        <th width="80">Ø§Ù„Ù…Ø¹Ø±Ù</th>
                        <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                        <th width="150">Ø§Ù„ØªÙˆØ§ØµÙ„</th>
                        <th width="120">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø°Ù</th>
                        <th width="100">Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø°Ù</th>
                        <th width="100">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø°Ù</th>
                        <th width="200">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="deletedUsersBody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px;">
                            Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø°ÙˆÙÙŠÙ†...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <h2>â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h2>
            <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… *</label>
                <input type="text" id="addUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" required>
            </div>
            <div class="form-group">
                <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± *</label>
                <input type="text" id="addPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±</label>
                <input type="text" id="addNickname" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±">
            </div>
            
            <div class="section-title">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</div>
            <div class="row">
                <div class="form-group">
                    <label>Ø§Ù„Ø¬Ù†Ø³</label>
                    <select id="addGender">
                        <option value="">Ø§Ø®ØªØ±...</option>
                        <option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option>
                        <option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¹Ù…Ø±</label>
                    <input type="number" id="addAge" placeholder="Ø§Ù„Ø¹Ù…Ø±" min="1" max="120">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¯ÙˆÙ„Ø©</label>
                    <input type="text" id="addCountry" placeholder="Ø§Ù„Ø¨Ù„Ø¯">
                </div>
            </div>
            
            <div class="form-group">
                <label>Ù†Ø¨Ø°Ø© Ù…Ø®ØªØµØ±Ø©</label>
                <textarea id="addBio" placeholder="Ù†Ø¨Ø°Ø© Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" rows="3"></textarea>
            </div>
            
            <div class="section-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</div>
            <div class="row">
                <div class="form-group">
                    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</label>
                    <input type="email" id="addEmail" placeholder="example@email.com">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</label>
                    <input type="email" id="addEmail2" placeholder="email2@example.com">
                </div>
            </div>
            
            <div class="row">
                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</label>
                    <input type="tel" id="addPhone" placeholder="01012345678" pattern="[0-9]{11}">
                </div>
                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</label>
                    <input type="tel" id="addPhone2" placeholder="01123456789" pattern="[0-9]{11}">
                </div>
            </div>
            
            <div class="section-title">Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©</div>
            <div class="row">
                <div class="form-group">
                    <label>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ (EGP)</label>
                    <input type="number" id="addBalanceEGP" placeholder="0.00" value="0" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ (USD)</label>
                    <input type="number" id="addBalanceUSD" placeholder="0.00" value="0" min="0" step="0.01">
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-success" onclick="addUser()">ğŸ’¾ Ø­ÙØ¸</button>
                <button class="btn btn-danger" onclick="hideAddModal()">âœ– Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>
    
    <!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2>âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…</h2>
            <input type="hidden" id="editUserId">
            
            <div class="section-title">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>
            <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… *</label>
                <input type="text" id="editUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" required>
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±</label>
                <input type="text" id="editNickname" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±">
            </div>
            <div class="form-group">
                <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="text" id="editPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            </div>
            
            <div class="section-title">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</div>
            <div class="row">
                <div class="form-group">
                    <label>Ø§Ù„Ø¬Ù†Ø³</label>
                    <select id="editGender">
                        <option value="">Ø§Ø®ØªØ±...</option>
                        <option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option>
                        <option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¹Ù…Ø±</label>
                    <input type="number" id="editAge" placeholder="Ø§Ù„Ø¹Ù…Ø±" min="1" max="120">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¯ÙˆÙ„Ø©</label>
                    <input type="text" id="editCountry" placeholder="Ø§Ù„Ø¨Ù„Ø¯">
                </div>
            </div>
            
            <div class="form-group">
                <label>Ù†Ø¨Ø°Ø© Ù…Ø®ØªØµØ±Ø©</label>
                <textarea id="editBio" placeholder="Ù†Ø¨Ø°Ø© Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" rows="3"></textarea>
            </div>
            
            <div class="section-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</div>
            <div class="row">
                <div class="form-group">
                    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</label>
                    <input type="email" id="editEmail" placeholder="example@email.com">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</label>
                    <input type="email" id="editEmail2" placeholder="email2@example.com">
                </div>
            </div>
            
            <div class="row">
                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</label>
                    <input type="tel" id="editPhone" placeholder="01012345678" pattern="[0-9]{11}">
                </div>
                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</label>
                    <input type="tel" id="editPhone2" placeholder="01123456789" pattern="[0-9]{11}">
                </div>
            </div>
            
            <div class="section-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø±ØµØ¯Ø©</div>
            <div class="balance-controls">
                <div class="balance-input">
                    <label>Ø±ØµÙŠØ¯ EGP</label>
                    <input type="number" id="editBalanceEGP" placeholder="0.00" step="0.01" min="0">
                </div>
                <div class="balance-input">
                    <label>Ø±ØµÙŠØ¯ USD</label>
                    <input type="number" id="editBalanceUSD" placeholder="0.00" step="0.01" min="0">
                </div>
            </div>
            
            <div class="balance-controls" style="margin-top: 15px;">
                <button class="btn btn-primary" onclick="addToBalance('EGP')" style="flex: 1;">
                    <span>â•</span> Ø¥Ø¶Ø§ÙØ© EGP
                </button>
                <button class="btn btn-success" onclick="addToBalance('USD')" style="flex: 1;">
                    <span>â•</span> Ø¥Ø¶Ø§ÙØ© USD
                </button>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-success" onclick="updateUser()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                <button class="btn btn-danger" onclick="hideEditModal()">âœ– Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>
    
    <!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±ØµØ¯Ø© -->
    <div id="balanceUpdateModal" class="modal">
        <div class="modal-content">
            <h2>ğŸ’° ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ</h2>
            <div class="form-group">
                <label>Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„Ø©</label>
                <select id="bulkCurrency">
                    <option value="EGP">Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ (EGP)</option>
                    <option value="USD">Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ (USD)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
                <select id="bulkOperation">
                    <option value="add">Ø¥Ø¶Ø§ÙØ©</option>
                    <option value="subtract">Ø®ØµÙ…</option>
                    <option value="set">ØªØ¹ÙŠÙŠÙ† Ù‚ÙŠÙ…Ø© Ù…Ø­Ø¯Ø¯Ø©</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
                <input type="number" id="bulkAmount" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label>Ø³Ø¨Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«</label>
                <input type="text" id="bulkReason" placeholder="Ø³Ø¨Ø¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯">
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†</label>
                <div id="selectedUsersCount" style="padding: 10px; background: #f8f9fa; border-radius: 5px; text-align: center;">
                    Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¸Ø§Ù‡Ø±ÙŠÙ†
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-success" onclick="applyBulkBalanceUpdate()">ğŸ’¾ ØªØ·Ø¨ÙŠÙ‚</button>
                <button class="btn btn-danger" onclick="hideBalanceUpdateModal()">âœ– Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>
    
    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© -->
    <div id="bulkActionsModal" class="modal">
        <div class="modal-content">
            <h2>âš¡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©</h2>
            <div class="form-group">
                <label>Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</label>
                <select id="bulkActionType">
                    <option value="ban">Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</option>
                    <option value="unban">ÙÙƒ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</option>
                    <option value="delete_temp">Ø­Ø°Ù Ù…Ø¤Ù‚Øª</option>
                    <option value="send_notification">Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±</option>
                </select>
            </div>
            
            <div id="banReasonSection" style="display: none;">
                <div class="form-group">
                    <label>Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¸Ø±</label>
                    <input type="text" id="bulkBanReason" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¸Ø±">
                </div>
                <div class="form-group">
                    <label>Ù…Ø¯Ø© Ø§Ù„Ø­Ø¸Ø± (Ø£ÙŠØ§Ù…)</label>
                    <input type="number" id="bulkBanDays" placeholder="0 Ù„Ù„Ø¯Ø§Ø¦Ù…" value="7" min="0">
                </div>
            </div>
            
            <div id="notificationSection" style="display: none;">
                <div class="form-group">
                    <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</label>
                    <input type="text" id="bulkNotificationTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±">
                </div>
                <div class="form-group">
                    <label>Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</label>
                    <textarea id="bulkNotificationContent" placeholder="Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±" rows="3"></textarea>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-success" onclick="applyBulkAction()">ğŸ’¾ ØªØ·Ø¨ÙŠÙ‚</button>
                <button class="btn btn-danger" onclick="hideBulkActionsModal()">âœ– Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

<script>
// ğŸ”¥ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase - Realtime Database
const firebaseConfig = {
    apiKey: "AIzaSyAVSzkDLqi1G-hpfEPqvBMmuyYRfEuaTKk",
    authDomain: "vipclub-1d04a.firebaseapp.com",
    databaseURL: "https://vipclub-1d04a-default-rtdb.firebaseio.com",
    projectId: "vipclub-1d04a",
    storageBucket: "vipclub-1d04a.firebasestorage.app",
    messagingSenderId: "120667552740",
    appId: "1:120667552740:web:02085765fd43eb0080e5f1"
};

// Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
let database;
let allUsers = [];
let currentEditingUser = null;
let selectedUsers = [];
let lastUpdateTime = null;
let usersMap = new Map();
let isLoading = false;

// ğŸ”’ Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ ID Ø±Ù‚Ù…ÙŠ ÙØ±ÙŠØ¯
function generateNumericId() {
    const timestamp = Date.now().toString().slice(-6);
    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    return parseInt(timestamp + random);
}

// 1. ØªÙ‡ÙŠØ¦Ø© Firebase Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
function initializeFirebase() {
    try {
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        database = firebase.database();
        
        showAlert('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase Realtime Database', 'success');
        
        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
        testConnection();
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        loadUsers();
        
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯
        listenForNewUsers();
        
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
        listenForUpdates();
        
    } catch (error) {
        showAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message, 'error');
        console.error('Firebase Error:', error);
    }
}

// 2. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
async function testConnection() {
    try {
        const testRef = database.ref('connection_test');
        await testRef.set({
            timestamp: new Date().toISOString(),
            message: 'Ø§ØªØµØ§Ù„ Ù†Ø§Ø¬Ø­ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©',
            admin: true
        });
        
        document.getElementById('connectionStatus').textContent = 'âœ… Ù…ØªØµÙ„';
        document.getElementById('connectionStatus').style.color = 'green';
        
        // Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯
        setTimeout(() => {
            testRef.remove();
        }, 3000);
        
    } catch (error) {
        document.getElementById('connectionStatus').textContent = 'âŒ ØºÙŠØ± Ù…ØªØµÙ„';
        document.getElementById('connectionStatus').style.color = 'red';
        console.error('Connection Test Error:', error);
    }
}

// 3. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯
function listenForNewUsers() {
    if (!database) return;
    
    database.ref('users').on('child_added', (snapshot) => {
        const newUser = snapshot.val();
        const userId = snapshot.key;
        
        if (newUser && newUser.username) {
            console.log('ğŸ‘¤ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯:', newUser.username);
            
            // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±
            showNewUserNotification(newUser);
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ±
            setTimeout(() => {
                loadUsers();
            }, 500);
            
            // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø¥Ø´Ø¹Ø§Ø±
            playNotificationSound();
        }
    });
}

// 4. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
function listenForUserUpdates() {
    if (!database) return;
    
    database.ref('users').on('child_changed', (snapshot) => {
        const updatedUser = snapshot.val();
        const userId = snapshot.key;
        
        if (updatedUser && updatedUser.username) {
            console.log('ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªØ®Ø¯Ù…:', updatedUser.username);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©
            updateUserInTable(userId, updatedUser);
            
            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            const userIndex = allUsers.findIndex(u => u.id === userId);
            if (userIndex !== -1) {
                allUsers[userIndex] = { id: userId, ...updatedUser };
            }
            
            // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«
            lastUpdateTime = new Date();
            document.getElementById('lastUpdateTime').textContent = lastUpdateTime.toLocaleTimeString('ar-EG');
            
            // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ«
            showAlert(`ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${updatedUser.username}`, 'info');
        }
    });
}

// 5. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
function listenForUpdates() {
    if (!database) return;
    
    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    database.ref('users').on('value', (snapshot) => {
        if (snapshot.exists()) {
            const count = Object.keys(snapshot.val()).length;
            document.getElementById('liveUserCount').textContent = count;
        }
    });
    
    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    listenForUserUpdates();
}

// 6. ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©
function updateUserInTable(userId, userData) {
    try {
        const row = document.getElementById(`user-row-${userId}`);
        if (!row) return;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ØµÙ
        const numericIdCell = row.querySelector('.user-id');
        const usernameCell = row.querySelector('.username');
        const nicknameCell = row.cells[2];
        const personalDataCell = row.cells[3];
        const passwordCell = row.querySelector('.password');
        const balanceEGPCell = row.querySelector('.balance-egp');
        const balanceUSDCell = row.querySelector('.balance-usd');
        const statusCell = row.querySelector('.status-badge');
        const contactCell = row.cells[7];
        const dateCell = row.cells[8];
        
        if (numericIdCell) {
            numericIdCell.textContent = (userData.numericId || '').toString().padStart(6, '0');
            numericIdCell.title = `Firebase Key: ${userId}\nNumeric ID: ${userData.numericId}`;
        }
        
        if (usernameCell) usernameCell.textContent = userData.username || '---';
        if (nicknameCell) nicknameCell.textContent = userData.nickname || '---';
        if (passwordCell) passwordCell.textContent = userData.password || '---';
        if (balanceEGPCell) balanceEGPCell.textContent = `${(userData.balanceEGP || 0).toFixed(2)} EGP`;
        if (balanceUSDCell) balanceUSDCell.textContent = `${(userData.balanceUSD || 0).toFixed(2)} USD`;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©
        if (personalDataCell) {
            let genderIcon = userData.gender === 'Ø£Ù†Ø«Ù‰' ? 'ğŸ‘©' : userData.gender === 'Ø°ÙƒØ±' ? 'ğŸ‘¨' : '';
            let ageText = userData.age ? `${userData.age} Ø³Ù†Ø©` : '';
            let countryText = userData.country ? `ğŸ“ ${userData.country}` : '';
            
            personalDataCell.innerHTML = `
                <div class="user-info-tooltip" data-tooltip="Ø§Ù„Ø¬Ù†Ø³: ${userData.gender || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
Ø§Ù„Ø¹Ù…Ø±: ${userData.age || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
Ø§Ù„Ø¨Ù„Ø¯: ${userData.country || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}">
                    <div class="icon-cell">
                        <span class="gender-icon">${genderIcon}</span>
                        ${ageText} 
                        <span class="country-flag">${countryText}</span>
                    </div>
                </div>
            `;
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ§ØµÙ„
        if (contactCell) {
            let phoneHtml = userData.phone ? `<div>ğŸ“± ${userData.phone}</div>` : '<div>ğŸ“± ---</div>';
            let phone2Html = userData.phone2 ? `<div>ğŸ“± ${userData.phone2}</div>` : '';
            let emailHtml = userData.email ? `<div>ğŸ“§ ${userData.email}</div>` : '<div>ğŸ“§ ---</div>';
            let email2Html = userData.email2 ? `<div>ğŸ“§ ${userData.email2}</div>` : '';
            
            contactCell.innerHTML = phoneHtml + phone2Html + emailHtml + email2Html;
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ®
        if (dateCell) {
            if (userData.createdAt) {
                try {
                    dateCell.textContent = new Date(userData.createdAt).toLocaleDateString('ar-EG');
                } catch (e) {
                    dateCell.textContent = userData.createdAt;
                }
            } else {
                dateCell.textContent = '---';
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
        if (statusCell) {
            const isBanned = userData.isBanned === true;
            statusCell.className = `status-badge ${isBanned ? 'status-banned' : 'status-active'}`;
            statusCell.textContent = isBanned ? 'ğŸš« Ù…Ø­Ø¸ÙˆØ±' : 'âœ… Ù†Ø´Ø·';
            
            // ØªØ­Ø¯ÙŠØ« Ù„ÙˆÙ† Ø§Ù„ØµÙ
            if (isBanned) {
                row.classList.add('banned-row');
            } else {
                row.classList.remove('banned-row');
            }
        }
    } catch (error) {
        console.error('Error updating user in table:', error);
    }
}

// 7. Ø¥Ø´Ø¹Ø§Ø± Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
function showNewUserNotification(user) {
    try {
        const notification = document.getElementById('newUserNotification');
        const userInfo = document.getElementById('newUserInfo');
        
        userInfo.innerHTML = `
            ğŸ‘¤ ${user.username} 
            ğŸ”¢ ID: ${user.numericId || 'N/A'}
            ğŸ“… ${new Date(user.createdAt || new Date()).toLocaleTimeString('ar-EG')}
        `;
        
        notification.style.display = 'block';
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, 5000);
    } catch (error) {
        console.error('Notification error:', error);
    }
}

// 8. ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
function playNotificationSound() {
    try {
        const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3');
        audio.volume = 0.3;
        audio.play().catch(e => console.log('Sound not available:', e));
    } catch (e) {
        console.log('Sound not available');
    }
}

// 9. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
async function loadUsers() {
    if (isLoading) return;
    
    isLoading = true;
    const tbody = document.getElementById('tableBody');
    
    if (!database) {
        tbody.innerHTML = '<tr><td colspan="10">âŒ Firebase ØºÙŠØ± Ù…ØªØµÙ„</td></tr>';
        isLoading = false;
        return;
    }
    
    try {
        tbody.innerHTML = `
            <tr>
                <td colspan="10">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</p>
                    </div>
                </td>
            </tr>
        `;
        
        const snapshot = await database.ref('users').once('value');
        allUsers = [];
        usersMap.clear();
        selectedUsers = [];
        let total = 0, active = 0, banned = 0, today = 0;
        const todayDate = new Date().toDateString();
        
        if (snapshot.exists()) {
            const usersData = snapshot.val();
            
            for (const userId in usersData) {
                const userData = usersData[userId];
                
                // ØªØ®Ø·ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠÙ†
                if (userData.username && userData.username.startsWith('test_')) {
                    console.log('ØªØ®Ø·ÙŠ Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ:', userData.username);
                    continue;
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹
                if (usersMap.has(userId)) {
                    console.warn(`âš ï¸ ØªÙ… ØªØ¬Ø§Ù‡Ù„ Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙƒØ±Ø±: ${userId}`);
                    continue;
                }
                
                const user = {
                    id: userId,
                    firebaseKey: userId,
                    numericId: userData.numericId || generateNumericId(),
                    username: userData.username || '',
                    nickname: userData.nickname || '',
                    password: userData.password || '',
                    email: userData.email || '',
                    email2: userData.email2 || '',
                    phone: userData.phone || '',
                    phone2: userData.phone2 || '',
                    gender: userData.gender || '',
                    age: userData.age || '',
                    country: userData.country || '',
                    bio: userData.bio || '',
                    isBanned: userData.isBanned === true,
                    banReason: userData.banReason || '',
                    banExpiry: userData.banExpiry || '',
                    balanceEGP: parseFloat(userData.balanceEGP) || 0,
                    balanceUSD: parseFloat(userData.balanceUSD) || 0,
                    createdAt: userData.createdAt || '',
                    updatedAt: userData.updatedAt || '',
                    lastNicknameChange: userData.lastNicknameChange || ''
                };
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
                usersMap.set(userId, user);
                
                // ØªØ­Ø¯ÙŠØ« numericId Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                if (!userData.numericId) {
                    try {
                        await database.ref('users/' + userId).update({
                            numericId: user.numericId,
                            updatedAt: new Date().toISOString()
                        });
                    } catch (e) {
                        console.error('Error updating numericId:', e);
                    }
                }
                
                allUsers.push(user);
                
                total++;
                if (user.isBanned) banned++; else active++;
                if (user.createdAt && new Date(user.createdAt).toDateString() === todayDate) today++;
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        updateStats(total, active, banned, today);
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        displayUsers(allUsers);
        
        // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«
        lastUpdateTime = new Date();
        document.getElementById('lastUpdateTime').textContent = lastUpdateTime.toLocaleTimeString('ar-EG');
        
        console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allUsers.length} Ù…Ø³ØªØ®Ø¯Ù…`);
        
    } catch (error) {
        console.error('Error loading users:', error);
        tbody.innerHTML = `<tr><td colspan="10">âŒ Ø®Ø·Ø£: ${error.message}</td></tr>`;
        showAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ' + error.message, 'error');
    } finally {
        isLoading = false;
    }
}

// 10. Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
function displayUsers(users) {
    const tbody = document.getElementById('tableBody');
    
    if (!users || users.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" style="text-align: center; padding: 40px;">
                    <div class="empty-state">
                        <span class="empty-state-icon">ğŸ‘¥</span>
                        <h3 style="color: #666; margin-bottom: 10px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                        <p style="color: #999; margin-bottom: 20px;">Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø¹Ø¯</p>
                        <button class="btn btn-success" onclick="showAddModal()">
                            â• Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ù…Ø³ØªØ®Ø¯Ù…
                        </button>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    
    users.forEach(user => {
        const isBanned = user.isBanned === true;
        const statusClass = isBanned ? 'status-banned' : 'status-active';
        const statusText = isBanned ? 'ğŸš« Ù…Ø­Ø¸ÙˆØ±' : 'âœ… Ù†Ø´Ø·';
        const rowClass = isBanned ? 'banned-row' : '';
        
        // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø¸Ø±
        let banInfo = '';
        if (isBanned && user.banReason) {
            banInfo = `<div style="font-size: 11px; color: #991b1b;">${user.banReason}</div>`;
        }
        
        // Ø§Ù„ØªØ§Ø±ÙŠØ®
        let dateDisplay = '---';
        if (user.createdAt) {
            try {
                dateDisplay = new Date(user.createdAt).toLocaleDateString('ar-EG');
            } catch (e) {
                dateDisplay = user.createdAt;
            }
        }
        
        // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©
        let genderIcon = user.gender === 'Ø£Ù†Ø«Ù‰' ? 'ğŸ‘©' : user.gender === 'Ø°ÙƒØ±' ? 'ğŸ‘¨' : '';
        let ageText = user.age ? `${user.age} Ø³Ù†Ø©` : '';
        let countryText = user.country ? `ğŸ“ ${user.country}` : '';
        
        // Ø§Ù„ØªÙˆØ§ØµÙ„
        let contactHtml = '';
        contactHtml += user.phone ? `<div>ğŸ“± ${user.phone}</div>` : '<div>ğŸ“± ---</div>';
        if (user.phone2) contactHtml += `<div>ğŸ“± ${user.phone2}</div>`;
        contactHtml += user.email ? `<div>ğŸ“§ ${user.email}</div>` : '<div>ğŸ“§ ---</div>';
        if (user.email2) contactHtml += `<div>ğŸ“§ ${user.email2}</div>`;
        
        html += `
            <tr class="${rowClass}" id="user-row-${user.id}">
                <td>
                    <div class="user-id" title="Firebase Key: ${user.id}\nNumeric ID: ${user.numericId}">
                        ${user.numericId.toString().padStart(6, '0')}
                    </div>
                </td>
                <td>
                    <div class="username">${user.username || '---'}</div>
                </td>
                <td>${user.nickname || '---'}</td>
                <td>
                    <div class="user-info-tooltip" data-tooltip="Ø§Ù„Ø¬Ù†Ø³: ${user.gender || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
Ø§Ù„Ø¹Ù…Ø±: ${user.age || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
Ø§Ù„Ø¨Ù„Ø¯: ${user.country || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
Ù†Ø¨Ø°Ø©: ${user.bio || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}">
                        <div class="icon-cell">
                            <span class="gender-icon">${genderIcon}</span>
                            ${ageText} 
                            <span class="country-flag">${countryText}</span>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="password">${user.password || '---'}</div>
                </td>
                <td>
                    <div style="display: flex; flex-direction: column; gap: 5px; align-items: center;">
                        <span class="balance-cell balance-egp" title="Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡ Ø§Ù„Ù…ØµØ±ÙŠ">
                            ${(user.balanceEGP || 0).toFixed(2)} EGP
                        </span>
                        <span class="balance-cell balance-usd" title="Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±">
                            ${(user.balanceUSD || 0).toFixed(2)} USD
                        </span>
                    </div>
                </td>
                <td>
                    <div class="status-badge ${statusClass}">${statusText}</div>
                    ${banInfo}
                </td>
                <td>
                    ${contactHtml}
                </td>
                <td>${dateDisplay}</td>
                <td>
                    <div class="actions">
                        <button class="action-btn" style="background: #e0e7ff; color: #3730a3;" onclick="openEditModal('${user.id}')" title="ØªØ¹Ø¯ÙŠÙ„">
                            âœï¸ ØªØ¹Ø¯ÙŠÙ„
                        </button>
                        ${isBanned ? 
                            `<button class="action-btn" style="background: #d1fae5; color: #065f46;" onclick="unbanUser('${user.id}')" title="ÙÙƒ Ø§Ù„Ø­Ø¸Ø±">
                                ğŸ”“ ÙÙƒ Ø­Ø¸Ø±
                            </button>` : 
                            `<button class="action-btn" style="background: #fef3c7; color: #92400e;" onclick="banUser('${user.id}')" title="Ø­Ø¸Ø±">
                                ğŸ”’ Ø­Ø¸Ø±
                            </button>`
                        }
                        <button class="action-btn" style="background: #fee2e2; color: #991b1b;" onclick="deleteUser('${user.id}')" title="Ø­Ø°Ù">
                            ğŸ—‘ï¸ Ø­Ø°Ù
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// 11. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
function updateStats(total, active, banned, today) {
    document.getElementById('totalUsers').textContent = total;
    document.getElementById('activeUsers').textContent = active;
    document.getElementById('bannedUsers').textContent = banned;
    document.getElementById('todayUsers').textContent = today;
}

// 12. Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø©
function filterUsers() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('filterStatus').value;
    const genderFilter = document.getElementById('filterGender').value;
    const dateFrom = document.getElementById('filterDateFrom').value;
    const dateTo = document.getElementById('filterDateTo').value;
    const minBalance = parseFloat(document.getElementById('filterMinBalance').value) || 0;
    
    if (!search && !statusFilter && !genderFilter && !dateFrom && !dateTo && minBalance === 0) {
        displayUsers(allUsers);
        return;
    }
    
    const filtered = allUsers.filter(user => {
        // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù…
        let matchesSearch = true;
        if (search) {
            matchesSearch = (user.username && user.username.toLowerCase().includes(search)) ||
                           (user.nickname && user.nickname.toLowerCase().includes(search)) ||
                           (user.email && user.email.toLowerCase().includes(search)) ||
                           (user.phone && user.phone.includes(search)) ||
                           (user.numericId && user.numericId.toString().includes(search));
        }
        
        // ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©
        let matchesStatus = true;
        if (statusFilter === 'active') {
            matchesStatus = !user.isBanned;
        } else if (statusFilter === 'banned') {
            matchesStatus = user.isBanned === true;
        }
        
        // ÙÙ„ØªØ± Ø§Ù„Ø¬Ù†Ø³
        let matchesGender = true;
        if (genderFilter) {
            matchesGender = user.gender === genderFilter;
        }
        
        // ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®
        let matchesDate = true;
        if (dateFrom || dateTo) {
            if (user.createdAt) {
                try {
                    const userDate = new Date(user.createdAt);
                    const fromDate = dateFrom ? new Date(dateFrom) : null;
                    const toDate = dateTo ? new Date(dateTo + 'T23:59:59') : null;
                    
                    if (fromDate && userDate < fromDate) matchesDate = false;
                    if (toDate && userDate > toDate) matchesDate = false;
                } catch (e) {
                    matchesDate = false;
                }
            } else {
                matchesDate = false;
            }
        }
        
        // ÙÙ„ØªØ± Ø§Ù„Ø±ØµÙŠØ¯
        let matchesBalance = true;
        if (minBalance > 0) {
            matchesBalance = (user.balanceEGP >= minBalance) || (user.balanceUSD >= minBalance);
        }
        
        return matchesSearch && matchesStatus && matchesGender && matchesDate && matchesBalance;
    });
    
    displayUsers(filtered);
}

// 13. Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±
function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterGender').value = '';
    document.getElementById('filterDateFrom').value = '';
    document.getElementById('filterDateTo').value = '';
    document.getElementById('filterMinBalance').value = '';
    displayUsers(allUsers);
}

// 14. Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
function showAddModal() {
    document.getElementById('addModal').style.display = 'flex';
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
    document.getElementById('addUsername').value = '';
    document.getElementById('addPassword').value = '';
    document.getElementById('addNickname').value = '';
    document.getElementById('addEmail').value = '';
    document.getElementById('addEmail2').value = '';
    document.getElementById('addPhone').value = '';
    document.getElementById('addPhone2').value = '';
    document.getElementById('addGender').value = '';
    document.getElementById('addAge').value = '';
    document.getElementById('addCountry').value = '';
    document.getElementById('addBio').value = '';
    document.getElementById('addBalanceEGP').value = '0';
    document.getElementById('addBalanceUSD').value = '0';
}

function hideAddModal() {
    document.getElementById('addModal').style.display = 'none';
}

function showEditModal() {
    document.getElementById('editModal').style.display = 'flex';
}

function hideEditModal() {
    document.getElementById('editModal').style.display = 'none';
    currentEditingUser = null;
}

function showBalanceUpdateModal() {
    document.getElementById('balanceUpdateModal').style.display = 'flex';
}

function hideBalanceUpdateModal() {
    document.getElementById('balanceUpdateModal').style.display = 'none';
}

function showBulkActionsModal() {
    document.getElementById('bulkActionsModal').style.display = 'flex';
    document.getElementById('bulkActionType').value = 'ban';
    document.getElementById('bulkBanReason').value = '';
    document.getElementById('bulkBanDays').value = '7';
    document.getElementById('bulkNotificationTitle').value = '';
    document.getElementById('bulkNotificationContent').value = '';
    updateBulkActionFields();
}

function hideBulkActionsModal() {
    document.getElementById('bulkActionsModal').style.display = 'none';
}

// 15. ØªØ­Ø¯ÙŠØ« Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©
function updateBulkActionFields() {
    const actionType = document.getElementById('bulkActionType').value;
    const banReasonSection = document.getElementById('banReasonSection');
    const notificationSection = document.getElementById('notificationSection');
    
    if (actionType === 'ban') {
        banReasonSection.style.display = 'block';
        notificationSection.style.display = 'none';
    } else if (actionType === 'send_notification') {
        banReasonSection.style.display = 'none';
        notificationSection.style.display = 'block';
    } else {
        banReasonSection.style.display = 'none';
        notificationSection.style.display = 'none';
    }
}

// 16. Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…
async function addUser() {
    const username = document.getElementById('addUsername').value.trim();
    const password = document.getElementById('addPassword').value.trim();
    const nickname = document.getElementById('addNickname').value.trim();
    const email = document.getElementById('addEmail').value.trim();
    const email2 = document.getElementById('addEmail2').value.trim();
    const phone = document.getElementById('addPhone').value.trim();
    const phone2 = document.getElementById('addPhone2').value.trim();
    const gender = document.getElementById('addGender').value;
    const age = document.getElementById('addAge').value;
    const country = document.getElementById('addCountry').value.trim();
    const bio = document.getElementById('addBio').value.trim();
    const balanceEGP = parseFloat(document.getElementById('addBalanceEGP').value) || 0;
    const balanceUSD = parseFloat(document.getElementById('addBalanceUSD').value) || 0;
    
    if (!username || !password) {
        showAlert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'error');
        return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø§ ØªÙ‚Ù„ Ø¹Ù† 6 Ø£Ø­Ø±Ù
    if (password.length < 6) {
        showAlert('âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
        return;
    }
    
    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù…
        const existingUser = allUsers.find(u => u.username.toLowerCase() === username.toLowerCase());
        if (existingUser) {
            showAlert('âš ï¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹', 'error');
            return;
        }
        
        const numericId = generateNumericId();
        const newUserRef = database.ref('users').push();
        
        await newUserRef.set({
            numericId: numericId,
            username: username,
            password: password,
            nickname: nickname || username,
            email: email || '',
            email2: email2 || '',
            phone: phone || '',
            phone2: phone2 || '',
            gender: gender || '',
            age: age || '',
            country: country || '',
            bio: bio || '',
            isBanned: false,
            banExpiry: "",
            banReason: "",
            balanceEGP: balanceEGP,
            balanceUSD: balanceUSD,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        });
        
        showAlert(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${username}" Ø¨Ù†Ø¬Ø§Ø­ (ID: ${numericId})`, 'success');
        hideAddModal();
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ±
        setTimeout(() => {
            loadUsers();
        }, 1000);
        
    } catch (error) {
        console.error('Error adding user:', error);
        showAlert('âŒ Ø®Ø·Ø£: ' + error.message, 'error');
    }
}

// 17. ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
async function openEditModal(userId) {
    const user = allUsers.find(u => u.id === userId);
    if (!user) {
        showAlert('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
        return;
    }
    
    currentEditingUser = user;
    
    document.getElementById('editUserId').value = user.id;
    document.getElementById('editUsername').value = user.username || '';
    document.getElementById('editNickname').value = user.nickname || '';
    document.getElementById('editPassword').value = user.password || '';
    document.getElementById('editEmail').value = user.email || '';
    document.getElementById('editEmail2').value = user.email2 || '';
    document.getElementById('editPhone').value = user.phone || '';
    document.getElementById('editPhone2').value = user.phone2 || '';
    document.getElementById('editGender').value = user.gender || '';
    document.getElementById('editAge').value = user.age || '';
    document.getElementById('editCountry').value = user.country || '';
    document.getElementById('editBio').value = user.bio || '';
    document.getElementById('editBalanceEGP').value = user.balanceEGP || 0;
    document.getElementById('editBalanceUSD').value = user.balanceUSD || 0;
    
    showEditModal();
}

// 18. ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
async function updateUser() {
    if (!currentEditingUser) return;
    
    const userId = document.getElementById('editUserId').value;
    const username = document.getElementById('editUsername').value.trim();
    const nickname = document.getElementById('editNickname').value.trim();
    const password = document.getElementById('editPassword').value.trim();
    const email = document.getElementById('editEmail').value.trim();
    const email2 = document.getElementById('editEmail2').value.trim();
    const phone = document.getElementById('editPhone').value.trim();
    const phone2 = document.getElementById('editPhone2').value.trim();
    const gender = document.getElementById('editGender').value;
    const age = document.getElementById('editAge').value;
    const country = document.getElementById('editCountry').value.trim();
    const bio = document.getElementById('editBio').value.trim();
    const balanceEGP = parseFloat(document.getElementById('editBalanceEGP').value) || 0;
    const balanceUSD = parseFloat(document.getElementById('editBalanceUSD').value) || 0;
    
    if (!username) {
        showAlert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
        return;
    }
    
    try {
        const updates = {
            username: username,
            nickname: nickname || username,
            email: email || '',
            email2: email2 || '',
            phone: phone || '',
            phone2: phone2 || '',
            gender: gender || '',
            age: age || '',
            country: country || '',
            bio: bio || '',
            balanceEGP: balanceEGP,
            balanceUSD: balanceUSD,
            updatedAt: new Date().toISOString()
        };
        
        // ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡Ø§
        if (password && password.length >= 6) {
            updates.password = password;
        }
        
        // Ø¥Ø°Ø§ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±
        if (nickname !== (currentEditingUser.nickname || currentEditingUser.username)) {
            updates.lastNicknameChange = new Date().toISOString();
        }
        
        // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ numericId
        updates.numericId = currentEditingUser.numericId;
        
        await database.ref('users/' + userId).update(updates);
        
        showAlert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
        hideEditModal();
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        setTimeout(() => {
            loadUsers();
        }, 500);
        
    } catch (error) {
        console.error('Error updating user:', error);
        showAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ' + error.message, 'error');
    }
}

// 19. Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯
function addToBalance(currency) {
    if (!currentEditingUser) return;
    
    const amount = prompt(`Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡ (${currency}):`, '0');
    if (amount === null || isNaN(parseFloat(amount))) return;
    
    const numericAmount = parseFloat(amount);
    if (numericAmount <= 0) {
        showAlert('âš ï¸ Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±', 'error');
        return;
    }
    
    const currentBalance = parseFloat(document.getElementById(`editBalance${currency}`).value) || 0;
    document.getElementById(`editBalance${currency}`).value = (currentBalance + numericAmount).toFixed(2);
    
    showAlert(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ${numericAmount} ${currency} Ø¥Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯`, 'success');
}

// 20. Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…
async function banUser(userId) {
    const user = allUsers.find(u => u.id === userId);
    if (!user) return;
    
    const reason = prompt('Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¸Ø±:', 'Ø§Ù†ØªÙ‡Ø§Ùƒ Ø´Ø±ÙˆØ· Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…');
    if (reason === null) return;
    
    const days = prompt('Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¸Ø± (0 Ù„Ù„Ø¯Ø§Ø¦Ù…):', '7');
    if (days === null) return;
    
    let expiry;
    const daysNum = parseInt(days) || 7;
    
    if (daysNum === 0) {
        expiry = 'permanent';
    } else {
        expiry = new Date(Date.now() + daysNum * 86400000).toISOString();
    }
    
    try {
        await database.ref('users/' + userId).update({
            isBanned: true,
            banReason: reason,
            banExpiry: expiry,
            bannedAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        });
        
        showAlert(`âœ… ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${user.username}"`, 'success');
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        setTimeout(() => {
            loadUsers();
        }, 500);
        
    } catch (error) {
        console.error('Error banning user:', error);
        showAlert('âŒ Ø®Ø·Ø£: ' + error.message, 'error');
    }
}

// 21. ÙÙƒ Ø­Ø¸Ø±
async function unbanUser(userId) {
    const user = allUsers.find(u => u.id === userId);
    if (!user) return;
    
    if (!confirm(`ÙÙƒ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${user.username}"ØŸ`)) return;
    
    try {
        await database.ref('users/' + userId).update({
            isBanned: false,
            banReason: '',
            banExpiry: '',
            updatedAt: new Date().toISOString()
        });
        
        showAlert(`âœ… ØªÙ… ÙÙƒ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${user.username}"`, 'success');
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        setTimeout(() => {
            loadUsers();
        }, 500);
        
    } catch (error) {
        console.error('Error unbanning user:', error);
        showAlert('âŒ Ø®Ø·Ø£: ' + error.message, 'error');
    }
}

// 22. Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…
async function deleteUser(userId) {
    const user = allUsers.find(u => u.id === userId);
    if (!user) return;
    
    const deleteType = prompt(`Ù†ÙˆØ¹ Ø§Ù„Ø­Ø°Ù Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… "${user.username}":\n\n1. Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ (Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡)\n2. Ø­Ø°Ù Ù…Ø¤Ù‚Øª (ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡)\n\nØ£Ø¯Ø®Ù„ 1 Ø£Ùˆ 2:`, '2');
    
    if (!deleteType) return;
    
    if (deleteType === '1') {
        // Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ
        if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${user.username}" (ID: ${user.numericId}) Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ\n\nâš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!`)) return;
        
        try {
            // Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
            await database.ref('permanent_deleted_users').push({
                numericId: user.numericId,
                username: user.username,
                email: user.email,
                phone: user.phone,
                balanceEGP: user.balanceEGP,
                balanceUSD: user.balanceUSD,
                deletedAt: new Date().toISOString(),
                deletedBy: 'admin',
                originalFirebaseKey: userId,
                reason: 'Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ'
            });
            
            // Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            await database.ref('users/' + userId).remove();
            
            showAlert(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${user.username}" Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹`, 'success');
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            setTimeout(() => {
                loadUsers();
            }, 500);
            
        } catch (error) {
            console.error('Error deleting user permanently:', error);
            showAlert('âŒ Ø®Ø·Ø£: ' + error.message, 'error');
        }
    } else if (deleteType === '2') {
        // Ø­Ø°Ù Ù…Ø¤Ù‚Øª
        const reason = prompt('Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø°Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):', 'Ø­Ø°Ù Ù…Ø¤Ù‚Øª');
        
        try {
            // Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø°ÙˆÙÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
            await database.ref('deleted_users').push({
                numericId: user.numericId,
                username: user.username,
                email: user.email,
                email2: user.email2,
                phone: user.phone,
                phone2: user.phone2,
                gender: user.gender,
                age: user.age,
                country: user.country,
                bio: user.bio,
                balanceEGP: user.balanceEGP,
                balanceUSD: user.balanceUSD,
                isBanned: user.isBanned,
                banReason: user.banReason,
                banExpiry: user.banExpiry,
                password: user.password,
                createdAt: user.createdAt,
                deletedAt: new Date().toISOString(),
                deletedBy: 'admin',
                originalFirebaseKey: userId,
                reason: reason || 'Ø­Ø°Ù Ù…Ø¤Ù‚Øª'
            });
            
            // Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            await database.ref('users/' + userId).remove();
            
            showAlert(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${user.username}" Ù…Ø¤Ù‚ØªØ§Ù‹`, 'success');
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            setTimeout(() => {
                loadUsers();
            }, 500);
            
        } catch (error) {
            console.error('Error deleting user temporarily:', error);
            showAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨: ' + error.message, 'error');
        }
    }
}

// 23. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠÙ†
async function cleanTestUsers() {
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªÙ†Ø¸ÙŠÙ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠÙ†ØŸ\n\nâš ï¸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† ØªØ¨Ø¯Ø£ Ø£Ø³Ù…Ø§Ø¤Ù‡Ù… Ø¨Ù€ "test_"')) return;
    
    try {
        const snapshot = await database.ref('users').once('value');
        if (!snapshot.exists()) return;
        
        const usersData = snapshot.val();
        let deletedCount = 0;
        
        for (const userId in usersData) {
            const userData = usersData[userId];
            
            if (userData.username && userData.username.startsWith('test_')) {
                // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…Ø­Ø°ÙˆÙÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚ØªÙŠÙ†
                await database.ref('deleted_users').push({
                    numericId: userData.numericId || generateNumericId(),
                    username: userData.username,
                    email: userData.email || '',
                    phone: userData.phone || '',
                    balanceEGP: userData.balanceEGP || 0,
                    balanceUSD: userData.balanceUSD || 0,
                    deletedAt: new Date().toISOString(),
                    deletedBy: 'admin',
                    originalFirebaseKey: userId,
                    reason: 'ØªÙ†Ø¸ÙŠÙ ØªØ¬Ø±ÙŠØ¨ÙŠ'
                });
                
                // Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                await database.ref('users/' + userId).remove();
                deletedCount++;
            }
        }
        
        if (deletedCount > 0) {
            showAlert(`âœ… ØªÙ… ØªÙ†Ø¸ÙŠÙ ${deletedCount} Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ`, 'success');
            loadUsers();
        } else {
            showAlert('â„¹ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ØªØ¬Ø±ÙŠØ¨ÙŠÙ†', 'info');
        }
        
    } catch (error) {
        console.error('Error cleaning test users:', error);
        showAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ: ' + error.message, 'error');
    }
}

// 24. Ø¹Ø±Ø¶ Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø°ÙˆÙÙŠÙ†
function showDeletedUsersSection() {
    const deletedSection = document.getElementById('deletedUsersSection');
    const usersTable = document.querySelector('.table-container');
    
    if (deletedSection.style.display === 'none') {
        deletedSection.style.display = 'block';
        usersTable.style.display = 'none';
        loadDeletedUsers();
    } else {
        deletedSection.style.display = 'none';
        usersTable.style.display = 'block';
    }
}

// 25. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø°ÙˆÙÙŠÙ†
async function loadDeletedUsers() {
    const deletedBody = document.getElementById('deletedUsersBody');
    
    if (!database) {
        deletedBody.innerHTML = '<tr><td colspan="7">âŒ Firebase ØºÙŠØ± Ù…ØªØµÙ„</td></tr>';
        return;
    }
    
    try {
        const snapshot = await database.ref('deleted_users').once('value');
        
        if (!snapshot.exists()) {
            deletedBody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px;">
                        <div class="empty-state">
                            <span class="empty-state-icon">ğŸ—‘ï¸</span>
                            <h4 style="color: #666;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø­Ø°ÙˆÙÙŠÙ† Ù…Ø¤Ù‚ØªØ§Ù‹</h4>
                            <p style="color: #999; margin-top: 10px;">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ù…Ø¤Ù‚ØªØ§Ù‹ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        let html = '';
        const deletedData = snapshot.val();
        
        for (const deletedId in deletedData) {
            const user = deletedData[deletedId];
            
            let dateDisplay = '---';
            if (user.deletedAt) {
                try {
                    dateDisplay = new Date(user.deletedAt).toLocaleString('ar-EG');
                } catch (e) {
                    dateDisplay = user.deletedAt;
                }
            }
            
            let deleteType = 'Ù…Ø¤Ù‚Øª';
            let typeClass = 'status-temporary';
            
            if (user.reason && user.reason.includes('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ')) {
                deleteType = 'Ù†Ù‡Ø§Ø¦ÙŠ';
                typeClass = 'status-permanent';
            }
            
            html += `
                <tr>
                    <td>
                        <div style="font-family: monospace; font-size: 12px; background: #f1f5f9; padding: 5px; border-radius: 5px;">
                            ${user.numericId || '---'}
                        </div>
                    </td>
                    <td>
                        <div style="font-weight: bold;">${user.username || '---'}</div>
                    </td>
                    <td>
                        ${user.phone ? `<div>ğŸ“± ${user.phone}</div>` : '<div>ğŸ“± ---</div>'}
                        ${user.email ? `<div>ğŸ“§ ${user.email}</div>` : '<div>ğŸ“§ ---</div>'}
                    </td>
                    <td>
                        <div style="font-size: 11px;">${dateDisplay}</div>
                    </td>
                    <td>
                        <div style="font-size: 11px; color: #666;">${user.reason || '---'}</div>
                    </td>
                    <td>
                        <div class="deleted-status ${typeClass}">${deleteType}</div>
                    </td>
                    <td>
                        <div style="display: flex; gap: 5px; justify-content: center;">
                            <button class="action-btn" style="background: #10b981; color: white;" onclick="restoreUser('${deletedId}', ${user.numericId || 0})" title="Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                                ğŸ”„ Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                            </button>
                            <button class="action-btn" style="background: #ef4444; color: white;" onclick="permanentDelete('${deletedId}', '${user.username || ''}')" title="Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ">
                                ğŸ—‘ï¸ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }
        
        deletedBody.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading deleted users:', error);
        deletedBody.innerHTML = `<tr><td colspan="7">âŒ Ø®Ø·Ø£: ${error.message}</td></tr>`;
        showAlert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø°ÙˆÙÙŠÙ†: ' + error.message, 'error');
    }
}

// 26. Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø°ÙˆÙ
async function restoreUser(deletedId, numericId) {
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return;
    
    try {
        const snapshot = await database.ref('deleted_users/' + deletedId).once('value');
        const deletedUser = snapshot.val();
        
        if (!deletedUser) {
            showAlert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
            return;
        }
        
        const newUserRef = database.ref('users').push();
        const finalNumericId = numericId || generateNumericId();
        
        await newUserRef.set({
            numericId: finalNumericId,
            username: deletedUser.username,
            password: deletedUser.password || '123456',
            nickname: deletedUser.nickname || deletedUser.username,
            email: deletedUser.email || '',
            email2: deletedUser.email2 || '',
            phone: deletedUser.phone || '',
            phone2: deletedUser.phone2 || '',
            gender: deletedUser.gender || '',
            age: deletedUser.age || '',
            country: deletedUser.country || '',
            bio: deletedUser.bio || '',
            balanceEGP: deletedUser.balanceEGP || 0,
            balanceUSD: deletedUser.balanceUSD || 0,
            isBanned: deletedUser.isBanned || false,
            banReason: deletedUser.banReason || '',
            banExpiry: deletedUser.banExpiry || '',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        });
        
        await database.ref('deleted_users/' + deletedId).remove();
        
        showAlert(`âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${deletedUser.username}" Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        
        loadDeletedUsers();
        loadUsers();
        
        setTimeout(() => {
            showDeletedUsersSection();
        }, 1000);
        
    } catch (error) {
        console.error('Error restoring user:', error);
        showAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + error.message, 'error');
    }
}

// 27. Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ù…Ø­Ø°ÙˆÙÙŠÙ†
async function permanentDelete(deletedId, username) {
    if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${username}" Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ\n\nâš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!`)) return;
    
    try {
        const snapshot = await database.ref('deleted_users/' + deletedId).once('value');
        const deletedUser = snapshot.val();
        
        if (deletedUser) {
            await database.ref('permanent_deleted_users').push({
                ...deletedUser,
                permanentlyDeletedAt: new Date().toISOString(),
                permanentlyDeletedBy: 'admin'
            });
        }
        
        await database.ref('deleted_users/' + deletedId).remove();
        
        showAlert(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${username}" Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹`, 'success');
        loadDeletedUsers();
        
    } catch (error) {
        console.error('Error permanent deleting:', error);
        showAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ' + error.message, 'error');
    }
}

// 28. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ
async function applyBulkBalanceUpdate() {
    const currency = document.getElementById('bulkCurrency').value;
    const operation = document.getElementById('bulkOperation').value;
    const amount = parseFloat(document.getElementById('bulkAmount').value);
    const reason = document.getElementById('bulkReason').value.trim();
    
    if (isNaN(amount) || amount <= 0) {
        showAlert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­ Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±', 'error');
        return;
    }
    
    const visibleUsers = getFilteredUsers();
    
    if (visibleUsers.length === 0) {
        showAlert('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'error');
        return;
    }
    
    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø¹Ù„Ù‰ ${visibleUsers.length} Ù…Ø³ØªØ®Ø¯Ù…ØŸ`)) return;
    
    try {
        let count = 0;
        
        for (const user of visibleUsers) {
            const currentBalance = parseFloat(user[`balance${currency}`]) || 0;
            let newBalance;
            
            switch (operation) {
                case 'add':
                    newBalance = currentBalance + amount;
                    break;
                case 'subtract':
                    newBalance = currentBalance - amount;
                    if (newBalance < 0) newBalance = 0;
                    break;
                case 'set':
                    newBalance = amount;
                    break;
                default:
                    newBalance = currentBalance;
            }
            
            await database.ref('users/' + user.id).update({
                [`balance${currency}`]: newBalance,
                updatedAt: new Date().toISOString()
            });
            
            count++;
        }
        
        showAlert(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø£Ø±ØµØ¯Ø© ${count} Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        hideBalanceUpdateModal();
        
        setTimeout(() => {
            loadUsers();
        }, 500);
        
    } catch (error) {
        console.error('Error bulk balance update:', error);
        showAlert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±ØµØ¯Ø©: ' + error.message, 'error');
    }
}

// 29. Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©
async function applyBulkAction() {
    const actionType = document.getElementById('bulkActionType').value;
    const visibleUsers = getFilteredUsers();
    
    if (visibleUsers.length === 0) {
        showAlert('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡', 'error');
        return;
    }
    
    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¹Ù„Ù‰ ${visibleUsers.length} Ù…Ø³ØªØ®Ø¯Ù…ØŸ`)) return;
    
    try {
        let count = 0;
        
        switch (actionType) {
            case 'ban':
                const banReason = document.getElementById('bulkBanReason').value.trim() || 'Ø­Ø¸Ø± Ø¬Ù…Ø§Ø¹ÙŠ';
                const banDays = parseInt(document.getElementById('bulkBanDays').value) || 7;
                let banExpiry;
                
                if (banDays === 0) {
                    banExpiry = 'permanent';
                } else {
                    banExpiry = new Date(Date.now() + banDays * 86400000).toISOString();
                }
                
                for (const user of visibleUsers) {
                    if (!user.isBanned) {
                        await database.ref('users/' + user.id).update({
                            isBanned: true,
                            banReason: banReason,
                            banExpiry: banExpiry,
                            bannedAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        });
                        count++;
                    }
                }
                break;
                
            case 'unban':
                for (const user of visibleUsers) {
                    if (user.isBanned) {
                        await database.ref('users/' + user.id).update({
                            isBanned: false,
                            banReason: '',
                            banExpiry: '',
                            updatedAt: new Date().toISOString()
                        });
                        count++;
                    }
                }
                break;
                
            case 'delete_temp':
                const deleteReason = prompt('Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…Ø¤Ù‚Øª:', 'Ø­Ø°Ù Ø¬Ù…Ø§Ø¹ÙŠ') || 'Ø­Ø°Ù Ø¬Ù…Ø§Ø¹ÙŠ';
                
                for (const user of visibleUsers) {
                    await database.ref('deleted_users').push({
                        numericId: user.numericId,
                        username: user.username,
                        email: user.email,
                        phone: user.phone,
                        balanceEGP: user.balanceEGP,
                        balanceUSD: user.balanceUSD,
                        deletedAt: new Date().toISOString(),
                        deletedBy: 'admin',
                        originalFirebaseKey: user.id,
                        reason: deleteReason
                    });
                    
                    await database.ref('users/' + user.id).remove();
                    count++;
                }
                break;
                
            case 'send_notification':
                const title = document.getElementById('bulkNotificationTitle').value.trim();
                const content = document.getElementById('bulkNotificationContent').value.trim();
                
                if (!title || !content) {
                    showAlert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† ÙˆÙ…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±', 'error');
                    return;
                }
                
                for (const user of visibleUsers) {
                    await database.ref('notifications/' + user.id).push({
                        title: title,
                        content: content,
                        sentAt: new Date().toISOString(),
                        read: false
                    });
                    count++;
                }
                break;
        }
        
        showAlert(`âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¹Ù„Ù‰ ${count} Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        hideBulkActionsModal();
        
        setTimeout(() => {
            loadUsers();
        }, 500);
        
    } catch (error) {
        console.error('Error bulk action:', error);
        showAlert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ: ' + error.message, 'error');
    }
}

// 30. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø©
function getFilteredUsers() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('filterStatus').value;
    const genderFilter = document.getElementById('filterGender').value;
    const dateFrom = document.getElementById('filterDateFrom').value;
    const dateTo = document.getElementById('filterDateTo').value;
    const minBalance = parseFloat(document.getElementById('filterMinBalance').value) || 0;
    
    return allUsers.filter(user => {
        let matchesSearch = true;
        if (search) {
            matchesSearch = (user.username && user.username.toLowerCase().includes(search)) ||
                           (user.nickname && user.nickname.toLowerCase().includes(search)) ||
                           (user.email && user.email.toLowerCase().includes(search)) ||
                           (user.phone && user.phone.includes(search)) ||
                           (user.numericId && user.numericId.toString().includes(search));
        }
        
        let matchesStatus = true;
        if (statusFilter === 'active') {
            matchesStatus = !user.isBanned;
        } else if (statusFilter === 'banned') {
            matchesStatus = user.isBanned === true;
        }
        
        let matchesGender = true;
        if (genderFilter) {
            matchesGender = user.gender === genderFilter;
        }
        
        let matchesDate = true;
        if (dateFrom || dateTo) {
            if (user.createdAt) {
                try {
                    const userDate = new Date(user.createdAt);
                    const fromDate = dateFrom ? new Date(dateFrom) : null;
                    const toDate = dateTo ? new Date(dateTo + 'T23:59:59') : null;
                    
                    if (fromDate && userDate < fromDate) matchesDate = false;
                    if (toDate && userDate > toDate) matchesDate = false;
                } catch (e) {
                    matchesDate = false;
                }
            } else {
                matchesDate = false;
            }
        }
        
        let matchesBalance = true;
        if (minBalance > 0) {
            matchesBalance = (user.balanceEGP >= minBalance) || (user.balanceUSD >= minBalance);
        }
        
        return matchesSearch && matchesStatus && matchesGender && matchesDate && matchesBalance;
    });
}

// 31. ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ù…Ø­Ø³Ù†Ø© Ù…Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ§Ù„ÙØµÙ„ Ø¨Ø´Ø±Ø·Ø© Ù…Ø§Ø¦Ù„Ø©
function exportUsersData() {
    if (allUsers.length === 0) {
        showAlert('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±', 'error');
        return;
    }
    
    const separator = ' / ';
    
    const data = allUsers.map(user => ({
        'Ø§Ù„Ù…Ø¹Ø±Ù': user.numericId || '',
        'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…': user.username || '',
        'Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±': user.nickname || '',
        'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±': user.password || '',
        'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ': user.email || '',
        'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ': user.email2 || '',
        'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ': user.phone || '',
        'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ': user.phone2 || '',
        'Ø§Ù„Ø¬Ù†Ø³': user.gender || '',
        'Ø§Ù„Ø¹Ù…Ø±': user.age || '',
        'Ø§Ù„Ø¨Ù„Ø¯': user.country || '',
        'Ù†Ø¨Ø°Ø©': user.bio || '',
        'Ø±ØµÙŠØ¯ EGP': (user.balanceEGP || 0).toFixed(2),
        'Ø±ØµÙŠØ¯ USD': (user.balanceUSD || 0).toFixed(2),
        'Ø§Ù„Ø­Ø§Ù„Ø©': user.isBanned ? 'Ù…Ø­Ø¸ÙˆØ±' : 'Ù†Ø´Ø·',
        'Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¸Ø±': user.banReason || '',
        'ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø­Ø¸Ø±': user.banExpiry || '',
        'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„': user.createdAt || '',
        'Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«': user.updatedAt || '',
        'Ø¢Ø®Ø± ØªØºÙŠÙŠØ± Ù„Ù„Ø§Ø³Ù…': user.lastNicknameChange || ''
    }));
    
    // Ø¥Ù†Ø´Ø§Ø¡ CSV Ù…Ø¹ Ø§Ù„ÙØµÙ„ Ø¨Ø´Ø±Ø·Ø© Ù…Ø§Ø¦Ù„Ø©
    const headers = Object.keys(data[0]);
    const csvContent = [
        headers.join(separator),
        ...data.map(row => 
            headers.map(header => {
                const value = row[header];
                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙÙˆØ§ØµÙ„ Ø£Ùˆ Ø£Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯Ø©
                if (typeof value === 'string' && (value.includes(',') || value.includes('\n') || value.includes('"'))) {
                    return `"${value.replace(/"/g, '""')}"`;
                }
                return value;
            }).join(separator)
        )
    ].join('\n');
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù ÙˆØªÙ†Ø²ÙŠÙ„Ù‡
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
    
    link.href = URL.createObjectURL(blob);
    link.download = `vipclub_users_${timestamp}.csv`;
    link.style.display = 'none';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert(`âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª ${allUsers.length} Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­`, 'success');
    
    // Ø¹Ø±Ø¶ Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ¯Ø±Ø©
    console.log('ğŸ“Š Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ¯Ø±Ø©:', data[0]);
}

// 32. Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ø´Ø§Ø·
function showUserActivityReport() {
    if (allUsers.length === 0) {
        showAlert('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±', 'error');
        return;
    }
    
    const today = new Date();
    const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    const lastMonth = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
    
    const usersThisWeek = allUsers.filter(u => {
        if (!u.createdAt) return false;
        try {
            const userDate = new Date(u.createdAt);
            return userDate >= lastWeek;
        } catch (e) {
            return false;
        }
    }).length;
    
    const usersThisMonth = allUsers.filter(u => {
        if (!u.createdAt) return false;
        try {
            const userDate = new Date(u.createdAt);
            return userDate >= lastMonth;
        } catch (e) {
            return false;
        }
    }).length;
    
    const activeUsersCount = allUsers.filter(u => !u.isBanned).length;
    const bannedUsersCount = allUsers.filter(u => u.isBanned).length;
    
    const totalBalanceEGP = allUsers.reduce((sum, u) => sum + (u.balanceEGP || 0), 0);
    const totalBalanceUSD = allUsers.reduce((sum, u) => sum + (u.balanceUSD || 0), 0);
    
    const report = `
        ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ù†Ø´Ø§Ø· Ø§Ù„Ù†Ø¸Ø§Ù…
        ====================
        ğŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${allUsers.length}
        âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†: ${activeUsersCount}
        ğŸš« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†: ${bannedUsersCount}
        
        ğŸ“ˆ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª:
        â€¢ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: ${usersThisWeek}
        â€¢ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±: ${usersThisMonth}
        
        ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±ØµØ¯Ø©:
        â€¢ EGP: ${totalBalanceEGP.toFixed(2)}
        â€¢ USD: ${totalBalanceUSD.toFixed(2)}
        
        â±ï¸ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${lastUpdateTime ? lastUpdateTime.toLocaleString('ar-EG') : '---'}
        
        ğŸ“‹ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:
        â€¢ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ´ØºÙŠÙ„: ${navigator.platform}
        â€¢ Ù…ØªØµÙØ­: ${navigator.userAgent.split(') ')[0].split('(')[1]}
    `;
    
    alert(report);
}

// 33. ØªØ¨Ø¯ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
function toggleConnectionInfo() {
    const infoDiv = document.getElementById('connectionInfo');
    infoDiv.style.display = infoDiv.style.display === 'none' ? 'block' : 'none';
}

// 34. Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
function showAlert(message, type) {
    const container = document.getElementById('alertContainer');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.innerHTML = `
        <span>${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'}</span>
        <div style="flex: 1;">${message}</div>
        <button onclick="this.parentElement.remove()" style="background: none; border: none; color: inherit; cursor: pointer; font-size: 16px;">Ã—</button>
    `;
    
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.remove();
        }
    }, 8000);
}

// 35. Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
function goToHome() {
    window.location.href = 'home.html';
}

// 36. Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.onload = function() {
    initializeFirebase();
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
    setInterval(() => {
        if (!isLoading) {
            loadUsers();
        }
    }, 60000);
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„ØªØ­Ø¯ÙŠØ« Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©
    document.getElementById('bulkActionType').addEventListener('change', updateBulkActionFields);
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    });
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø²Ø± Escape Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            hideAddModal();
            hideEditModal();
            hideBalanceUpdateModal();
            hideBulkActionsModal();
        }
    });
};

// Ø¥Ù„ØºØ§Ø¡ ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
window.testApp = function() {
    showAlert('â„¹ï¸ ØªÙ… Ø¥Ù„ØºØ§Ø¡ ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'info');
    console.log('ØªÙ… Ø¥Ù„ØºØ§Ø¡ ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±');
};
</script>
</body>
</html>