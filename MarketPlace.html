<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="images//videoslogo/vip.png">
    <title>VipClub - Ù…ØªØ¬Ø± Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root { 
            --primary: #8b5cf6; 
            --primary-hover: #7c3aed;
            --success: #10b981;
            --danger: #ef4444; 
            --dark: #0f172a; 
            --bg: #050b18; 
            --card-bg: #111827;
            --footer-bg: #0f172a;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            background: var(--bg); 
            color: var(--text-main);
            display: flex; 
            flex-direction: column; 
            min-height: 100vh; 
        }
        
        .main-content { flex: 1; padding-bottom: 50px; }

        /* Navigation */
        .navbar { 
            background: rgba(15, 23, 42, 0.9); 
            backdrop-filter: blur(10px);
            height: 70px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0 20px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.3); 
            position: sticky; 
            top: 0; 
            z-index: 9999; 
            border-bottom: 1px solid #1e293b;
        }
        .logo-profile-section { display: flex; align-items: center; gap: 15px; }
        .logo { font-weight: 800; font-size: 1.5rem; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }

        .icon-btn { 
            font-size: 1.4rem; 
            color: var(--text-main); 
            cursor: pointer; 
            position: relative; 
            width: 45px; 
            height: 45px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 12px; 
            transition: 0.3s; 
            text-decoration: none; 
            background: rgba(255,255,255,0.05);
        }
        .icon-btn:hover { background: var(--primary); color: white; transform: translateY(-2px); }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 50%; border: 2px solid var(--bg); }

        /* Ø²Ø± Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ø¹Ø§Ø¦Ù… - Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ */
        .floating-support {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.4);
            cursor: pointer;
            z-index: 999;
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-decoration: none;
        }

        .floating-support:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.6);
            color: #fff;
        }

        .support-tooltip {
            position: absolute;
            right: 75px;
            background: var(--dark);
            color: white;
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 0.85rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
            transform: translateX(10px);
        }

        .floating-support:hover .support-tooltip {
            opacity: 1;
            transform: translateX(0);
        }

        .pulse-dot {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            background: #ff4757;
            border: 2px solid white;
            border-radius: 50%;
            animation: pulse-ring 2s infinite;
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }

        /* Hero Section */
        .hero {
            padding: 60px 20px;
            text-align: center;
            background: radial-gradient(circle at center, #1e1b4b 0%, #050b18 100%);
        }
        .hero h2 { font-size: 2.2rem; margin-bottom: 10px; }
        .hero p { color: var(--text-dim); max-width: 600px; margin: 0 auto; }

        /* Game Cards */
        .cards-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 25px; 
            padding: 20px; 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        .product-card { 
            background: var(--card-bg); 
            border-radius: 24px; 
            padding: 15px; 
            text-align: center; 
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            border: 1px solid #1e293b; 
            position: relative;
            overflow: hidden;
        }
        .product-card:hover { transform: translateY(-12px); border-color: var(--primary); box-shadow: 0 15px 35px rgba(139, 92, 246, 0.2); }
        
        .game-img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            border-radius: 18px;
            margin-bottom: 15px;
            background: #0f172a;
            cursor: zoom-in;
            transition: all 0.3s ease;
        }
        .game-img:hover { transform: scale(1.05); box-shadow: 0 10px 25px rgba(139, 92, 246, 0.3); }
        
        .account-badge {
            position: absolute;
            top: 25px;
            left: 25px;
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 2;
        }
        .stock-indicator {
            position: absolute;
            top: 25px;
            right: 25px;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: bold;
            z-index: 2;
        }
        .stock-indicator.available { background: rgba(16, 185, 129, 0.9); color: white; }
        .stock-indicator.soldout { background: #ef4444; color: white; }
        .product-card h3 { margin: 10px 0 5px; color: var(--text-main); font-size: 1.2rem; }
        .product-card .desc { color: var(--text-dim); font-size: 0.85rem; margin-bottom: 15px; min-height: 40px; }
        .price-tag { font-size: 1.4rem; font-weight: 800; color: var(--success); margin: 15px 0; }

        /* Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± */
        .gallery-overlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(0,0,0,0.97); 
            z-index: 20000;
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            backdrop-filter: blur(15px);
        }
        
        .gallery-content { 
            position: relative; 
            width: 100%; 
            height: 100%; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .close-gallery { 
            position: absolute; 
            top: 30px; 
            right: 30px; 
            color: white; 
            font-size: 2.2rem; 
            cursor: pointer; 
            transition: all 0.3s ease;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            z-index: 20001;
        }
        .close-gallery:hover { 
            color: var(--danger); 
            background: rgba(239,68,68,0.2);
            transform: rotate(90deg) scale(1.1);
        }

        .main-gallery-image {
            position: relative;
            width: 100%; 
            height: 85vh; 
            max-width: 100vw;
            border-radius: 0;
            margin-bottom: 20px;
            overflow: hidden;
            background: var(--dark);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .main-gallery-image img {
            width: 100%; 
            height: 100%; 
            object-fit: contain;
            max-width: 95vw;
            max-height: 85vh;
            transition: transform 0.4s ease;
        }

        .thumbnails-container {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            padding: 15px 25px;
            background: rgba(15, 23, 42, 0.95);
            border-radius: 25px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(139, 92, 246, 0.3);
            max-width: 90vw;
            overflow-x: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) rgba(0,0,0,0.3);
            z-index: 20001;
        }
        .thumbnails-container::-webkit-scrollbar {
            height: 6px;
        }
        .thumbnails-container::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 3px;
        }
        .thumbnails-container::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }
        
        .thumbnail {
            width: 60px !important;
            height: 60px !important;
            border-radius: 12px;
            cursor: pointer;
            object-fit: cover;
            border: 3px solid rgba(255,255,255,0.2);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            flex-shrink: 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }
        .thumbnail:hover {
            transform: translateY(-5px) scale(1.05);
            border-color: var(--primary);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.5);
        }
        .thumbnail.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.4), 0 8px 30px rgba(139, 92, 246, 0.6);
            transform: scale(1.08);
        }

        .gallery-counter { 
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: white; 
            font-size: 1.1rem; 
            font-weight: 600;
            background: rgba(139, 92, 246, 0.2);
            padding: 8px 20px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(139, 92, 246, 0.3);
            z-index: 20001;
        }

        .nav-buttons {
            position: fixed;
            top: 50%;
            width: 100%;
            height: 100vh;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            pointer-events: none;
            z-index: 20001;
        }
        .nav-btn {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: rgba(139, 92, 246, 0.3);
            color: white;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            pointer-events: all;
            backdrop-filter: blur(15px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
        }
        .nav-btn:hover {
            background: var(--primary);
            transform: scale(1.15);
            box-shadow: 0 10px 35px rgba(139, 92, 246, 0.6);
        }

        /* Modals & Dropdowns - ØªØµÙ…ÙŠÙ… Ø¬Ø¯ÙŠØ¯ */
        .dropdown-overlay { 
            position: fixed; 
            top: 80px; 
            width: 320px; 
            max-width: 90%; 
            background: #111827; 
            border-radius: 20px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
            display: none; 
            flex-direction: column; 
            z-index: 10000; 
            border: 1px solid #334155; 
            overflow: hidden; 
        }
        #profileDropdown { right: 20px; left: auto; padding: 20px; text-align: center; }
        #notifDropdown { left: 20px; right: auto; background: #0f172a; color: white; }

        .dropdown-overlay.active { display: flex !important; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-15px); } to { opacity: 1; transform: translateY(0); } }

        #purchaseModal, #topUpModal, #currencyModal { 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            width: 400px; 
            max-width: 95%; 
            z-index: 10001; 
            padding: 25px; 
            display: none; 
            flex-direction: column; 
            background: #1e293b; 
            border-radius: 28px; 
            box-shadow: 0 25px 70px rgba(0,0,0,0.6); 
            border: 1px solid #334155; 
            color: white; 
        }

        .modal-active { display: flex !important; animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        @keyframes popIn { from { opacity: 0; transform: scale(0.8) translate(-50%, -50%); } to { opacity: 1; transform: scale(1) translate(-50%, -50%); } }

        /* Notifications - ØªØµÙ…ÙŠÙ… Ø¬Ø¯ÙŠØ¯ */
        .notif-header { 
            padding: 15px; 
            border-bottom: 1px solid #334155; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-weight: bold; 
        }
        .refresh-btn { 
            cursor: pointer; 
            font-size: 1rem; 
            color: var(--text-dim); 
            transition: 0.3s; 
            margin-right: auto; 
            margin-left: 10px; 
            padding: 5px; 
        }
        .refresh-btn:hover { 
            color: var(--primary); 
            transform: rotate(180deg); 
        }
        .refreshing { 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 
            100% { transform: rotate(360deg); } 
        }
        
        #notifList { 
            max-height: 350px; 
            overflow-y: auto; 
            padding: 10px;
        }
        .notif-item { 
            padding: 12px 15px; 
            border-bottom: 1px solid #1e293b; 
            font-size: 0.85rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            gap: 10px; 
            position: relative; 
            transition: all 0.3s ease;
            border-radius: 10px;
            margin-bottom: 5px;
        }
        .notif-item.unread { 
            background: rgba(139, 92, 246, 0.1); 
            border-right: 4px solid var(--primary); 
        }
        .notif-item:hover { 
            background: rgba(255, 255, 255, 0.03); 
        }
        .delete-single-notif { 
            color: var(--danger); 
            cursor: pointer; 
            padding: 6px; 
            opacity: 0.6; 
            transition: 0.3s; 
            background: rgba(239, 68, 68, 0.1); 
            border-radius: 6px; 
            width: 30px; 
            height: 30px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .delete-single-notif:hover { 
            opacity: 1; 
            transform: scale(1.1); 
            background: rgba(239, 68, 68, 0.2); 
        }

        /* Buttons */
        .action-btn { 
            width: 100%; 
            padding: 14px; 
            border-radius: 14px; 
            border: none; 
            cursor: pointer; 
            font-weight: bold; 
            transition: 0.3s; 
            margin-top: 10px; 
            font-family: inherit; 
            font-size: 1rem; 
        }
        .btn-primary { 
            background: var(--primary); 
            color: white; 
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4); 
        }
        .btn-primary:hover { 
            background: var(--primary-hover); 
            transform: translateY(-2px);
        }
        .btn-success { 
            background: var(--success); 
            color: white; 
        }
        .btn-logout { 
            background: rgba(239, 68, 68, 0.1); 
            color: var(--danger); 
            border: 1px solid rgba(239, 68, 68, 0.2); 
        }
        
        select, input { 
            width: 100%; 
            padding: 12px; 
            border-radius: 10px; 
            border: 1px solid #334155; 
            background: #0f172a; 
            color: white; 
            margin-top: 8px; 
            box-sizing: border-box; 
            font-family: inherit;
        }

        .balance-card { 
            background: rgba(255,255,255,0.03); 
            padding: 15px; 
            border-radius: 15px; 
            margin: 15px 0; 
            border: 1px solid #334155; 
        }
        .balance-row { 
            display: flex; 
            justify-content: space-between; 
            margin: 5px 0; 
            font-size: 0.95rem; 
        }

        #screenOverlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 9998; 
            display: none; 
            background: rgba(0,0,0,0.7); 
            backdrop-filter: blur(6px); 
        }

        .modern-footer { 
            background: var(--footer-bg); 
            padding: 40px 20px; 
            text-align: center; 
            border-top: 1px solid #1e293b; 
            margin-top: 50px; 
        }
        .social-link { 
            text-decoration: none; 
            font-size: 1.3rem; 
            width: 45px; 
            height: 45px; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 12px; 
            margin: 0 8px; 
            transition: 0.3s; 
        }
        .youtube { color: #ff0000; background: rgba(255,0,0,0.1); }
        .facebook { color: #1877f2; background: rgba(24,119,242,0.1); }
        .whatsapp { color: #25d366; background: rgba(37,211,102,0.1); }
        .discord  { color: #5865f2 !important; background: rgba(24,119,242,0.1); }
        .hidden-guest { display: none !important; }

        /* Ø±Ø³Ø§Ø¦Ù„ Firebase */
        .firebase-alert {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 12px 18px;
            border-radius: 12px;
            z-index: 10002;
            animation: slideInRight 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            max-width: 400px;
            backdrop-filter: blur(10px);
        }

        .firebase-success {
            background: rgba(16, 185, 129, 0.9);
            color: white;
            border-left: 4px solid #059669;
        }

        .firebase-error {
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border-left: 4px solid #dc2626;
        }

        .firebase-warning {
            background: rgba(245, 158, 11, 0.9);
            color: white;
            border-left: 4px solid #d97706;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù€ ID Ø§Ù„Ø±Ù‚Ù…ÙŠ */
        .user-id-numeric {
            background: linear-gradient(90deg, #4f46e5, #8b5cf6);
            color: white;
            padding: 10px 20px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            font-weight: bold;
            letter-spacing: 2px;
            text-align: center;
            margin: 10px auto;
            display: inline-block;
            min-width: 140px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.1);
        }

        .id-label {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 5px;
            display: block;
        }

        /* Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ */
        .desktop-notification {
            position: fixed;
            top: 30px;
            right: 30px;
            background: #1e293b;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.4);
            padding: 18px;
            z-index: 10003;
            display: none;
            max-width: 380px;
            border-left: 5px solid var(--primary);
            animation: slideInRight 0.3s ease;
            border: 1px solid #334155;
            backdrop-filter: blur(20px);
        }

        .notification-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            flex-shrink: 0;
        }

        .notification-success .notification-icon {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .notification-error .notification-icon {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .notification-warning .notification-icon {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        .code-in-notification {
            background: linear-gradient(45deg, #4f46e5, #8b5cf6);
            color: white;
            padding: 6px 10px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 0.85rem;
            letter-spacing: 1px;
            margin: 5px 0;
            display: inline-block;
            direction: ltr;
            text-align: center;
            word-break: break-all;
            border: 2px solid rgba(199, 210, 254, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .code-in-notification:hover {
            background: linear-gradient(45deg, #7c3aed, #a78bfa);
            transform: translateY(-2px);
        }

        /* Ø­Ù‚Ù„ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯ */
        #selectedPaymentInfo { 
            background: rgba(224, 242, 254, 0.1); 
            padding: 12px; 
            border-radius: 12px; 
            margin-bottom: 15px; 
            display: none; 
            text-align: center; 
            border: 1px solid rgba(186, 230, 253, 0.3); 
        }
        #selectedPaymentInfo strong { 
            color: var(--primary); 
        }

        /* ÙƒÙˆØ¨ÙŠ Ø¨ÙˆÙƒØ³ */
        .copy-box { 
            background: #0f172a; 
            padding: 12px; 
            border-radius: 12px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin: 10px 0; 
            border: 1px dashed var(--primary); 
        }
        .copy-btn { 
            background: var(--primary); 
            color: white; 
            border: none; 
            padding: 6px 12px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 0.85rem; 
            transition: 0.3s;
        }
        .copy-btn:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>

<div id="screenOverlay" onclick="closeAll()"></div>

<!-- Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± -->
<div id="galleryOverlay" class="gallery-overlay" onclick="closeGallery(event)">
    <div class="gallery-content" onclick="event.stopPropagation()">
        <div class="gallery-counter" id="galleryCounter">ØµÙˆØ±Ø© 1 Ù…Ù† 1</div>
        <span class="close-gallery" onclick="closeGallery()">
            <i class="fas fa-times"></i>
        </span>
        <div class="nav-buttons">
            <button class="nav-btn" id="prevBtn" onclick="changeImage(-1)">
                <i class="fas fa-chevron-right"></i>
            </button>
            <button class="nav-btn" id="nextBtn" onclick="changeImage(1)">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        <div class="main-gallery-image">
            <img id="galleryMainImg" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
        </div>
        <div class="thumbnails-container" id="thumbnailsContainer"></div>
    </div>
</div>

<!-- Ø¥Ø´Ø¹Ø§Ø± Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ -->
<div id="desktopNotification" class="desktop-notification" style="display: none;">
    <div style="display: flex; align-items: center;">
        <div class="notification-icon">
            <i class="fas fa-bell"></i>
        </div>
        <div style="flex: 1;">
            <div style="font-weight: bold; margin-bottom: 5px;" id="notificationTitle">Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯</div>
            <div style="font-size: 0.9rem;" id="notificationMessage"></div>
        </div>
        <button onclick="closeDesktopNotification()" style="background: none; border: none; color: #999; cursor: pointer; font-size: 1.2rem;">Ã—</button>
    </div>
</div>

<!-- Ø±Ø³Ø§Ø¦Ù„ Firebase -->
<div id="firebaseAlert" class="firebase-alert" style="display: none;"></div>

<!-- Ø²Ø± Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ø¹Ø§Ø¦Ù… Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ -->
<div onclick="handleSupportClick()" class="floating-support" title="Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ">
    <i class="fas fa-headset"></i>
    <span class="pulse-dot"></span>
    <div class="support-tooltip">ØªØ­Ø¯Ø« Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</div>
</div>

<div class="main-content">
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ -->
    <nav class="navbar">
        <div class="logo-profile-section">
            <div class="logo">ğŸ‘‘ VipClub ğŸ‘‘</div>
            <div class="icon-btn" onclick="handleProfileClick()" title="Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ">
                <i class="fas fa-user-circle"></i>
            </div>
            <a href="Wallet.html" class="icon-btn auth-only hidden-guest" title="Ø§Ù„Ù…Ø­ÙØ¸Ø©" onclick="prepareForWallet()">
                <i class="fas fa-wallet"></i>
            </a>
        </div>
        <div class="nav-icons">
            <div class="icon-btn auth-only hidden-guest" onclick="openMenu('notifDropdown')" title="Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª">
                <i class="fas fa-bell"></i>
                <span class="badge" id="notifBadge">0</span>
            </div>
        </div>
    </nav>

    <section class="hero">
        <h2>Ù…ØªØ¬Ø± Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù…Ø´Ù‡ÙˆØ±Ø©</h2>
        <p>Ø§Ø³ØªÙƒØ´Ù Ø£Ù‚ÙˆÙ‰ ØªØ´ÙƒÙŠÙ„Ø© Ù…Ù† Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù…Ø®ØªÙ„ÙØ© ÙØ§Ù„Ù…ØªØ¬Ø± ÙˆØ£ØºØªÙ†Ù… Ø§Ù„ÙØ±ØµØ© Ù„Ø´Ø±Ø§Ø¦Ù‡Ø§ Ø­Ø§Ù„Ø§!</p>
    </section>

    <div class="cards-container" id="productsGrid"></div>
</div>

<!-- Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ù€ ID -->
<div id="profileDropdown" class="dropdown-overlay">
    <i class="fas fa-user-circle" style="font-size: 3rem; color: var(--primary); margin: 15px auto 5px auto;"></i>
    <h4 id="p_nickname" style="margin: 5px 0;">ØªØ­Ù…ÙŠÙ„...</h4>
    <span class="id-label">Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</span>
    <div class="user-id-numeric" id="p_id">000000</div>
    <small>
        <i class="fas fa-copy" onclick="copyText('p_id')" style="cursor:pointer; color:var(--primary);" title="Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù"></i>
        Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù
    </small>
    <div class="balance-card">
        <div class="balance-row"><span>Ø±ØµÙŠØ¯ Ø¬.Ù…: [EGP]</span> <span id="p_egp" style="color:var(--success);">0</span></div>
        <div class="balance-row"><span>Ø±ØµÙŠØ¯ Ø¯ÙˆÙ„Ø§Ø±: [USD]</span> <span id="p_usd" style="color:#60a5fa;">0</span></div>
    </div>
    <div style="padding: 0 10px 15px 10px;">
        <button class="action-btn btn-success" onclick="openCurrencySelection()">Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯ (Ø¥ÙŠØ¯Ø§Ø¹)</button>
        <button class="action-btn btn-logout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<div id="currencyModal">
    <h3 style="margin-top:0; text-align: center;">Ø¥ÙŠØ¯Ø§Ø¹ Ø±ØµÙŠØ¯</h3>
    <p style="text-align: center; color: var(--text-dim);">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„ØªÙŠ ØªÙˆØ¯ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø¨Ù‡Ø§:</p>
    <button class="action-btn btn-primary" onclick="handleCurrencyChoice('EGP')">Ø¥ÙŠØ¯Ø§Ø¹ Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡ Ø§Ù„Ù…ØµØ±ÙŠ (EGP)</button>
    <button class="action-btn btn-success" onclick="handleCurrencyChoice('USD')">Ø¥ÙŠØ¯Ø§Ø¹ Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± (USD)</button>
    <button class="action-btn" style="background:#1e293b; color:white;" onclick="closeAll()">Ø¥Ù„ØºØ§Ø¡</button>
</div>

<div id="topUpModal">
    <h3 id="topUpTitle" style="margin-top:0;">Ø´Ø­Ù† Ø±ØµÙŠØ¯</h3>
    
    <div id="selectedPaymentInfo">
        <strong>ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©: <span id="paymentMethodName">---</span></strong>
    </div>
    
    <div style="text-align: right; margin-bottom: 15px;">
        <label style="font-weight: bold; font-size: 0.85rem;">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</label>
        <select id="paymentMethod" onchange="updatePaymentDetails(); updatePaymentMethodDisplay()"></select>
    </div>
    <div style="text-align: right; margin-bottom: 15px;">
        <label id="amountLabel" style="font-weight: bold; font-size: 0.85rem;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥ÙŠØ¯Ø§Ø¹Ù‡:</label>
        <input type="number" id="topUpAmount" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ù‡Ù†Ø§" oninput="calculateRequiredAmount()">
    </div>
    <div id="calculationDisplay" class="calculation-box">
        <span style="font-size: 0.85rem; font-weight: bold;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ­ÙˆÙŠÙ„Ù‡: </span>
        <b id="finalRequiredAmount">0</b>
    </div>
    <div id="paymentDetails" class="payment-info-box" style="display: block;">
        <p id="methodHint" style="font-size: 0.8rem; margin-bottom: 5px; color: var(--text-dim);"></p>
        <div class="copy-box" id="walletBox">
            <b id="walletNumber">01022797043</b>
            <button class="copy-btn" onclick="copyText('walletNumber')">Ù†Ø³Ø®</button>
        </div>
        <div id="binanceDetails" style="display:none; font-size: 0.85rem; line-height: 1.6;">
            <div>Ø§Ù„Ù…Ø¹Ø±Ù: <b id="binanceID">803045359</b> <button class="copy-btn" style="padding: 2px 5px;" onclick="copyText('binanceID')">Ù†Ø³Ø®</button></div>
            <div>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±: <b id="binanceName">iMrJoe</b></div>
        </div>
    </div>
    <div style="text-align: right; margin-bottom: 15px;">
        <label style="font-weight: bold; font-size: 0.85rem;">Ø§Ø±ÙØ¹ Ø¥ÙŠØµØ§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„:</label>
        <input type="file" id="topUpReceipt" accept="image/*">
    </div>
    <button class="action-btn btn-primary" id="submitTopUpBtn" onclick="submitTopUp()">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠØµØ§Ù„</button>
    <button class="action-btn" style="background:#1e293b; color:white;" onclick="closeAll()">Ø¥Ù„ØºØ§Ø¡</button>
</div>

<div id="purchaseModal">
    <h3 id="m_title" style="margin-top:0;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡</h3>
    <div id="m_info" style="font-size: 0.9rem; margin-bottom: 15px; color: var(--text-dim);"></div>
    <p id="purchaseWarning" style="font-size: 0.85rem; color: var(--text-dim); background: rgba(255, 247, 237, 0.1); padding: 10px; border-radius: 10px; border: 1px solid rgba(255, 237, 213, 0.2);">
        Ø³ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.
    </p>
    <button id="confirmPurchaseBtn" class="action-btn btn-primary">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø®ØµÙ… ÙˆØ§Ù„Ø´Ø±Ø§Ø¡</button>
    <button class="action-btn" style="background:#1e293b; color:white;" onclick="closeAll()">Ø¥Ù„ØºØ§Ø¡</button>
</div>

<div id="notifDropdown" class="dropdown-overlay">
    <div class="notif-header">
        <span>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span>
        <i class="fas fa-sync-alt refresh-btn" id="refreshIcon" onclick="refreshData()"></i>
        <span id="unreadCount" style="background:var(--danger); font-size:0.7rem; padding:2px 7px; border-radius:10px;">0</span>
    </div>
    <div id="notifList"></div>
    <div style="padding: 10px; display: flex; gap: 5px; background: #0a0f1d;">
        <button onclick="markAllRead()" style="flex:1; font-size:0.8rem; padding:10px; background:#1e293b; color:white; border:none; border-radius:8px; cursor:pointer;">Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒÙ„</button>
        <button onclick="deleteAllNotifs()" style="flex:1; font-size:0.8rem; padding:10px; background:#1e293b; color:white; border:none; border-radius:8px; cursor:pointer;">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
    </div>
</div>

<footer class="modern-footer">
    <div>&copy; <span id="currentYear"></span> <b>VipClub Store</b> - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</div>
    <div style="margin-top:20px;">
        <a href="https://www.youtube.com/@VipCIub" class="social-link youtube"><i class="fab fa-youtube"></i></a>
        <a href="https://www.facebook.com/groups/1123845664925685/?ref=share&mibextid=NSMWBT" class="social-link facebook"><i class="fab fa-facebook-f"></i></a>
        <a href="https://wa.me/+201022797043" class="social-link whatsapp"><i class="fab fa-whatsapp"></i></a>
        <a href="https://discord.gg/mqzeqsYzcR" class="social-link discord" title="Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯"><i class="fab fa-discord"></i></a>
    </div>
</footer>

<script>
    // ===== ØªÙƒÙˆÙŠÙ† Firebase =====
    const firebaseConfig = {
        apiKey: "AIzaSyAVSzkDLqi1G-hpfEPqvBMmuyYRfEuaTKk",
        authDomain: "vipclub-1d04a.firebaseapp.com",
        databaseURL: "https://vipclub-1d04a-default-rtdb.firebaseio.com",
        projectId: "vipclub-1d04a",
        storageBucket: "vipclub-1d04a.firebasestorage.app",
        messagingSenderId: "120667552740",
        appId: "1:120667552740:web:02085765fd43eb0080e5f1"
    };

    // ===== Ù…ØªØºÙŠØ±Ø§Øª Firebase =====
    let firebaseApp, database, auth;
    
    // ===== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª =====
    let lastNotificationId = localStorage.getItem('lastNotificationId') || null;
    let notificationCooldown = false;
    let notificationTimers = {};
    let desktopNotificationShown = false;
    
    // ===== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØµÙØ­Ø© =====
    let currentGallery = [];
    let currentImageIndex = 0;
    let selectedCurrency = 'EGP';
    let activeProduct = {};
    let currentProductId = null;
    
    // ===== Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ØªÙƒØ±Ø± =====
    let isSubmittingTopUp = false;
    let isProcessingPurchase = false;
    
    // ===== Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ ID Ø±Ù‚Ù…ÙŠ =====
    function generateNumericId() {
        return Math.floor(100000 + Math.random() * 900000);
    }
    
    // ===== Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ID Ø±Ù‚Ù…ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… =====
    function getOrCreateNumericId() {
        let currentUser = getCurrentUserFromStorage();
        
        if (!currentUser) {
            return generateNumericId();
        }
        
        if (currentUser.numericId) {
            return currentUser.numericId;
        }
        
        if (currentUser.id && !isNaN(currentUser.id)) {
            return parseInt(currentUser.id);
        }
        
        const newNumericId = generateNumericId();
        currentUser.numericId = newNumericId;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        
        return newNumericId;
    }
    
    // ===== Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ù‚Ù…ÙŠ Ù„Ù„Ø¹Ø±Ø¶ =====
    function formatNumericId(id) {
        if (!id) return "000000";
        
        const numId = parseInt(id);
        if (isNaN(numId)) return "000000";
        
        return numId.toString().padStart(6, '0');
    }
    
    // ===== Ø¯Ø§Ù„Ø© Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± =====
    function hideCodeInNotification(text) {
        const codeMatch = text.match(/Ø§Ù„ÙƒÙˆØ¯:\s*([A-Z0-9\-]+)/i);
        if (codeMatch && codeMatch[1]) {
            const code = codeMatch[1];
            return text.replace(/Ø§Ù„ÙƒÙˆØ¯:\s*[A-Z0-9\-]+/i, `Ø§Ù„ÙƒÙˆØ¯: <span class="code-in-notification" onclick="showCodeInNotification(this, '${code}')">Ø§Ø¶ØºØ· Ù„Ù„ÙƒØ´Ù</span>`);
        }
        return text;
    }
    
    // ===== Ø¯Ø§Ù„Ø© Ù„Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± =====
    function showCodeInNotification(element, code) {
        element.innerHTML = code;
        element.style.background = 'linear-gradient(45deg, #10b981, #059669)';
        element.style.cursor = 'default';
        
        const copyBtn = document.createElement('button');
        copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
        copyBtn.style.background = 'white';
        copyBtn.style.color = '#059669';
        copyBtn.style.border = 'none';
        copyBtn.style.borderRadius = '5px';
        copyBtn.style.padding = '3px 6px';
        copyBtn.style.marginRight = '5px';
        copyBtn.style.cursor = 'pointer';
        copyBtn.style.fontSize = '0.8rem';
        copyBtn.title = 'Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯';
        copyBtn.onclick = function(e) {
            e.stopPropagation();
            navigator.clipboard.writeText(code).then(() => {
                showFirebaseAlert('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯', 'success');
            });
        };
        
        element.insertBefore(copyBtn, element.firstChild);
        element.onclick = null;
    }

    // ===== ØªÙ‡ÙŠØ¦Ø© Firebase =====
    function initializeFirebase() {
        try {
            if (!firebase.apps.length) {
                firebaseApp = firebase.initializeApp(firebaseConfig);
            } else {
                firebaseApp = firebase.app();
            }
            
            database = firebase.database();
            auth = firebase.auth();
            
            console.log('âœ… Firebase initialized successfully');
            showFirebaseAlert('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
            
            auth.onAuthStateChanged((user) => {
                if (user) {
                    console.log('ğŸ‘¤ User logged in:', user.uid);
                    updateUI();
                    requestNotificationPermission();
                } else {
                    console.log('ğŸ‘¤ No user logged in');
                    updateUI();
                }
            });
            
        } catch (error) {
            console.error('âŒ Firebase initialization error:', error);
            showFirebaseAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase', 'error');
        }
    }

    // ===== Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ =====
    function requestNotificationPermission() {
        if ("Notification" in window && Notification.permission === "default") {
            Notification.requestPermission().then(permission => {
                console.log('Notification permission:', permission);
            });
        }
    }

    // ===== Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Firebase =====
    function showFirebaseAlert(message, type) {
        const alertDiv = document.getElementById('firebaseAlert');
        alertDiv.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${message}</span>
        `;
        alertDiv.className = `firebase-alert firebase-${type}`;
        alertDiv.style.display = 'flex';
        
        setTimeout(() => {
            alertDiv.style.display = 'none';
        }, 4000);
    }

    // ===== Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· =====
    function showDesktopNotification(title, message, type = 'info') {
        if (desktopNotificationShown) return;
        
        if (message.includes('Ø§Ù„ÙƒÙˆØ¯:')) {
            message = message.replace(/Ø§Ù„ÙƒÙˆØ¯:\s*[A-Z0-9\-]+/i, 'Ø§Ù„ÙƒÙˆØ¯: ***');
        }
        
        const notification = document.getElementById('desktopNotification');
        const titleEl = document.getElementById('notificationTitle');
        const messageEl = document.getElementById('notificationMessage');
        
        titleEl.textContent = title;
        messageEl.textContent = message;
        
        notification.className = `desktop-notification notification-${type}`;
        
        const icon = notification.querySelector('.notification-icon i');
        icon.className = type === 'success' ? 'fas fa-check-circle' : 
                        type === 'error' ? 'fas fa-exclamation-circle' : 
                        type === 'warning' ? 'fas fa-exclamation-triangle' : 'fas fa-bell';
        
        notification.style.display = 'block';
        desktopNotificationShown = true;
        
        playNotificationSound();
        
        setTimeout(() => {
            closeDesktopNotification();
        }, 5000);
    }

    // ===== Ø¥ØºÙ„Ø§Ù‚ Ø¥Ø´Ø¹Ø§Ø± Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ =====
    function closeDesktopNotification() {
        document.getElementById('desktopNotification').style.display = 'none';
        desktopNotificationShown = false;
    }

    // ===== ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± =====
    function playNotificationSound() {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
            
            if ('vibrate' in navigator) {
                navigator.vibrate([100, 50, 100]);
            }
            
        } catch (error) {
            console.log('Sound not available:', error);
        }
    }

    // ===== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¸Ø± =====
    async function checkBanStatus() {
        const currentUser = getCurrentUserFromStorage();
        if (!currentUser) return;
        
        try {
            if (!database) {
                console.log('Database not initialized');
                return;
            }
            
            const userRef = database.ref('users').orderByChild('numericId').equalTo(currentUser.numericId);
            const snapshot = await userRef.once('value');
            
            if (snapshot.exists()) {
                const users = snapshot.val();
                const userId = Object.keys(users)[0];
                const userData = users[userId];
                
                if (userData.isBanned) {
                    if(window.isBanAlerting) return;
                    window.isBanAlerting = true;
                    
                    let banDuration = "Ø¯Ø§Ø¦Ù…";
                    if (userData.banExpiry && userData.banExpiry !== 'permanent') {
                        const expiryDate = new Date(userData.banExpiry);
                        const now = new Date();
                        if (expiryDate > now) {
                            const diffMs = expiryDate - now;
                            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                            const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                            banDuration = `${diffDays} ÙŠÙˆÙ… Ùˆ ${diffHours} Ø³Ø§Ø¹Ø©`;
                        } else {
                            banDuration = "Ù…Ù†ØªÙ‡ÙŠ";
                        }
                    }
                    
                    alert(`ğŸš« ØªÙ… Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©!\n\nØ§Ù„Ø³Ø¨Ø¨: ${userData.banReason || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}\nØ§Ù„Ù…Ø¯Ø©: ${banDuration}\n\nÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ.`);
                    
                    await logout();
                }
            }
        } catch (error) {
            console.error('Error checking ban status:', error);
        }
    }

    // ===== Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firebase =====
    async function getCurrentUserFullData() {
        try {
            const currentUser = getCurrentUserFromStorage();
            if (!currentUser) return null;
            
            if (!database) {
                console.log('Database not initialized');
                return currentUser;
            }
            
            const numericId = getOrCreateNumericId();
            const userRef = database.ref('users').orderByChild('numericId').equalTo(numericId);
            const snapshot = await userRef.once('value');
            
            if (snapshot.exists()) {
                const users = snapshot.val();
                const userId = Object.keys(users)[0];
                const userData = users[userId];
                
                const mergedUser = {
                    ...currentUser,
                    ...userData,
                    numericId: numericId,
                    firebaseKey: userId,
                    id: userId
                };
                
                if (!mergedUser.numericId) {
                    mergedUser.numericId = numericId;
                }
                
                localStorage.setItem('currentUser', JSON.stringify(mergedUser));
                
                return mergedUser;
            }
            
            const newUser = await createUserInFirebase(currentUser, numericId);
            return newUser;
            
        } catch (error) {
            console.error('Error fetching user from Firebase:', error);
            return getCurrentUserFromStorage();
        }
    }

    // ===== Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase =====
    async function createUserInFirebase(localUser, numericId) {
        try {
            if (!database) return localUser;
            
            const newUserRef = database.ref('users').push();
            const firebaseKey = newUserRef.key;
            
            const userData = {
                numericId: numericId,
                username: localUser.username || `user_${numericId}`,
                nickname: localUser.nickname || localUser.username || `user_${numericId}`,
                password: localUser.password || '123456',
                email: localUser.email || '',
                phone: localUser.phone || '',
                isBanned: false,
                banReason: '',
                banExpiry: '',
                balanceEGP: localUser.balanceEGP || '0.00',
                balanceUSD: localUser.balanceUSD || '0.00',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            await newUserRef.set(userData);
            
            const mergedUser = {
                ...localUser,
                ...userData,
                firebaseKey: firebaseKey,
                id: firebaseKey
            };
            
            localStorage.setItem('currentUser', JSON.stringify(mergedUser));
            
            return mergedUser;
            
        } catch (error) {
            console.error('Error creating user in Firebase:', error);
            return localUser;
        }
    }

    // ===== Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† LocalStorage =====
    function getCurrentUserFromStorage() {
        try {
            return JSON.parse(localStorage.getItem('currentUser'));
        } catch (error) {
            return null;
        }
    }

    // ===== Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ =====
    function isLoggedIn() {
        const user = getCurrentUserFromStorage();
        return user !== null;
    }

    // ===== Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ =====
    function redirectToLogin() {
        alert("âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©");
        window.location.href = 'Login2.html';
    }
    
    // ===== Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù‚Ø¨Ù„ Ø£ÙŠ Ø¥Ø¬Ø±Ø§Ø¡ ÙŠØªØ·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ =====
    function requireLogin() {
        if (!isLoggedIn()) {
            redirectToLogin();
            return false;
        }
        return true;
    }

    // ===== Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© =====
    async function updateUI() {
        await checkBanStatus();
        
        const logged = isLoggedIn();
        document.querySelectorAll('.auth-only').forEach(el => {
            if (logged) el.classList.remove('hidden-guest');
            else el.classList.add('hidden-guest');
        });

        if (!logged) {
            document.getElementById('p_nickname').innerText = "Ø²Ø§Ø¦Ø±";
            document.getElementById('p_id').innerText = "000000";
            document.getElementById('p_egp').innerText = "0";
            document.getElementById('p_usd').innerText = "0";
            document.getElementById('notifBadge').innerText = "0";
            renderProducts();
            return;
        }

        try {
            const user = await getCurrentUserFullData();
            if (!user) return;

            document.getElementById('p_nickname').innerText = user.nickname || user.username;
            const numericId = user.numericId || getOrCreateNumericId();
            document.getElementById('p_id').innerText = formatNumericId(numericId);
            document.getElementById('p_egp').innerText = user.balanceEGP || "0";
            document.getElementById('p_usd').innerText = user.balanceUSD || "0";
            
            renderProducts();
            
            if (database && user.firebaseKey) {
                const notifRef = database.ref('users/' + user.firebaseKey + '/notifications');
                
                notifRef.on('value', (snapshot) => {
                    let notifications = [];
                    let unreadCount = 0;
                    
                    if (snapshot.exists()) {
                        const notifData = snapshot.val();
                        for (const key in notifData) {
                            const notif = notifData[key];
                            const safeText = hideCodeInNotification(notif.text || '');
                            
                            notifications.push({
                                id: notif.id || key,
                                text: safeText,
                                read: notif.read || false,
                                date: notif.date || new Date().toLocaleString('ar-EG'),
                                type: notif.type || 'general',
                                originalText: notif.text || ''
                            });
                            if (!notif.read) unreadCount++;
                        }
                        
                        notifications.sort((a, b) => {
                            const idA = parseInt(a.id) || 0;
                            const idB = parseInt(b.id) || 0;
                            return idB - idA;
                        });
                    }
                    
                    const badge = document.getElementById('notifBadge');
                    const unreadEl = document.getElementById('unreadCount');
                    
                    if (notificationTimers.badgeUpdate) {
                        clearTimeout(notificationTimers.badgeUpdate);
                    }
                    
                    notificationTimers.badgeUpdate = setTimeout(() => {
                        badge.innerText = unreadCount;
                        unreadEl.innerText = unreadCount;
                    }, 100);
                    
                    const list = document.getElementById('notifList');
                    if (notifications.length === 0) {
                        list.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div>';
                    } else {
                        list.innerHTML = '';
                        notifications.forEach(n => {
                            const div = document.createElement('div');
                            div.className = `notif-item ${!n.read ? 'unread' : ''}`;
                            div.innerHTML = `
                                <div style="flex:1;">
                                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                                        <i class="fas fa-${n.type === 'purchase_approved' ? 'check-circle' : n.type === 'purchase_rejected' ? 'times-circle' : n.type === 'deposit' ? 'money-bill-wave' : 'info-circle'}" 
                                           style="color: ${n.type === 'purchase_approved' ? '#10b981' : n.type === 'purchase_rejected' ? '#ef4444' : n.type === 'deposit' ? '#6366f1' : '#94a3b8'}; margin-top: 2px;"></i>
                                        <div style="flex: 1;">
                                            ${n.text}<br>
                                            <small style="opacity:0.6;">${n.date}</small>
                                        </div>
                                    </div>
                                </div>
                                <i class="fas fa-trash-alt delete-single-notif" onclick="deleteSingleNotif('${user.firebaseKey}', '${n.id}')" title="Ø­Ø°Ù"></i>
                            `;
                            list.appendChild(div);
                        });
                    }
                }, (error) => {
                    console.error('Notifications error:', error);
                });
            }
            
        } catch (error) {
            console.error('UI update error:', error);
            renderProducts();
        }
    }

    // ===== Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ© =====
    async function listenForRealTimeNotifications() {
        const user = await getCurrentUserFullData();
        if (!user || !database || !user.firebaseKey) return;
        
        const notifRef = database.ref('users/' + user.firebaseKey + '/notifications');
        let lastProcessedId = localStorage.getItem('lastProcessedNotificationId') || null;
        
        notifRef.orderByChild('createdAt').limitToLast(1).on('child_added', (snapshot) => {
            const newNotif = snapshot.val();
            const notifId = snapshot.key;
            
            if (lastProcessedId === notifId) return;
            
            if (newNotif && !newNotif.read) {
                localStorage.setItem('lastProcessedNotificationId', notifId);
                lastProcessedId = notifId;
                
                let safeMessage = newNotif.text;
                if (safeMessage.includes('Ø§Ù„ÙƒÙˆØ¯:')) {
                    safeMessage = safeMessage.replace(/Ø§Ù„ÙƒÙˆØ¯:\s*[A-Z0-9\-]+/i, 'Ø§Ù„ÙƒÙˆØ¯: *** (Ù…ØªØ§Ø­ ÙÙŠ Ø§Ù„Ù…Ø­ÙØ¸Ø©)');
                }
                
                if (notificationCooldown) return;
                
                notificationCooldown = true;
                
                if (newNotif.type === 'purchase_approved') {
                    showDesktopNotification('âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨Ùƒ', safeMessage, 'success');
                    showFirebaseAlert('ğŸ‰ ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨Ùƒ! Ø§Ù„ÙƒÙˆØ¯ Ù…ØªØ§Ø­ ÙÙŠ Ø§Ù„Ù…Ø­ÙØ¸Ø©', 'success');
                } else if (newNotif.type === 'purchase_rejected') {
                    showDesktopNotification('âŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨Ùƒ', safeMessage, 'error');
                    showFirebaseAlert('âš ï¸ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨Ùƒ. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„ØªÙØ§ØµÙŠÙ„', 'warning');
                } else if (newNotif.type === 'deposit') {
                    showDesktopNotification('ğŸ’° ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹', safeMessage, 'success');
                }
                
                setTimeout(() => {
                    notificationCooldown = false;
                }, 2000);
            }
        });
    }

    // ===== Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª =====
    async function deleteSingleNotif(userKey, notifId) {
        try {
            if (!database) return;
            
            const notifRef = database.ref('users/' + userKey + '/notifications');
            const snapshot = await notifRef.once('value');
            
            if (snapshot.exists()) {
                const notifData = snapshot.val();
                for (const key in notifData) {
                    const notif = notifData[key];
                    if ((notif.id && notif.id.toString() === notifId.toString()) || key === notifId) {
                        await database.ref('users/' + userKey + '/notifications/' + key).remove();
                        showFirebaseAlert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±", 'success');
                        break;
                    }
                }
            }
            
        } catch (error) {
            console.error('Delete notification error:', error);
            showFirebaseAlert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±", 'error');
        }
    }

    async function markAllRead() {
        try {
            const user = await getCurrentUserFullData();
            if (!user || !database || !user.firebaseKey) return;
            
            const notifRef = database.ref('users/' + user.firebaseKey + '/notifications');
            const snapshot = await notifRef.once('value');
            
            if (snapshot.exists()) {
                const updates = {};
                const notifData = snapshot.val();
                for (const key in notifData) {
                    updates[key + '/read'] = true;
                }
                await notifRef.update(updates);
                showFirebaseAlert("ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©", 'success');
            }
            
        } catch (error) {
            console.error('Mark all read error:', error);
        }
    }

    async function deleteAllNotifs() {
        if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§ØªØŸ")) return;
        
        try {
            const user = await getCurrentUserFullData();
            if (!user || !database || !user.firebaseKey) return;
            
            await database.ref('users/' + user.firebaseKey + '/notifications').remove();
            showFirebaseAlert("ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª", 'success');
            
        } catch (error) {
            console.error('Delete all notifications error:', error);
        }
    }

    // ===== Ø¯ÙˆØ§Ù„ Ø£Ø®Ø±Ù‰ =====
    document.getElementById('currentYear').textContent = new Date().getFullYear();

    function handleProfileClick() {
        if (!requireLogin()) return;
        openMenu('profileDropdown');
    }

    function handleSupportClick() {
        if (!requireLogin()) return;
        window.location.href = 'support1.html';
    }

    function copyText(id) {
        const text = document.getElementById(id).innerText;
        navigator.clipboard.writeText(text).then(() => { 
            showFirebaseAlert("ØªÙ… Ù†Ø³Ø®: " + text, 'success'); 
        });
    }

    function openMenu(id) {
        if (!requireLogin()) return;
        const target = document.getElementById(id);
        const isOpen = target.classList.contains('active');
        closeAll();
        if(!isOpen) {
            target.classList.add('active');
            document.getElementById('screenOverlay').style.display = 'block';
            updateUI();
        }
    }

    function closeAll() {
        document.querySelectorAll('.dropdown-overlay').forEach(m => m.classList.remove('active'));
        document.querySelectorAll('#purchaseModal, #topUpModal, #currencyModal').forEach(m => {
            m.style.display = 'none'; m.classList.remove('modal-active');
        });
        document.getElementById('screenOverlay').style.display = 'none';
        closeDesktopNotification();
    }

    function openCurrencySelection() {
        if (!requireLogin()) return;
        closeAll();
        const m = document.getElementById('currencyModal');
        m.style.display = 'flex'; m.classList.add('modal-active');
        document.getElementById('screenOverlay').style.display = 'block';
    }

    function updatePaymentMethodDisplay() {
        const method = document.getElementById('paymentMethod').value;
        const display = document.getElementById('selectedPaymentInfo');
        const nameSpan = document.getElementById('paymentMethodName');
        
        const methodNames = {
            'vodafone': 'ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´',
            'instapay': 'Ø¥Ù†Ø³ØªØ§ Ø¨Ø§ÙŠ',
            'binance': 'Binance Pay'
        };
        
        if(method && methodNames[method]) {
            nameSpan.textContent = methodNames[method];
            display.style.display = 'block';
        } else {
            display.style.display = 'none';
        }
    }

    function handleCurrencyChoice(currency) {
        if (!requireLogin()) return;
        
        selectedCurrency = currency;
        closeAll();
        const methodSelect = document.getElementById('paymentMethod');
        methodSelect.innerHTML = '';
        document.getElementById('topUpAmount').value = '';
        document.getElementById('finalRequiredAmount').innerText = '0';
        document.getElementById('calculationDisplay').style.display = 'none';
        document.getElementById('selectedPaymentInfo').style.display = 'none';
        
        if(currency === 'USD') {
            document.getElementById('topUpTitle').innerText = "Ø´Ø­Ù† Ø±ØµÙŠØ¯ (Ø¯ÙˆÙ„Ø§Ø±)";
            document.getElementById('amountLabel').innerText = "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥ÙŠØ¯Ø§Ø¹Ù‡ (USD):";
            const options = [{val: 'binance', text: 'Binance Pay'}, {val: 'vodafone', text: 'ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´'}, {val: 'instapay', text: 'Ø¥Ù†Ø³ØªØ§ Ø¨Ø§ÙŠ'}];
            options.forEach(opt => { let el = document.createElement('option'); el.value = opt.val; el.innerText = opt.text; methodSelect.appendChild(el); });
        } else {
            document.getElementById('topUpTitle').innerText = "Ø´Ø­Ù† Ø±ØµÙŠØ¯ (Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ)";
            document.getElementById('amountLabel').innerText = "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥ÙŠØ¯Ø§Ø¹Ù‡ (EGP):";
            const options = [{val: 'vodafone', text: 'ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´'}, {val: 'instapay', text: 'Ø¥Ù†Ø³ØªØ§ Ø¨Ø§ÙŠ'}];
            options.forEach(opt => { let el = document.createElement('option'); el.value = opt.val; el.innerText = opt.text; methodSelect.appendChild(el); });
        }
        updatePaymentDetails();
        updatePaymentMethodDisplay();
        document.getElementById('topUpModal').style.display = 'flex';
        document.getElementById('topUpModal').classList.add('modal-active');
        document.getElementById('screenOverlay').style.display = 'block';
    }

    function calculateRequiredAmount() {
        const amount = parseFloat(document.getElementById('topUpAmount').value) || 0;
        const method = document.getElementById('paymentMethod').value;
        const display = document.getElementById('calculationDisplay');
        const finalLabel = document.getElementById('finalRequiredAmount');
        if(amount <= 0) { display.style.display = 'none'; return; }
        display.style.display = 'block';
        if(selectedCurrency === 'USD') {
            if(method === 'binance') finalLabel.innerText = amount + " USDT";
            else finalLabel.innerText = (amount * 50) + " Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ";
        } else { finalLabel.innerText = amount + " Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ"; }
    }

    function updatePaymentDetails() {
        const method = document.getElementById('paymentMethod').value;
        const walletBox = document.getElementById('walletBox');
        const binanceDetails = document.getElementById('binanceDetails');
        const hint = document.getElementById('methodHint');
        walletBox.style.display = 'none'; binanceDetails.style.display = 'none';
        if(method === 'binance') { binanceDetails.style.display = 'block'; hint.innerText = "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Binance Pay:"; }
        else { walletBox.style.display = 'flex'; hint.innerText = "Ø­ÙˆÙ„ Ù„Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ§Ù„ÙŠ:"; document.getElementById('walletNumber').innerText = "01022797043"; }
        calculateRequiredAmount();
        updatePaymentMethodDisplay();
    }

    // ===== Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª =====
    function renderProducts() {
        const grid = document.getElementById('productsGrid');
        
        const manualProducts = [
            {
                id: 101,
                title: "Ø­Ø³Ø§Ø¨ Ø¨Ù„Ø§ÙƒØ´ÙˆØª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© #1",
                desc: "Ù…Ø´Ø­ÙˆÙ† 2710 Ø¬ÙˆÙ‡Ø±Ø©ØŒ Ø£Ø³Ù„Ø­Ø© Ø«Ø§Ø¨ØªØ©ØŒ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø­Ø²Ù… ÙƒØ§Ù…Ù„Ø© Ù…Ù…ÙŠØ²Ø© ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø¨Ø±ÙŠØ¯Ù‡ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ / ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨",
                price: 5000,
                currency: "Ø¬Ù†ÙŠÙ‡ (EGP)",
                badge: "Ø¬Ù†Ø±Ø§Ù„ (1) Ø£Ø±Ø¨Ø¹ Ù†Ø¬ÙˆÙ…",
                stock: 1,
                mainImg: "images/accounts/4stars_adel/main.webp",
                gallery: ["images/accounts/4stars_adel/1.png", "images/accounts/4stars_adel/2.png","images/accounts/4stars_adel/3.png","images/accounts/4stars_adel/4.png","images/accounts/4stars_adel/5.png","images/accounts/4stars_adel/6.png","images/accounts/4stars_adel/7.png","images/accounts/4stars_adel/8.png","images/accounts/4stars_adel/9.png","images/accounts/4stars_adel/10.png","images/accounts/4stars_adel/11.png","images/accounts/4stars_adel/12.png","images/accounts/4stars_adel/13.png","images/accounts/4stars_adel/14.png","images/accounts/4stars_adel/15.png","images/accounts/4stars_adel/16.png","images/accounts/4stars_adel/17.png","images/accounts/4stars_adel/18.png","images/accounts/4stars_adel/19.png","images/accounts/4stars_adel/20.png","images/accounts/4stars_adel/21.png","images/accounts/4stars_adel/22.png","images/accounts/4stars_adel/23.png","images/accounts/4stars_adel/24.png","images/accounts/4stars_adel/25.png","images/accounts/4stars_adel/26.png","images/accounts/4stars_adel/27.png"]
            },
            {
                id: 102,
                title: "BlackShot GLOBAL #2",
                desc: "Charged with 2710 gems, weapons, and a complete premium bundle set, email/password can be changed",
                price: 120,
                currency: "Ø¯ÙˆÙ„Ø§Ø± (USD)",
                badge: "General (1) 4Stars",
                stock: 1,
                mainImg: "images/accounts/4stars_adel/main.webp",
                gallery: ["images/accounts/4stars_adel/1.png", "images/accounts/4stars_adel/2.png","images/accounts/4stars_adel/3.png","images/accounts/4stars_adel/4.png","images/accounts/4stars_adel/5.png","images/accounts/4stars_adel/6.png","images/accounts/4stars_adel/7.png","images/accounts/4stars_adel/8.png","images/accounts/4stars_adel/9.png","images/accounts/4stars_adel/10.png","images/accounts/4stars_adel/11.png","images/accounts/4stars_adel/12.png","images/accounts/4stars_adel/13.png","images/accounts/4stars_adel/14.png","images/accounts/4stars_adel/15.png","images/accounts/4stars_adel/16.png","images/accounts/4stars_adel/17.png","images/accounts/4stars_adel/18.png","images/accounts/4stars_adel/19.png","images/accounts/4stars_adel/20.png","images/accounts/4stars_adel/21.png","images/accounts/4stars_adel/22.png","images/accounts/4stars_adel/23.png","images/accounts/4stars_adel/24.png","images/accounts/4stars_adel/25.png","images/accounts/4stars_adel/26.png","images/accounts/4stars_adel/27.png"]
            },
            {
                id: 103,
                title: "Ø­Ø³Ø§Ø¨ Ø¨Ù„Ø§ÙƒØ´ÙˆØª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© #3",
                desc: "ÙŠÙ„Ø¹Ø¨ ØªØµÙ†ÙŠÙ ÙˆØ­Ø±ÙˆØ¨ Ø§Ù„Ø¹Ø´Ø§Ø¦Ø± Ø› Ø¨Ø·Ø§Ù‚Ø© Ù‡ÙˆÙŠØ© Ù†Ø¸ÙŠÙØ© Ø› ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø› ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨",
                price: 2000,
                currency: "Ø¬Ù†ÙŠÙ‡ (EGP)",
                badge: "Ø¹Ù…ÙˆØ¯ (4)",
                stock: 1,
                mainImg: "images/accounts/leu/main.jpg",   
                gallery: ["images/accounts/leu/1.webp", "images/accounts/leu/2.webp","images/accounts/leu/3.webp","images/accounts/leu/4.webp","images/accounts/leu/5.webp","images/accounts/leu/6.webp",]

            },
            {
                id: 104,
                title: "BlackShot GLOBAL #4",
                desc: "can join competitive & clanwar, clean id, email/password can be changed",
                price: 45,
                currency: "Ø¯ÙˆÙ„Ø§Ø± (USD)",
                badge: "1St Lieutenant(4)",
                stock: 1,
                mainImg: "images/accounts/leu/main.jpg",   
                gallery: ["images/accounts/leu/1.webp", "images/accounts/leu/2.webp","images/accounts/leu/3.webp","images/accounts/leu/4.webp","images/accounts/leu/5.webp","images/accounts/leu/6.webp",]
            },
            {
                id: 105,
                title: "Ø­Ø³Ø§Ø¨ Ø¨Ù„Ø§ÙƒØ´ÙˆØª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© #5",
                desc: "ÙŠÙ„Ø¹Ø¨ ØªØµÙ†ÙŠÙ ÙˆØ­Ø±ÙˆØ¨ Ø§Ù„Ø¹Ø´Ø§Ø¦Ø± Ø› Ø¨Ø·Ø§Ù‚Ø© Ù‡ÙˆÙŠØ© Ù†Ø¸ÙŠÙØ© Ø› ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø› ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨",
                price: 150,
                currency: "Ø¬Ù†ÙŠÙ‡ (EGP)",
                badge: "Ø±Ù‚ÙŠØ¨ Ø£ÙˆÙ„ (1)",
                stock: 1,
                mainImg: "images/accounts/major/main.jpg",   
                gallery: ["images/accounts/major/1.jpg", "images/accounts/major/2.jpg",]

            },
            {
                id: 106,
                title: "BlackShot GLOBAL #6",
                desc: "can join competitive & clanwar, clean id, email/password can be changed",
                price: 5,
                currency: "Ø¯ÙˆÙ„Ø§Ø± (USD)",
                badge: "Sergeant Major(1)",
                stock: 1,
                mainImg: "images/accounts/major/main.jpg",   
                gallery: ["images/accounts/major/1.jpg", "images/accounts/major/2.jpg",]
            },
            {
                id: 107,
                title: "Ø­Ø³Ø§Ø¨ Ø¨Ù„Ø§ÙƒØ´ÙˆØª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© #7",
                desc: "ÙŠÙ„Ø¹Ø¨ ØªØµÙ†ÙŠÙ ÙˆØ­Ø±ÙˆØ¨ Ø§Ù„Ø¹Ø´Ø§Ø¦Ø± Ø› Ø¨Ø·Ø§Ù‚Ø© Ù‡ÙˆÙŠØ© Ù†Ø¸ÙŠÙØ© Ø› Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø› Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨",
                price: 800,
                currency: "Ø¬Ù†ÙŠÙ‡ (EGP)",
                badge: "Ø¹Ù…ÙˆØ¯ÙŠÙ† (1)",
                stock: 1,
                mainImg: "images/accounts/cap/main.jpg",   
                gallery: ["images/accounts/cap/1.jpg", "images/accounts/cap/2.jpg","images/accounts/cap/3.jpg","images/accounts/cap/4.jpg","images/accounts/cap/5.jpg","images/accounts/cap/6.jpg","images/accounts/cap/7.jpg","images/accounts/cap/8.jpg","images/accounts/cap/9.jpg","images/accounts/cap/10.jpg",]

            },
            {
                id: 108,
                title: "BlackShot GLOBAL #8",
                desc: "can join competitive & clanwar, clean id, email/password cannot be changed",
                price: 21,
                currency: "Ø¯ÙˆÙ„Ø§Ø± (USD)",
                badge: "Sergeant Major(1)",
                stock: 1,
               mainImg: "images/accounts/cap/main.jpg",   
                gallery: ["images/accounts/cap/1.jpg", "images/accounts/cap/2.jpg","images/accounts/cap/3.jpg","images/accounts/cap/4.jpg","images/accounts/cap/5.jpg","images/accounts/cap/6.jpg","images/accounts/cap/7.jpg","images/accounts/cap/8.jpg","images/accounts/cap/9.jpg","images/accounts/cap/10.jpg",]
            },
            {
                id: 109,
                title: "Ø­Ø³Ø§Ø¨ Ø¨Ù„Ø§ÙƒØ´ÙˆØª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© #9",
                desc: "ÙŠÙ„Ø¹Ø¨ ØªØµÙ†ÙŠÙ ÙˆØ­Ø±ÙˆØ¨ Ø§Ù„Ø¹Ø´Ø§Ø¦Ø± Ø› Ø¨Ø·Ø§Ù‚Ø© Ù‡ÙˆÙŠØ© Ù†Ø¸ÙŠÙØ© Ø› ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø› ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨",
                price: 600,
                currency: "Ø¬Ù†ÙŠÙ‡ (EGP)",
                badge: "Ø¹Ù…ÙˆØ¯ (5)",
                stock: 1,
                mainImg: "images/accounts/leu1/main.jpg",   
                gallery: ["images/accounts/leu1/1.jpg", "images/accounts/leu1/2.jpg","images/accounts/leu1/3.jpg","images/accounts/leu1/4.jpg","images/accounts/leu1/5.jpg","images/accounts/leu1/6.jpg","images/accounts/leu1/7.jpg",]

            },
            {
                id: 1010,
                title: "BlackShot GLOBAL #10",
                desc: "can join competitive & clanwar, clean id, email/password can be changed",
                price: 21,
                currency: "Ø¯ÙˆÙ„Ø§Ø± (USD)",
                badge: "2nd Lieutenant(5)",
                stock: 1,
                mainImg: "images/accounts/leu1/main.jpg",   
                gallery: ["images/accounts/leu1/1.jpg", "images/accounts/leu1/2.jpg","images/accounts/leu1/3.jpg","images/accounts/leu1/4.jpg","images/accounts/leu1/5.jpg","images/accounts/leu1/6.jpg","images/accounts/leu1/7.jpg",]
            },
            
        ];

        const adminProducts = JSON.parse(localStorage.getItem('store_products')) || [];
        const allProducts = [...manualProducts, ...adminProducts];
        
        if (allProducts.length === 0) {
            grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 50px; color: var(--text-dim);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¹Ø±ÙˆØ¶Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`; 
            return;
        }

        grid.innerHTML = allProducts.map((p, index) => {
            if (!p.id) p.id = index;
            const galleryData = encodeURIComponent(JSON.stringify(p.gallery || []));
            let currencyLabel = (p.currency === 'Ø¯ÙˆÙ„Ø§Ø± (USD)' || p.currency === '$') ? 'Ø¯ÙˆÙ„Ø§Ø± (USD)' : 'Ø¬Ù†ÙŠÙ‡ (EGP)';
            const stockText = (p.stock > 0) ? `Ù…ØªÙˆÙØ±: ${p.stock}` : "Ù†ÙØ°Øª Ø§Ù„ÙƒÙ…ÙŠØ©";
            const stockClass = (p.stock > 0) ? 'available' : 'soldout';

            return `
                <div class="product-card" data-product-id="${p.id}">
                    <span class="account-badge">${p.badge}</span>
                    <span class="stock-indicator ${stockClass}">${stockText}</span>
                    <img src="${p.mainImg}" class="game-img" onclick="openGallery('${p.mainImg}', '${galleryData}')" title="Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ±">
                    <h3>${p.title}</h3>
                    <p class="desc">${p.desc}</p>
                    <div class="price-tag">${p.price} ${currencyLabel}</div>
                    <button class="action-btn btn-primary" 
                        ${p.stock <= 0 ? 'disabled style="background:gray; cursor:not-allowed;"' : ''} 
                        onclick="handlePurchaseClick('${p.title}', ${p.price}, '${p.currency}', ${p.id})">
                        ${p.stock > 0 ? 'Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†' : 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}
                    </button>
                </div>
            `;
        }).join('');
    }

    // ===== Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ =====
    function handlePurchaseClick(name, price, currency, productId) {
        if (!requireLogin()) return; // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        openPurchase(name, price, currency, productId);
    }

    // ===== Ø¯Ø§Ù„Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ =====
    function openPurchase(name, price, currency, productId) {
        if (!requireLogin()) return;
        
        activeProduct = { name, price, currency, id: productId };
        currentProductId = productId; 
        const user = getCurrentUserFromStorage();
        const isUSD = (currency === 'Ø¯ÙˆÙ„Ø§Ø± (USD)' || currency === '$');
        const userBalance = isUSD ? (user.balanceUSD || 0) : (user.balanceEGP || 0);
        const currencySymbol = isUSD ? 'USD' : 'EGP';
        
        if (userBalance < price) {
            alert(`âš ï¸ Ø±ØµÙŠØ¯Ùƒ Ù…Ù† Ø§Ù„Ù€ (${currencySymbol}) ØºÙŠØ± ÙƒØ§ÙÙ.\nØ§Ù„Ù…Ø·Ù„ÙˆØ¨: ${price}\nØ±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${userBalance}`);
            closeAll();
            openCurrencySelection();
            return;
        }
        
        document.getElementById('m_info').innerHTML = `Ø§Ù„Ø­Ø³Ø§Ø¨: <b>${name}</b><br>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: <b>${price} ${currencySymbol}</b><br>Ø³ÙŠØªÙ… Ø§Ù„Ø®ØµÙ… Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ù€ <b>${isUSD ? 'Ø¯ÙˆÙ„Ø§Ø±ÙŠ' : 'Ù…ØµØ±ÙŠ'}</b>`;
        document.getElementById('confirmPurchaseBtn').onclick = confirmPurchase;
        document.getElementById('purchaseModal').style.display = 'flex';
        document.getElementById('purchaseModal').classList.add('modal-active');
        document.getElementById('screenOverlay').style.display = 'block';
    }

    async function confirmPurchase() {
        if (!requireLogin()) return;
        
        // Ù…Ù†Ø¹ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©
        if (isProcessingPurchase) {
            showFirebaseAlert("â³ Ø¬Ø§Ø±Ù Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø³Ø§Ø¨Ù‚ØŒ Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...", 'warning');
            return;
        }
        
        isProcessingPurchase = true;
        const purchaseBtn = document.getElementById('confirmPurchaseBtn');
        const originalText = purchaseBtn.innerHTML;
        purchaseBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
        purchaseBtn.disabled = true;
        
        try {
            const user = await getCurrentUserFullData();
            if (!user) {
                redirectToLogin();
                return;
            }
            
            const price = activeProduct.price;
            const isUSD = (activeProduct.currency === 'Ø¯ÙˆÙ„Ø§Ø± (USD)' || activeProduct.currency === '$');
            const productId = activeProduct.id;
            
            const userBalance = isUSD ? (user.balanceUSD || 0) : (user.balanceEGP || 0);
            
            if (userBalance < price) {
                alert(`Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ. ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ${price} ${isUSD ? 'USD' : 'EGP'}`);
                openCurrencySelection();
                return;
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙÙŠ Firebase
            const newBalance = isUSD ? parseFloat(userBalance) - price : parseFloat(userBalance) - price;
            
            await database.ref('users/' + user.firebaseKey).update({
                [isUSD ? 'balanceUSD' : 'balanceEGP']: newBalance,
                updatedAt: new Date().toISOString()
            });
            
            const trxId = "Charg-" + Math.floor(Math.random() * 10000);
            const orderData = {
                orderId: trxId,
                userId: user.numericId,
                username: user.username,
                nickname: user.nickname || user.username,
                product: activeProduct.name,
                productId: productId,
                price: price + (isUSD ? " USD" : " EGP"),
                status: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
                type: 'purchase',
                createdAt: new Date().toISOString(),
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            await database.ref('orders').push(orderData);
            
            const notification = {
                id: Date.now(),
                text: `âœ… ØªÙ… Ø·Ù„Ø¨ ${activeProduct.name}. ØªÙ… Ø®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯. Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${trxId} Ø¨Ø±Ø¬Ø§Ø¡ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¯Ø±Ø¯Ø´Ø© Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø£Ùˆ Ù‚Ù… Ø¨Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„ Ø› ÙˆØ³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ`,
                read: false,
                date: new Date().toLocaleString('ar-EG'),
                type: 'purchase',
                createdAt: new Date().toISOString()
            };
            
            await database.ref('users/' + user.firebaseKey + '/notifications').push(notification);
            
            showFirebaseAlert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!", 'success');
            closeAll();
            await updateUI();
            
        } catch (error) {
            console.error('Purchase error:', error);
            showFirebaseAlert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", 'error');
        } finally {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø²Ø±
            isProcessingPurchase = false;
            purchaseBtn.innerHTML = originalText;
            purchaseBtn.disabled = false;
        }
    }

    // ===== Ø¯ÙˆØ§Ù„ Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± =====
    function openGallery(mainImg, galleryJson) {
        try {
            const extraImgs = JSON.parse(decodeURIComponent(galleryJson));
            currentGallery = [mainImg, ...extraImgs];
        } catch (e) {
            currentGallery = [mainImg];
        }
        currentImageIndex = 0;
        showCurrentImage();
        document.getElementById('galleryOverlay').style.display = 'flex';
        document.getElementById('screenOverlay').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function showCurrentImage() {
        const mainImg = document.getElementById('galleryMainImg');
        const counter = document.getElementById('galleryCounter');
        mainImg.src = currentGallery[currentImageIndex];
        counter.textContent = `ØµÙˆØ±Ø© ${currentImageIndex + 1} Ù…Ù† ${currentGallery.length}`;
        renderThumbnails();
        updateNavButtons();
    }

    function renderThumbnails() {
        const container = document.getElementById('thumbnailsContainer');
        container.innerHTML = '';
        currentGallery.forEach((imgSrc, index) => {
            const thumb = document.createElement('img');
            thumb.src = imgSrc;
            thumb.className = `thumbnail ${index === currentImageIndex ? 'active' : ''}`;
            thumb.onclick = () => selectThumbnail(index);
            thumb.alt = `ØµÙˆØ±Ø© ${index + 1}`;
            thumb.loading = 'lazy';
            container.appendChild(thumb);
        });
        const activeThumb = container.querySelector('.thumbnail.active');
        if (activeThumb) {
            activeThumb.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }

    function selectThumbnail(index) {
        currentImageIndex = index;
        showCurrentImage();
    }

    function changeImage(direction) {
        currentImageIndex += direction;
        if (currentImageIndex >= currentGallery.length) {
            currentImageIndex = 0;
        } else if (currentImageIndex < 0) {
            currentImageIndex = currentGallery.length - 1;
        }
        showCurrentImage();
    }

    function updateNavButtons() {
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        prevBtn.style.opacity = currentImageIndex === 0 ? '0.5' : '1';
        nextBtn.style.opacity = currentImageIndex === currentGallery.length - 1 ? '0.5' : '1';
    }

    function closeGallery(event) {
        document.getElementById('galleryOverlay').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('galleryOverlay').style.display === 'flex') {
            closeGallery();
        }
    });

    // ===== Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù† =====
    async function submitTopUp() {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„
        if (!requireLogin()) return;
        
        // Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ØªÙƒØ±Ø±
        if (isSubmittingTopUp) {
            showFirebaseAlert("â³ Ø¬Ø§Ø±Ù Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø³Ø§Ø¨Ù‚ØŒ Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...", 'warning');
            return;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const amount = document.getElementById('topUpAmount').value;
        const paymentMethod = document.getElementById('paymentMethod').value;
        const fileInput = document.getElementById('topUpReceipt');
        
        if (!amount || amount <= 0) {
            showFirebaseAlert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºØ§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹", 'error');
            return;
        }
        
        if (!paymentMethod) {
            showFirebaseAlert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹", 'error');
            return;
        }
        
        if (fileInput.files.length === 0) {
            showFirebaseAlert("ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„", 'error');
            return;
        }
        
        // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ù„Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø±Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
        isSubmittingTopUp = true;
        const submitBtn = document.getElementById('submitTopUpBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
        submitBtn.disabled = true;
        
        try {
            const user = await getCurrentUserFullData();
            if (!user) {
                showFirebaseAlert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹", 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const generatedId = "DEP-" + Date.now();
                    
                    const methodNames = {
                        'vodafone': 'ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´',
                        'instapay': 'Ø¥Ù†Ø³ØªØ§ Ø¨Ø§ÙŠ',
                        'binance': 'Binance Pay'
                    };
                    const methodName = methodNames[paymentMethod] || paymentMethod;
                    
                    const orderData = {
                        orderId: generatedId,
                        userId: user.numericId,
                        username: user.username,
                        nickname: user.nickname || user.username,
                        product: `Ø¥ÙŠØ¯Ø§Ø¹ ${selectedCurrency} Ø¹Ø¨Ø± ${methodName}`,
                        price: `${amount} ${selectedCurrency}`,
                        paymentMethod: paymentMethod,
                        method: methodName,
                        currency: selectedCurrency,
                        receipt: e.target.result,
                        status: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
                        type: 'deposit',
                        createdAt: new Date().toISOString(),
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    await database.ref('orders').push(orderData);
                    
                    const notification = {
                        id: Date.now(),
                        text: `â³ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø¹Ø¨Ø± ${methodName}. Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨: ${generatedId}. Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø­ÙŠÙ† Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.`,
                        read: false,
                        date: new Date().toLocaleString('ar-EG'),
                        type: 'deposit',
                        createdAt: new Date().toISOString()
                    };
                    
                    await database.ref('users/' + user.firebaseKey + '/notifications').push(notification);
                    
                    showFirebaseAlert(`âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù† Ø¹Ø¨Ø± ${methodName} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                    closeAll();
                    await updateUI();
                    
                } catch (error) {
                    console.error('Top-up processing error:', error);
                    showFirebaseAlert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨", 'error');
                } finally {
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                    isSubmittingTopUp = false;
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            };
            
            reader.onerror = function() {
                showFirebaseAlert("âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙŠØµØ§Ù„", 'error');
                isSubmittingTopUp = false;
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            };
            
            reader.readAsDataURL(fileInput.files[0]);
            
        } catch (error) {
            console.error('Top-up error:', error);
            showFirebaseAlert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨", 'error');
            isSubmittingTopUp = false;
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    // ===== Ø¯ÙˆØ§Ù„ Ø¯Ø¹Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© =====
    async function prepareForWallet() {
        try {
            if (!requireLogin()) return false;
            
            const user = await getCurrentUserFullData();
            if (!user) {
                alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
                redirectToLogin();
                return false;
            }
            
            const walletData = {
                id: user.numericId || user.id,
                nickname: user.nickname || user.username,
                balanceEGP: user.balanceEGP || "0",
                balanceUSD: user.balanceUSD || "0",
                numericId: user.numericId,
                username: user.username,
                email: user.email || '',
                phone: user.phone || '',
                firebaseKey: user.firebaseKey,
                purchasedCards: user.purchasedCards || []
            };
            
            localStorage.setItem('walletUserData', JSON.stringify(walletData));
            
            const walletSession = {
                timestamp: Date.now(),
                userId: user.numericId,
                sessionId: 'wallet_' + Date.now()
            };
            localStorage.setItem('walletSession', JSON.stringify(walletSession));
            
            console.log('âœ… ØªÙ… ØªØ­Ø¶ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:', user.nickname);
            showFirebaseAlert('âœ… ØªÙ… ØªØ­Ø¶ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø©', 'success');
            
            return true;
            
        } catch (error) {
            console.error('Error preparing wallet data:', error);
            showFirebaseAlert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¶ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø©', 'error');
            return false;
        }
    }

    function refreshData() {
        if (!requireLogin()) return;
        
        const icon = document.getElementById('refreshIcon');
        icon.classList.add('refreshing');
        setTimeout(() => {
            updateUI();
            icon.classList.remove('refreshing');
        }, 1000);
    }

    // ===== Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ =====
    async function logout() {
        try {
            if (auth) {
                await auth.signOut();
            }
            
            localStorage.removeItem('currentUser');
            window.location.reload();
            
        } catch (error) {
            console.error('Logout error:', error);
            localStorage.removeItem('currentUser');
            window.location.reload();
        }
    }

    // ===== Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø¨Ø§Ù†ØªØ¸Ø§Ù… =====
    async function refreshWalletData() {
        try {
            const user = await getCurrentUserFullData();
            if (!user) return false;
            
            const walletData = {
                id: user.numericId || user.id,
                nickname: user.nickname || user.username,
                balanceEGP: user.balanceEGP || "0",
                balanceUSD: user.balanceUSD || "0",
                numericId: user.numericId,
                username: user.username,
                email: user.email || '',
                phone: user.phone || '',
                firebaseKey: user.firebaseKey,
                purchasedCards: user.purchasedCards || []
            };
            
            localStorage.setItem('walletUserData', JSON.stringify(walletData));
            
            const walletSession = {
                timestamp: Date.now(),
                userId: user.numericId,
                sessionId: 'wallet_' + Date.now()
            };
            localStorage.setItem('walletSession', JSON.stringify(walletSession));
            
            console.log('ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø©');
            return true;
            
        } catch (error) {
            console.error('Error refreshing wallet data:', error);
            return false;
        }
    }

    // ===== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© =====
    window.onload = async function() {
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        localStorage.removeItem('store_products');
        
        renderProducts();
        initializeFirebase();
        await updateUI();
        
        setTimeout(async () => {
            await refreshWalletData();
        }, 1000);
        
        setInterval(async () => {
            await refreshWalletData();
        }, 60000);
        
        setTimeout(async () => {
            await listenForRealTimeNotifications();
        }, 2000);
        
        setInterval(checkBanStatus, 30000);
    };
</script>
</body>
</html>









